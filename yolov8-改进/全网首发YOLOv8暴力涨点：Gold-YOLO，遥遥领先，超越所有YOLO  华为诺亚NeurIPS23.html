<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <p>&nbsp;💡💡💡<span style="color:#fe2c24;"><strong>本文独家改进：</strong></span>提出了全新的<span style="color:#fe2c24;"><strong>信息聚集-分发（Gather-and-Distribute Mechanism）GD机制，Gold-YOLO，</strong></span>替换yolov8 head部分 实现暴力涨点</p> 
<p><span style="color:#fe2c24;"><strong>Gold-YOLO</strong></span><strong> |&nbsp; &nbsp;亲测在多个数据集能够实现大幅涨点</strong></p> 
<p>💡💡💡Yolov8魔术师，独家首发创新（原创），适用于<a href="https://so.csdn.net/so/search?q=Yolov5&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=Yolov5&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;Yolov5\&quot;}&quot;}" data-tit="Yolov5" data-pretit="yolov5">Yolov5</a>、Yolov7、Yolov8等各个Yolo系列，专栏文章提供每一步步骤和源码，轻松带你上手魔改网络</p> 
<p>💡💡💡重点：通过本专栏的阅读，后续你也可以自己魔改网络，在网络不同位置（Backbone、head、detect、loss等）进行魔改，实现创新！！！</p> 
<p><strong>专栏介绍：</strong></p> 
<p><a href="https://blog.csdn.net/m0_63774211/category_12289773.html" title="https://blog.csdn.net/m0_63774211/category_12289773.html">https://blog.csdn.net/m0_63774211/category_12289773.html</a></p> 
<p>✨✨✨原创魔改网络、复现前沿论文，组合优化创新</p> 
<p>🚀🚀🚀小目标、遮挡物、难样本性能提升</p> 
<p>🍉🍉🍉持续更新中，定期更新不同数据集涨点情况</p> 
<h2><a name="t0"></a>1.Gold-YOLO</h2> 
<p><img alt="" height="445" src="https://img-blog.csdnimg.cn/d575f4ac5fc04c60830f2079a1db3752.png" width="1078"></p> 
<p>链接：<a href="https://arxiv.org/pdf/2309.11331.pdf" title="https://arxiv.org/pdf/2309.11331.pdf">https://arxiv.org/pdf/2309.11331.pdf</a>&nbsp;</p> 
<p>代码：<a href="https://github.com/huawei-noah/Efficient-Computing/tree/master/Detection/Gold-YOLO" title="https://github.com/huawei-noah/Efficient-Computing/tree/master/Detection/Gold-YOLO">https://github.com/huawei-noah/Efficient-Computing/tree/master/Detection/Gold-YOLO</a></p> 
<p>单位：华为诺亚方舟实验室&nbsp;</p> 
<p>理论部分可参考：<a href="https://zhuanlan.zhihu.com/p/657669695?utm_id=0" title="超越YOLO系列！华为提出Gold-YOLO：高效实时目标检测器 - 知乎">超越YOLO系列！华为提出Gold-YOLO：高效实时目标检测器 - 知乎</a>&nbsp;</p> 
<p><span style="color:#fe2c24;"><strong>传统YOLO的问题</strong></span></p> 
<p>在检测模型中，通常先经过backbone提取得到一系列不同层级的特征，FPN利用了backbone的这一特点，构建了相应的融合结构：不层级的特征包含着不同大小物体的位置信息，虽然这些特征包含的信息不同，但这些特征在相互融合后能够互相弥补彼此缺失的信息，增强每一层级信息的丰富程度，提升网络性能。</p> 
<p>原始的FPN结构由于其层层递进的信息融合模式，使得相邻层的信息能够充分融合，但也导致了跨层信息融合存在问题：当跨层的信息进行交互融合时，由于没有直连的交互通路，只能依靠中间层充当“中介”进行融合，导致了一定的信息损失。之前的许多工作中都关注到了这一问题，而解决方案通常是通过添加shortcut增加更多的路径，以增强信息流动。</p> 
<p><img alt="" height="411" src="https://img-blog.csdnimg.cn/b102e8999f8349e9b8369d4c1a810b2f.png" width="917"></p> 
<p><span style="color:#fe2c24;"><strong>摘要：当前YOLO系列模型通常采用类FPN方法进行信息融合，而这一结构在融合跨层信息时存在信息损失的问题。</strong></span>针对这一问题，我们提出了全新的信息聚集-分发（Gather-and-Distribute Mechanism）<a href="https://so.csdn.net/so/search?q=GD&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=GD&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;GD\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=GD&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;GD\&quot;}&quot;}" data-tit="GD" data-pretit="gd">GD</a>机制，通过在全局视野上对不同层级的特征进行统一的聚集融合并分发注入到不同层级中，构建更加充分高效的信息交互融合机制，并基于GD机制构建了Gold-YOLO。在COCO数据集中，我们的Gold-YOLO超越了现有的YOLO系列，实现了精度-速度曲线上的SOTA。</p> 
<p>&nbsp;<img alt="" height="610" src="https://img-blog.csdnimg.cn/0d1457bbb6664eb7a01a05e42e40f168.png" width="1173"></p> 
<p>提出了一种全新的信息交互融合机制：<span style="color:#fe2c24;"><strong>信息聚集-分发机制(Gather-and-Distribute Mechanism)</strong></span>。该机制通过在全局上融合不同层次的特征得到全局信息，并将全局信息注入到不同层级的特征中，实现了高效的信息交互和融合。在不显著增加延迟的情况下GD机制显著增强了Neck部分的信息融合能力，提高了模型对不同大小物体的检测能力。&nbsp;</p> 
<p><img alt="" height="475" src="https://img-blog.csdnimg.cn/03977562ef6f4706ad57f02ebd140402.png" width="1159"></p> 
<p>&nbsp;在Gold-YOLO中，针对模型需要检测不同大小的物体的需要，并权衡精度和速度，我们构建了两个GD分支对信息进行融合：低层级信息聚集-分发分支(Low-GD)和高层级信息聚集-分发分支(High-GD)，分别基于卷积和transformer提取和融合特征信息。</p> 
<p><img alt="" height="422" src="https://img-blog.csdnimg.cn/eb9f304736a046a68ae349ee59939000.png" width="1200"></p> 
<p>&nbsp;实验结果：</p> 
<p><img alt="" height="723" src="https://img-blog.csdnimg.cn/041d190258ac4847adafcf77ab96908b.png" width="873">&nbsp;同时我们针对Gold-YOLO中不同分支和结构对模型精度和速度的影响，进行了相应的消融实验。</p> 
<p><img alt="" height="217" src="https://img-blog.csdnimg.cn/4e7a7211279a40f096809b2714a1e891.png" width="862"></p> 
<h2><a name="t1"></a>2.gold-yolo引入到yolov8</h2> 
<h3><a name="t2"></a>2.1新建 gold-yolo加入ultralytics/nn/head/goldyolo.py</h3> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln hundred" style="width:1066px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">###################### gold-yolo  ####     STRAT   <span class="hljs-keyword">by</span>  AI<span class="hljs-operator">&amp;</span>CV  ###############################</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#gold-yolo Gather-and-Distribute Mechanism</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>github.com<span class="hljs-operator">/</span>huawei-noah<span class="hljs-operator">/</span>Efficient-Computing<span class="hljs-operator">/</span>tree<span class="hljs-operator">/</span>master<span class="hljs-operator">/</span>Detection<span class="hljs-operator">/</span>Gold-YOLO</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn <span class="hljs-keyword">as</span> nn</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn.functional <span class="hljs-keyword">as</span> F</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import math</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import numpy <span class="hljs-keyword">as</span> np</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def autopad(k, p<span class="hljs-operator">=</span>None, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>):  # kernel, padding, dilation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Pad <span class="hljs-keyword">to</span> <span class="hljs-string">'same'</span> shape outputs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> d <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k <span class="hljs-operator">=</span> d <span class="hljs-operator">*</span> (k<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [d <span class="hljs-operator">*</span> (x<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # actual kernel-size</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> p <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p <span class="hljs-operator">=</span> k <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [x <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # auto-pad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> p</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Conv(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Standard</span> convolution <span class="hljs-keyword">with</span> args(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_out, kernel, stride, padding, groups, dilation, activation)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">default</span>_act <span class="hljs-operator">=</span> nn.SiLU()  # <span class="hljs-keyword">default</span> activation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k<span class="hljs-operator">=</span><span class="hljs-number">1</span>, s<span class="hljs-operator">=</span><span class="hljs-number">1</span>, p<span class="hljs-operator">=</span>None, g<span class="hljs-operator">=</span><span class="hljs-number">1</span>, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k, s, autopad(k, p, d), groups<span class="hljs-operator">=</span>g, dilation<span class="hljs-operator">=</span>d, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.bn <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(c<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">default</span>_act <span class="hljs-keyword">if</span> act <span class="hljs-keyword">is</span> <span class="hljs-keyword">True</span> <span class="hljs-keyword">else</span> act <span class="hljs-keyword">if</span> isinstance(act, nn.Module) <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.bn(<span class="hljs-keyword">self</span>.conv(x)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward_fuse(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.conv(x))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def conv_bn(<span class="hljs-keyword">in</span>_channels, out_channels, kernel_<span class="hljs-keyword">size</span>, stride, padding, groups<span class="hljs-operator">=</span><span class="hljs-number">1</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">''</span><span class="hljs-string">'Basic cell for rep-style block, including conv and bn'</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    result <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    result.<span class="hljs-keyword">add</span>_module(<span class="hljs-string">'conv'</span>, nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels, out_channels<span class="hljs-operator">=</span>out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                        kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>kernel_<span class="hljs-keyword">size</span>, stride<span class="hljs-operator">=</span>stride, padding<span class="hljs-operator">=</span>padding, groups<span class="hljs-operator">=</span>groups,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                        bias<span class="hljs-operator">=</span>bias))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    result.<span class="hljs-keyword">add</span>_module(<span class="hljs-string">'bn'</span>, nn.BatchNorm<span class="hljs-number">2</span>d(num_features<span class="hljs-operator">=</span>out_channels))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> result</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RepVGGBlock(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">''</span><span class="hljs-string"><span class="hljs-string">'RepVGGBlock is a basic rep-style block, including training and deploy status</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    This code is based on https://github.com/DingXiaoH/RepVGG/blob/main/repvgg.py</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    '</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">in</span>_channels, out_channels, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">3</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, padding<span class="hljs-operator">=</span><span class="hljs-number">1</span>, dilation<span class="hljs-operator">=</span><span class="hljs-number">1</span>, groups<span class="hljs-operator">=</span><span class="hljs-number">1</span>, padding_<span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'zeros'</span>, deploy<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, <span class="hljs-keyword">use</span>_se<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(RepVGGBlock, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">" Initialization of the class.</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            in_channels (int): Number of channels in the input image</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            out_channels (int): Number of channels produced by the convolution</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            kernel_size (int or tuple): Size of the convolving kernel</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            stride (int or tuple, optional): Stride of the convolution. Default: 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            padding (int or tuple, optional): Zero-padding added to both sides of</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">                the input. Default: 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            dilation (int or tuple, optional): Spacing between kernel elements. Default: 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            groups (int, optional): Number of blocked connections from input</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">                channels to output channels. Default: 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            padding_mode (string, optional): Default: 'zeros'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            deploy: Whether to be deploy status or training status. Default: False</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            use_se: Whether to use se. Default: False</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.deploy <span class="hljs-operator">=</span> deploy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.groups <span class="hljs-operator">=</span> groups</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels <span class="hljs-operator">=</span> <span class="hljs-keyword">in</span>_channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.out_channels <span class="hljs-operator">=</span> out_channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert padding <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        padding_<span class="hljs-number">11</span> <span class="hljs-operator">=</span> padding<span class="hljs-operator"> - </span>kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.nonlinearity <span class="hljs-operator">=</span> nn.ReLU()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">use</span>_se:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">"se block not supported yet"</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.se <span class="hljs-operator">=</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> deploy:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_reparam <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels, out_channels<span class="hljs-operator">=</span>out_channels, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         padding<span class="hljs-operator">=</span>padding, dilation<span class="hljs-operator">=</span>dilation, groups<span class="hljs-operator">=</span>groups, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         padding_<span class="hljs-keyword">mode</span><span class="hljs-operator">=</span>padding_<span class="hljs-keyword">mode</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_identity <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                num_features<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels) <span class="hljs-keyword">if</span> out_channels <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-keyword">in</span>_channels <span class="hljs-keyword">and</span> stride <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_dense <span class="hljs-operator">=</span> conv_bn(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels, out_channels<span class="hljs-operator">=</span>out_channels, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     stride<span class="hljs-operator">=</span>stride, padding<span class="hljs-operator">=</span>padding, groups<span class="hljs-operator">=</span>groups)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> conv_bn(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels, out_channels<span class="hljs-operator">=</span>out_channels, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>, stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                   padding<span class="hljs-operator">=</span>padding_<span class="hljs-number">11</span>, groups<span class="hljs-operator">=</span>groups)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, inputs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-string">''</span><span class="hljs-string">'Forward process'</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'rbr_reparam'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.nonlinearity(<span class="hljs-keyword">self</span>.se(<span class="hljs-keyword">self</span>.rbr_reparam(inputs)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.rbr_identity <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            id_out <span class="hljs-operator">=</span> <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            id_out <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.rbr_identity(inputs)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.nonlinearity(<span class="hljs-keyword">self</span>.se(<span class="hljs-keyword">self</span>.rbr_dense(inputs) <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.rbr_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>(inputs) <span class="hljs-operator">+</span> id_out))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def <span class="hljs-keyword">get</span>_equivalent_kernel_bias(<span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span>, bias<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(<span class="hljs-keyword">self</span>.rbr_dense)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>, bias<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(<span class="hljs-keyword">self</span>.rbr_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernelid, biasid <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(<span class="hljs-keyword">self</span>.rbr_identity)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>._pad_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>_<span class="hljs-keyword">to</span>_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_tensor(kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>) <span class="hljs-operator">+</span> kernelid, bias<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">+</span> bias<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> biasid</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _pad_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>_<span class="hljs-keyword">to</span>_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_tensor(<span class="hljs-keyword">self</span>, kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> torch.nn.functional.pad(kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _fuse_bn_tensor(<span class="hljs-keyword">self</span>, branch):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> branch <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> isinstance(branch, nn.<span class="hljs-keyword">Sequential</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel <span class="hljs-operator">=</span> branch.conv.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_mean <span class="hljs-operator">=</span> branch.bn.running_mean</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_var <span class="hljs-operator">=</span> branch.bn.running_var</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            gamma <span class="hljs-operator">=</span> branch.bn.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            beta <span class="hljs-operator">=</span> branch.bn.bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            eps <span class="hljs-operator">=</span> branch.bn.eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert isinstance(branch, nn.BatchNorm<span class="hljs-number">2</span>d)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'id_tensor'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">input</span>_dim <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.groups</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                kernel_<span class="hljs-keyword">value</span> <span class="hljs-operator">=</span> np.<span class="hljs-literal">zeros</span>((<span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels, <span class="hljs-keyword">input</span>_dim, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>), dtype<span class="hljs-operator">=</span>np.float<span class="hljs-number">32</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    kernel_<span class="hljs-keyword">value</span>[i, i % <span class="hljs-keyword">input</span>_dim, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>] <span class="hljs-operator">=</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">self</span>.id_tensor <span class="hljs-operator">=</span> torch.<span class="hljs-keyword">from</span>_numpy(kernel_<span class="hljs-keyword">value</span>).<span class="hljs-keyword">to</span>(branch.weight.device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.id_tensor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_mean <span class="hljs-operator">=</span> branch.running_mean</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_var <span class="hljs-operator">=</span> branch.running_var</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            gamma <span class="hljs-operator">=</span> branch.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            beta <span class="hljs-operator">=</span> branch.bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            eps <span class="hljs-operator">=</span> branch.eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        std <span class="hljs-operator">=</span> (running_var <span class="hljs-operator">+</span> eps).sqrt()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        t <span class="hljs-operator">=</span> (gamma <span class="hljs-operator">/</span> std).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> kernel <span class="hljs-operator">*</span> t, beta<span class="hljs-operator"> - </span>running_mean <span class="hljs-operator">*</span> gamma <span class="hljs-operator">/</span> std</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def switch_<span class="hljs-keyword">to</span>_deploy(<span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'rbr_reparam'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel, bias <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">get</span>_equivalent_kernel_bias()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.rbr_reparam <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.<span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     out_channels<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.kernel_<span class="hljs-keyword">size</span>, stride<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     padding<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.padding, dilation<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.dilation,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     groups<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.groups, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.rbr_reparam.weight.<span class="hljs-keyword">data</span> <span class="hljs-operator">=</span> kernel</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.rbr_reparam.bias.<span class="hljs-keyword">data</span> <span class="hljs-operator">=</span> bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.parameters():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            para.detach_()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'rbr_dense'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'rbr_1x1'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'rbr_identity'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'rbr_identity'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'id_tensor'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'id_tensor'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.deploy <span class="hljs-operator">=</span> <span class="hljs-keyword">True</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def onnx_AdaptiveAvgPool<span class="hljs-number">2</span>d(x, <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    stride_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> np.floor(np.array(x.shape[-<span class="hljs-number">2</span>:]) <span class="hljs-operator">/</span> <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>).astype(np.int<span class="hljs-number">32</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> np.array(x.shape[-<span class="hljs-number">2</span>:])<span class="hljs-operator"> - </span>(<span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span><span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">*</span> stride_<span class="hljs-keyword">size</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    avg <span class="hljs-operator">=</span> nn.AvgPool<span class="hljs-number">2</span>d(kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>list(kernel_<span class="hljs-keyword">size</span>), stride<span class="hljs-operator">=</span>list(stride_<span class="hljs-keyword">size</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    x <span class="hljs-operator">=</span> avg(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_avg_pool():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> torch.onnx.<span class="hljs-keyword">is</span>_<span class="hljs-keyword">in</span>_onnx_export():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        avg_pool <span class="hljs-operator">=</span> onnx_AdaptiveAvgPool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        avg_pool <span class="hljs-operator">=</span> nn.functional.adaptive_avg_pool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> avg_pool</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SimFusion_<span class="hljs-number">3</span><span class="hljs-keyword">in</span>(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">in</span>_channel_list, out_channels):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span> <span class="hljs-operator">=</span> Conv(<span class="hljs-keyword">in</span>_channel_list[<span class="hljs-number">0</span>], out_channels, act<span class="hljs-operator">=</span>nn.ReLU()) <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span>_channel_list[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                <span class="hljs-number">0</span>] !<span class="hljs-operator">=</span> out_channels <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">2</span> <span class="hljs-operator">=</span> Conv(<span class="hljs-keyword">in</span>_channel_list[<span class="hljs-number">1</span>], out_channels, act<span class="hljs-operator">=</span>nn.ReLU()) <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span>_channel_list[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                <span class="hljs-number">1</span>] !<span class="hljs-operator">=</span> out_channels <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">3</span> <span class="hljs-operator">=</span> Conv(<span class="hljs-keyword">in</span>_channel_list[<span class="hljs-number">2</span>], out_channels, act<span class="hljs-operator">=</span>nn.ReLU()) <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span>_channel_list[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                <span class="hljs-number">2</span>] !<span class="hljs-operator">=</span> out_channels <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv_fuse <span class="hljs-operator">=</span> Conv(out_channels <span class="hljs-operator">*</span> <span class="hljs-number">3</span>, out_channels, act<span class="hljs-operator">=</span>nn.ReLU())</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.downsample <span class="hljs-operator">=</span> nn.functional.adaptive_avg_pool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        N, C, H, W <span class="hljs-operator">=</span> x[<span class="hljs-number">1</span>].shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> (H, W)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> torch.onnx.<span class="hljs-keyword">is</span>_<span class="hljs-keyword">in</span>_onnx_export():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.downsample <span class="hljs-operator">=</span> onnx_AdaptiveAvgPool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> np.array([H, W])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">0</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span>(<span class="hljs-keyword">self</span>.downsample(x[<span class="hljs-number">0</span>], <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.cv<span class="hljs-number">2</span>(x[<span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.cv<span class="hljs-number">3</span>(F.interpolate(x[<span class="hljs-number">2</span>], <span class="hljs-keyword">size</span><span class="hljs-operator">=</span>(H, W), <span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'bilinear'</span>, align_corners<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.cv_fuse(torch.cat((x<span class="hljs-number">0</span>, x<span class="hljs-number">1</span>, x<span class="hljs-number">2</span>), dim<span class="hljs-operator">=</span><span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SimFusion_<span class="hljs-number">4</span><span class="hljs-keyword">in</span>(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.avg_pool <span class="hljs-operator">=</span> nn.functional.adaptive_avg_pool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_l, x_m, x_s, x_n <span class="hljs-operator">=</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        B, C, H, W <span class="hljs-operator">=</span> x_s.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> np.array([H, W])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> torch.onnx.<span class="hljs-keyword">is</span>_<span class="hljs-keyword">in</span>_onnx_export():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.avg_pool <span class="hljs-operator">=</span> onnx_AdaptiveAvgPool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_l <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.avg_pool(x_l, <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_m <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.avg_pool(x_m, <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_n <span class="hljs-operator">=</span> F.interpolate(x_n, <span class="hljs-keyword">size</span><span class="hljs-operator">=</span>(H, W), <span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'bilinear'</span>, align_corners<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> torch.cat([x_l, x_m, x_s, x_n], <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> out</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> IFM(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, inc, ouc, embed_dim_p<span class="hljs-operator">=</span><span class="hljs-number">96</span>, fuse_<span class="hljs-keyword">block</span>_num<span class="hljs-operator">=</span><span class="hljs-number">3</span>) -<span class="hljs-operator">&gt;</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            Conv(inc, embed_dim_p),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-operator">*</span>[RepVGGBlock(embed_dim_p, embed_dim_p) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(fuse_<span class="hljs-keyword">block</span>_num)],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            Conv(embed_dim_p, <span class="hljs-keyword">sum</span>(ouc))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.conv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> h_sigmoid(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(h_sigmoid, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.relu <span class="hljs-operator">=</span> nn.ReLU<span class="hljs-number">6</span>(inplace<span class="hljs-operator">=</span>inplace)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.relu(x <span class="hljs-operator">+</span> <span class="hljs-number">3</span>) <span class="hljs-operator">/</span> <span class="hljs-number">6</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> InjectionMultiSum_Auto_pool(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            inp: int,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            oup: int,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">global</span>_inp: list,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            flag: int</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    ) -<span class="hljs-operator">&gt;</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">global</span>_inp <span class="hljs-operator">=</span> <span class="hljs-keyword">global</span>_inp</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.flag <span class="hljs-operator">=</span> flag</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.local_embedding <span class="hljs-operator">=</span> Conv(inp, oup, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">global</span>_embedding <span class="hljs-operator">=</span> Conv(<span class="hljs-keyword">global</span>_inp[<span class="hljs-keyword">self</span>.flag], oup, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">global</span>_act <span class="hljs-operator">=</span> Conv(<span class="hljs-keyword">global</span>_inp[<span class="hljs-keyword">self</span>.flag], oup, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> h_sigmoid()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-string">''</span><span class="hljs-string"><span class="hljs-string">'</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        x_g: global features</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        x_l: local features</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        '</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_l, x_g <span class="hljs-operator">=</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        B, C, H, W <span class="hljs-operator">=</span> x_l.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        g_B, g_C, g_H, g_W <span class="hljs-operator">=</span> x_g.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">use</span>_pool <span class="hljs-operator">=</span> H <span class="hljs-operator">&lt;</span> g_H</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        gloabl_info <span class="hljs-operator">=</span> x_g.split(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">global</span>_inp, dim<span class="hljs-operator">=</span><span class="hljs-number">1</span>)[<span class="hljs-keyword">self</span>.flag]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        local_feat <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.local_embedding(x_l)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">global</span>_act <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">global</span>_act(gloabl_info)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">global</span>_feat <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">global</span>_embedding(gloabl_info)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">use</span>_pool:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            avg_pool <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_avg_pool()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> np.array([H, W])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            sig_act <span class="hljs-operator">=</span> avg_pool(<span class="hljs-keyword">global</span>_act, <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">global</span>_feat <span class="hljs-operator">=</span> avg_pool(<span class="hljs-keyword">global</span>_feat, <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="299"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="300"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="301"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            sig_act <span class="hljs-operator">=</span> F.interpolate(<span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">global</span>_act), <span class="hljs-keyword">size</span><span class="hljs-operator">=</span>(H, W), <span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'bilinear'</span>, align_corners<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="302"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">global</span>_feat <span class="hljs-operator">=</span> F.interpolate(<span class="hljs-keyword">global</span>_feat, <span class="hljs-keyword">size</span><span class="hljs-operator">=</span>(H, W), <span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'bilinear'</span>, align_corners<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="303"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="304"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> local_feat <span class="hljs-operator">*</span> sig_act <span class="hljs-operator">+</span> <span class="hljs-keyword">global</span>_feat</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="305"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> out</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="306"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="307"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="308"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_shape(tensor):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="309"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    shape <span class="hljs-operator">=</span> tensor.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="310"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> torch.onnx.<span class="hljs-keyword">is</span>_<span class="hljs-keyword">in</span>_onnx_export():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="311"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        shape <span class="hljs-operator">=</span> [i.cpu().numpy() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> shape]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="312"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="313"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="314"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="315"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> PyramidPoolAgg(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="316"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, inc, ouc, stride, pool_<span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'torch'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="317"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="318"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">=</span> stride</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="319"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> pool_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'torch'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="320"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pool <span class="hljs-operator">=</span> nn.functional.adaptive_avg_pool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="321"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif pool_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'onnx'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="322"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pool <span class="hljs-operator">=</span> onnx_AdaptiveAvgPool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="323"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> Conv(inc, ouc)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="324"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="325"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, inputs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="326"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        B, C, H, W <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_shape(inputs[-<span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="327"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        H <span class="hljs-operator">=</span> (H<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">+</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="328"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        W <span class="hljs-operator">=</span> (W<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">+</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="329"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="330"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> np.array([H, W])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="331"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="332"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'pool'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="333"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pool <span class="hljs-operator">=</span> nn.functional.adaptive_avg_pool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="334"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="335"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> torch.onnx.<span class="hljs-keyword">is</span>_<span class="hljs-keyword">in</span>_onnx_export():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="336"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pool <span class="hljs-operator">=</span> onnx_AdaptiveAvgPool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="337"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="338"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> [<span class="hljs-keyword">self</span>.pool(inp, <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>) <span class="hljs-keyword">for</span> inp <span class="hljs-keyword">in</span> inputs]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="339"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="340"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.conv(torch.cat(out, dim<span class="hljs-operator">=</span><span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="341"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="342"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="343"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def drop_path(x, drop_prob: float <span class="hljs-operator">=</span> <span class="hljs-number">0</span>., training: bool <span class="hljs-operator">=</span> <span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="344"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Drop paths (Stochastic Depth) per sample (when applied in main path of residual blocks).</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="345"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    This is the same as the DropConnect impl I created for EfficientNet, etc networks, however,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="346"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    the original name is misleading as 'Drop Connect' is a different form of dropout in a separate paper...</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="347"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    See discussion: https://github.com/tensorflow/tpu/issues/494#issuecomment-532968956 ... I've opted for</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="348"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    changing the layer and argument names to 'drop path' rather than mix DropConnect as a layer name and use</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="349"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    'survival rate' as the argument.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="350"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="351"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> drop_prob <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>. <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> training:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="352"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="353"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    keep_prob <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator"> - </span>drop_prob</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="354"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    shape <span class="hljs-operator">=</span> (x.shape[<span class="hljs-number">0</span>],) <span class="hljs-operator">+</span> (<span class="hljs-number">1</span>,) <span class="hljs-operator">*</span> (x.ndim<span class="hljs-operator"> - </span><span class="hljs-number">1</span>)  # work <span class="hljs-keyword">with</span> diff dim tensors, <span class="hljs-keyword">not</span> <span class="hljs-keyword">just</span> <span class="hljs-number">2</span>D ConvNets</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="355"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">random</span>_tensor <span class="hljs-operator">=</span> keep_prob <span class="hljs-operator">+</span> torch.rand(shape, dtype<span class="hljs-operator">=</span>x.dtype, device<span class="hljs-operator">=</span>x.device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="356"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">random</span>_tensor.floor_()  # binarize</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="357"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">output</span> <span class="hljs-operator">=</span> x.div(keep_prob) <span class="hljs-operator">*</span> <span class="hljs-keyword">random</span>_tensor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="358"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">output</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="359"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="360"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="361"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Mlp(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="362"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">in</span>_features, hidden_features<span class="hljs-operator">=</span>None, out_features<span class="hljs-operator">=</span>None, drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>.):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="363"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="364"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out_features <span class="hljs-operator">=</span> out_features <span class="hljs-keyword">or</span> <span class="hljs-keyword">in</span>_features</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="365"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        hidden_features <span class="hljs-operator">=</span> hidden_features <span class="hljs-keyword">or</span> <span class="hljs-keyword">in</span>_features</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="366"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fc<span class="hljs-number">1</span> <span class="hljs-operator">=</span> Conv(<span class="hljs-keyword">in</span>_features, hidden_features, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="367"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dwconv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(hidden_features, hidden_features, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, groups<span class="hljs-operator">=</span>hidden_features)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="368"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> nn.ReLU<span class="hljs-number">6</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="369"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fc<span class="hljs-number">2</span> <span class="hljs-operator">=</span> Conv(hidden_features, out_features, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="370"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.drop <span class="hljs-operator">=</span> nn.Dropout(drop)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="371"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="372"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="373"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.fc<span class="hljs-number">1</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="374"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.dwconv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="375"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.act(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="376"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.drop(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="377"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.fc<span class="hljs-number">2</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="378"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.drop(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="379"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="380"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="381"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="382"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> DropPath(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="383"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Drop paths (Stochastic Depth) per sample  (when applied in main path of residual blocks).</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="384"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="385"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="386"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, drop_prob<span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="387"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(DropPath, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="388"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.drop_prob <span class="hljs-operator">=</span> drop_prob</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="389"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="390"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="391"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> drop_path(x, <span class="hljs-keyword">self</span>.drop_prob, <span class="hljs-keyword">self</span>.training)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="392"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="393"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="394"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Attention(torch.nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="395"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, dim, <span class="hljs-keyword">key</span>_dim, num_heads, attn_ratio<span class="hljs-operator">=</span><span class="hljs-number">4</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="396"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="397"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.num_heads <span class="hljs-operator">=</span> num_heads</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="398"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.scale <span class="hljs-operator">=</span> <span class="hljs-keyword">key</span>_dim <span class="hljs-operator">**</span> -<span class="hljs-number">0.5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="399"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">key</span>_dim <span class="hljs-operator">=</span> <span class="hljs-keyword">key</span>_dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="400"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.nh_kd <span class="hljs-operator">=</span> nh_kd <span class="hljs-operator">=</span> <span class="hljs-keyword">key</span>_dim <span class="hljs-operator">*</span> num_heads  # num_head <span class="hljs-keyword">key</span>_dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="401"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.d <span class="hljs-operator">=</span> int(attn_ratio <span class="hljs-operator">*</span> <span class="hljs-keyword">key</span>_dim)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="402"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dh <span class="hljs-operator">=</span> int(attn_ratio <span class="hljs-operator">*</span> <span class="hljs-keyword">key</span>_dim) <span class="hljs-operator">*</span> num_heads</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="403"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.attn_ratio <span class="hljs-operator">=</span> attn_ratio</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="404"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="405"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_q <span class="hljs-operator">=</span> Conv(dim, nh_kd, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="406"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_k <span class="hljs-operator">=</span> Conv(dim, nh_kd, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="407"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_v <span class="hljs-operator">=</span> Conv(dim, <span class="hljs-keyword">self</span>.dh, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="408"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="409"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.proj <span class="hljs-operator">=</span> torch.nn.<span class="hljs-keyword">Sequential</span>(nn.ReLU<span class="hljs-number">6</span>(), Conv(<span class="hljs-keyword">self</span>.dh, dim, act<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="410"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="411"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):  # x (B,N,C)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="412"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        B, C, H, W <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_shape(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="413"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="414"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        qq <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_q(x).reshape(B, <span class="hljs-keyword">self</span>.num_heads, <span class="hljs-keyword">self</span>.<span class="hljs-keyword">key</span>_dim, H <span class="hljs-operator">*</span> W).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="415"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kk <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_k(x).reshape(B, <span class="hljs-keyword">self</span>.num_heads, <span class="hljs-keyword">self</span>.<span class="hljs-keyword">key</span>_dim, H <span class="hljs-operator">*</span> W)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="416"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        vv <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_v(x).reshape(B, <span class="hljs-keyword">self</span>.num_heads, <span class="hljs-keyword">self</span>.d, H <span class="hljs-operator">*</span> W).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="417"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="418"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn <span class="hljs-operator">=</span> torch.matmul(qq, kk)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="419"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn <span class="hljs-operator">=</span> attn.softmax(dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)  # dim <span class="hljs-operator">=</span> k</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="420"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="421"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx <span class="hljs-operator">=</span> torch.matmul(attn, vv)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="422"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="423"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx <span class="hljs-operator">=</span> xx.permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>).reshape(B, <span class="hljs-keyword">self</span>.dh, H, W)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="424"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.proj(xx)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="425"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> xx</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="426"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="427"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="428"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> <span class="hljs-keyword">top</span>_<span class="hljs-keyword">Block</span>(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="429"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="430"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, dim, <span class="hljs-keyword">key</span>_dim, num_heads, mlp_ratio<span class="hljs-operator">=</span><span class="hljs-number">4</span>., attn_ratio<span class="hljs-operator">=</span><span class="hljs-number">2</span>., drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>.,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="431"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 drop_path<span class="hljs-operator">=</span><span class="hljs-number">0</span>.):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="432"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="433"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dim <span class="hljs-operator">=</span> dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="434"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.num_heads <span class="hljs-operator">=</span> num_heads</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="435"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.mlp_ratio <span class="hljs-operator">=</span> mlp_ratio</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="436"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="437"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.attn <span class="hljs-operator">=</span> Attention(dim, <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-keyword">key</span>_dim, num_heads<span class="hljs-operator">=</span>num_heads, attn_ratio<span class="hljs-operator">=</span>attn_ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="438"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="439"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # NOTE: drop path <span class="hljs-keyword">for</span> stochastic depth, we shall see <span class="hljs-keyword">if</span> this <span class="hljs-keyword">is</span> better <span class="hljs-keyword">than</span> dropout here</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="440"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.drop_path <span class="hljs-operator">=</span> DropPath(drop_path) <span class="hljs-keyword">if</span> drop_path <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>. <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="441"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_hidden_dim <span class="hljs-operator">=</span> int(dim <span class="hljs-operator">*</span> mlp_ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="442"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.mlp <span class="hljs-operator">=</span> Mlp(<span class="hljs-keyword">in</span>_features<span class="hljs-operator">=</span>dim, hidden_features<span class="hljs-operator">=</span>mlp_hidden_dim, drop<span class="hljs-operator">=</span>drop)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="443"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="444"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x<span class="hljs-number">1</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="445"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.drop_path(<span class="hljs-keyword">self</span>.attn(x<span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="446"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.drop_path(<span class="hljs-keyword">self</span>.mlp(x<span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="447"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="448"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="449"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="450"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> TopBasicLayer(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="451"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, embedding_dim, ouc_list, <span class="hljs-keyword">block</span>_num<span class="hljs-operator">=</span><span class="hljs-number">2</span>, <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-number">8</span>, num_heads<span class="hljs-operator">=</span><span class="hljs-number">4</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="452"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 mlp_ratio<span class="hljs-operator">=</span><span class="hljs-number">4</span>., attn_ratio<span class="hljs-operator">=</span><span class="hljs-number">2</span>., drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>., attn_drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>., drop_path<span class="hljs-operator">=</span><span class="hljs-number">0</span>.):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="453"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="454"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">block</span>_num <span class="hljs-operator">=</span> <span class="hljs-keyword">block</span>_num</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="455"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="456"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.transformer_blocks <span class="hljs-operator">=</span> nn.ModuleList()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="457"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">block</span>_num):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="458"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.transformer_blocks.append(<span class="hljs-keyword">top</span>_<span class="hljs-keyword">Block</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="459"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                embedding_dim, <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-keyword">key</span>_dim, num_heads<span class="hljs-operator">=</span>num_heads,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="460"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                mlp_ratio<span class="hljs-operator">=</span>mlp_ratio, attn_ratio<span class="hljs-operator">=</span>attn_ratio,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="461"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                drop<span class="hljs-operator">=</span>drop, drop_path<span class="hljs-operator">=</span>drop_path[i] <span class="hljs-keyword">if</span> isinstance(drop_path, list) <span class="hljs-keyword">else</span> drop_path))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="462"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(embedding_dim, <span class="hljs-keyword">sum</span>(ouc_list), <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="463"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="464"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="465"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # token <span class="hljs-operator">*</span> N</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="466"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">block</span>_num):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="467"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.transformer_blocks[i](x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="468"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.conv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="469"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="470"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="471"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> AdvPoolFusion(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="472"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="473"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span>, x<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="474"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> torch.onnx.<span class="hljs-keyword">is</span>_<span class="hljs-keyword">in</span>_onnx_export():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="475"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pool <span class="hljs-operator">=</span> onnx_AdaptiveAvgPool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="476"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="477"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pool <span class="hljs-operator">=</span> nn.functional.adaptive_avg_pool<span class="hljs-number">2</span>d</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="478"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="479"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        N, C, H, W <span class="hljs-operator">=</span> x<span class="hljs-number">2</span>.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="480"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> np.array([H, W])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="481"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.pool(x<span class="hljs-number">1</span>, <span class="hljs-keyword">output</span>_<span class="hljs-keyword">size</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="482"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="483"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> torch.cat([x<span class="hljs-number">1</span>, x<span class="hljs-number">2</span>], <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="484"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="485"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">###################### gold-yolo  ####     <span class="hljs-keyword">END</span>   <span class="hljs-keyword">by</span>  AI<span class="hljs-operator">&amp;</span>CV  ###############################</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t3"></a>2.2 注册ultralytics/nn/tasks.py</h3> 
<p></p> 
<pre data-index="1"><code class="hljs language-cobol"><span class="hljs-keyword">from</span> ultralytics.nn.head.goldyolo import IFM,SimFusion_<span class="hljs-number">3</span><span class="hljs-keyword">in</span>,SimFusion_<span class="hljs-number">4</span><span class="hljs-keyword">in</span>,InjectionMultiSum_Auto_pool,PyramidPoolAgg,TopBasicLayer,AdvPoolFusion</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改def parse_model(d, ch, verbose=True): # model_dict, input_channels(3)</p> 
<p>加在这下面即可，对其：</p> 
<p><img alt="" height="79" src="https://img-blog.csdnimg.cn/7c8bbfb5f30c4460b3019cb9b73ebd4c.png" width="332"></p> 
<p>加入以下代码：</p> 
<pre data-index="2" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        #####################gold-yolo##################</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif m <span class="hljs-keyword">in</span> {SimFusion_<span class="hljs-number">4</span><span class="hljs-keyword">in</span>, AdvPoolFusion}:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">sum</span>(<span class="hljs-keyword">ch</span>[x] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif m <span class="hljs-keyword">is</span> SimFusion_<span class="hljs-number">3</span><span class="hljs-keyword">in</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> !<span class="hljs-operator">=</span> nc:  # <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">equal</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes (i.e. <span class="hljs-keyword">for</span> Classify() <span class="hljs-keyword">output</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> make_divisible(min(c<span class="hljs-number">2</span>, max_channels) <span class="hljs-operator">*</span> width, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [[<span class="hljs-keyword">ch</span>[f_] <span class="hljs-keyword">for</span> f_ <span class="hljs-keyword">in</span> f], c<span class="hljs-number">2</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif m <span class="hljs-keyword">is</span> IFM:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>[f]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">sum</span>(args[<span class="hljs-number">0</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [c<span class="hljs-number">1</span>, <span class="hljs-operator">*</span>args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif m <span class="hljs-keyword">is</span> InjectionMultiSum_Auto_pool:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>[f[<span class="hljs-number">0</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [c<span class="hljs-number">1</span>, <span class="hljs-operator">*</span>args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif m <span class="hljs-keyword">is</span> PyramidPoolAgg:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [<span class="hljs-keyword">sum</span>([<span class="hljs-keyword">ch</span>[f_] <span class="hljs-keyword">for</span> f_ <span class="hljs-keyword">in</span> f]), <span class="hljs-operator">*</span>args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif m <span class="hljs-keyword">is</span> TopBasicLayer:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">sum</span>(args[<span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        #####################gold-yolo##################</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t4"></a>2.3&nbsp;yolov8-goldyolo.yaml</h3> 
<pre data-index="3" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1052px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Ultralytics YOLO 🚀, AGPL-<span class="hljs-number">3.0</span> license</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8</span> <span class="hljs-keyword">object</span> detection model <span class="hljs-keyword">with</span> P<span class="hljs-number">3</span>-P<span class="hljs-number">5</span> outputs. <span class="hljs-keyword">For</span> <span class="hljs-keyword">Usage</span> examples see https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>docs.ultralytics.com<span class="hljs-operator">/</span>tasks<span class="hljs-operator">/</span>detect</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Parameters</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">nc: <span class="hljs-number">80</span>  # <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">scales: # model compound scaling constants, i.e. <span class="hljs-string">'model=yolov8n.yaml'</span> will <span class="hljs-keyword">call</span> yolov<span class="hljs-number">8</span>.yaml <span class="hljs-keyword">with</span> scale <span class="hljs-string">'n'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [depth, width, max_channels]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  n: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>n summary: <span class="hljs-number">225</span> layers,  <span class="hljs-number">3157200</span> parameters,  <span class="hljs-number">3157184</span> gradients,   <span class="hljs-number">8.9</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  s: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.50</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>s summary: <span class="hljs-number">225</span> layers, <span class="hljs-number">11166560</span> parameters, <span class="hljs-number">11166544</span> gradients,  <span class="hljs-number">28.8</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  m: [<span class="hljs-number">0.67</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">768</span>]   # YOLOv<span class="hljs-number">8</span>m summary: <span class="hljs-number">295</span> layers, <span class="hljs-number">25902640</span> parameters, <span class="hljs-number">25902624</span> gradients,  <span class="hljs-number">79.3</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  l: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>l summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">43691520</span> parameters, <span class="hljs-number">43691504</span> gradients, <span class="hljs-number">165.7</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  x: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>x summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">68229648</span> parameters, <span class="hljs-number">68229632</span> gradients, <span class="hljs-number">258.5</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n backbone</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">backbone:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [<span class="hljs-keyword">from</span>, repeats, module, args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">0</span>-P<span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">1</span>-P<span class="hljs-number">2</span><span class="hljs-operator">/</span><span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">128</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">3</span>-P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">5</span>-P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">7</span>-P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, SPPF, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]]  # <span class="hljs-number">9</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n head</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#gold-yolo Gather-and-Distribute Mechanism</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>github.com<span class="hljs-operator">/</span>huawei-noah<span class="hljs-operator">/</span>Efficient-Computing<span class="hljs-operator">/</span>tree<span class="hljs-operator">/</span>master<span class="hljs-operator">/</span>Detection<span class="hljs-operator">/</span>Gold-YOLO</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">head:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Low-GD</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">9</span>], <span class="hljs-number">1</span>, SimFusion_<span class="hljs-number">4</span><span class="hljs-keyword">in</span>, []] # <span class="hljs-number">10</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, IFM, [[<span class="hljs-number">64</span>, <span class="hljs-number">32</span>]]] # <span class="hljs-number">11</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[<span class="hljs-number">9</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]] # <span class="hljs-number">12</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">4</span>, <span class="hljs-number">6</span>, -<span class="hljs-number">1</span>], <span class="hljs-number">1</span>, SimFusion_<span class="hljs-number">3</span><span class="hljs-keyword">in</span>, [<span class="hljs-number">512</span>]] # <span class="hljs-number">13</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">11</span>], <span class="hljs-number">1</span>, InjectionMultiSum_Auto_pool, [<span class="hljs-number">512</span>, [<span class="hljs-number">64</span>, <span class="hljs-number">32</span>], <span class="hljs-number">0</span>]] # <span class="hljs-number">14</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]] # <span class="hljs-number">15</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># High-GD</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[<span class="hljs-number">6</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]] # <span class="hljs-number">16</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, -<span class="hljs-number">1</span>], <span class="hljs-number">1</span>, SimFusion_<span class="hljs-number">3</span><span class="hljs-keyword">in</span>, [<span class="hljs-number">256</span>]] # <span class="hljs-number">17</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">11</span>], <span class="hljs-number">1</span>, InjectionMultiSum_Auto_pool, [<span class="hljs-number">256</span>, [<span class="hljs-number">64</span>, <span class="hljs-number">32</span>], <span class="hljs-number">1</span>]] # <span class="hljs-number">18</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>]] # <span class="hljs-number">19</span>  head N<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">19</span>, <span class="hljs-number">15</span>, <span class="hljs-number">9</span>], <span class="hljs-number">1</span>, PyramidPoolAgg, [<span class="hljs-number">352</span>, <span class="hljs-number">2</span>]] # <span class="hljs-number">20</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TopBasicLayer, [<span class="hljs-number">352</span>, [<span class="hljs-number">64</span>, <span class="hljs-number">128</span>]]] # <span class="hljs-number">21</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">19</span>, <span class="hljs-number">16</span>], <span class="hljs-number">1</span>, AdvPoolFusion, []] # <span class="hljs-number">22</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">21</span>], <span class="hljs-number">1</span>, InjectionMultiSum_Auto_pool, [<span class="hljs-number">256</span>, [<span class="hljs-number">64</span>, <span class="hljs-number">128</span>], <span class="hljs-number">0</span>]] # <span class="hljs-number">23</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>]] # <span class="hljs-number">24</span>  head N<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">12</span>], <span class="hljs-number">1</span>, AdvPoolFusion, []] # <span class="hljs-number">25</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">21</span>], <span class="hljs-number">1</span>, InjectionMultiSum_Auto_pool, [<span class="hljs-number">512</span>, [<span class="hljs-number">64</span>, <span class="hljs-number">128</span>], <span class="hljs-number">1</span>]] # <span class="hljs-number">26</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>]] # <span class="hljs-number">27</span>    head N<span class="hljs-number">5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">19</span>, <span class="hljs-number">24</span>, <span class="hljs-number">27</span>], <span class="hljs-number">1</span>, Detect, [nc]] # <span class="hljs-number">28</span></div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/133271100&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>