<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <p>&nbsp;ğŸ’¡ğŸ’¡ğŸ’¡<span style="color:#fe2c24;"><strong>æœ¬æ–‡ç‹¬å®¶æ”¹è¿›ï¼šåŠ¨æ€è›‡å½¢å·ç§¯ï¼ˆDynamic Snake Convolutionï¼‰</strong></span>ï¼Œå¢å¼ºç»†é•¿å¾®å¼±çš„å±€éƒ¨ç»“æ„ç‰¹å¾ä¸å¤æ‚å¤šå˜çš„å…¨å±€å½¢æ€ç‰¹å¾</p> 
<p><strong><span style="color:#fe2c24;">Dynamic Snake Convolution</span> |&nbsp; &nbsp;äº²æµ‹åœ¨å¤šä¸ªæ•°æ®é›†èƒ½å¤Ÿå®ç°å¤§å¹…æ¶¨ç‚¹</strong></p> 
<p>ğŸ’¡ğŸ’¡ğŸ’¡Yolov8é­”æœ¯å¸ˆï¼Œç‹¬å®¶é¦–å‘åˆ›æ–°ï¼ˆåŸåˆ›ï¼‰ï¼Œé€‚ç”¨äº<a href="https://so.csdn.net/so/search?q=Yolov5&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=Yolov5&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;Yolov5\&quot;}&quot;}" data-tit="Yolov5" data-pretit="yolov5">Yolov5</a>ã€Yolov7ã€Yolov8ç­‰å„ä¸ªYoloç³»åˆ—ï¼Œä¸“æ æ–‡ç« æä¾›æ¯ä¸€æ­¥æ­¥éª¤å’Œæºç ï¼Œè½»æ¾å¸¦ä½ ä¸Šæ‰‹é­”æ”¹ç½‘ç»œ</p> 
 
<p><strong>ä¸“æ ä»‹ç»ï¼š</strong></p> 
<p><a href="https://blog.csdn.net/m0_63774211/category_12289773.html" title="https://blog.csdn.net/m0_63774211/category_12289773.html">https://blog.csdn.net/m0_63774211/category_12289773.html</a></p> 
<p>âœ¨âœ¨âœ¨åŸåˆ›é­”æ”¹ç½‘ç»œã€å¤ç°å‰æ²¿è®ºæ–‡ï¼Œç»„åˆä¼˜åŒ–åˆ›æ–°</p> 
<p>ğŸš€ğŸš€ğŸš€å°ç›®æ ‡ã€é®æŒ¡ç‰©ã€éš¾æ ·æœ¬æ€§èƒ½æå‡</p> 
<p>ğŸ‰ğŸ‰ğŸ‰æŒç»­æ›´æ–°ä¸­ï¼Œå®šæœŸæ›´æ–°ä¸åŒ<a href="https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;æ•°æ®é›†\&quot;}&quot;}" data-tit="æ•°æ®é›†" data-pretit="æ•°æ®é›†">æ•°æ®é›†</a>æ¶¨ç‚¹æƒ…å†µ</p> 
<h2><a name="t0"></a>1.Dynamic Snake Convolution</h2> 
<p><img alt="" height="417" src="https://img-blog.csdnimg.cn/843de88095a94e0aa22a1e47d67d329a.png" width="1200"></p> 
<p>è®ºæ–‡ï¼š&nbsp;<a href="https://arxiv.org/pdf/2307.08388.pdf" title="2307.08388.pdf (arxiv.org)">2307.08388.pdf (arxiv.org)</a></p> 
<p><strong>æ‘˜è¦ï¼š</strong>è¡€ç®¡ã€é“è·¯ç­‰æ‹“æ‰‘ç®¡çŠ¶ç»“æ„çš„ç²¾ç¡®åˆ†å‰²åœ¨å„ä¸ªé¢†åŸŸéƒ½è‡³å…³é‡è¦ï¼Œç¡®ä¿ä¸‹æ¸¸ä»»åŠ¡çš„å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚ ç„¶è€Œï¼Œè®¸å¤šå› ç´ ä½¿ä»»åŠ¡å˜å¾—å¤æ‚ï¼ŒåŒ…æ‹¬è–„çš„å±€éƒ¨ç»“æ„å’Œå¯å˜çš„å…¨å±€å½¢æ€ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ç®¡çŠ¶ç»“æ„çš„ç‰¹æ®Šæ€§ï¼Œå¹¶åˆ©ç”¨è¿™äº›çŸ¥è¯†æ¥æŒ‡å¯¼æˆ‘ä»¬çš„ DSCNet åœ¨ä¸‰ä¸ªé˜¶æ®µåŒæ—¶å¢å¼ºæ„ŸçŸ¥ï¼šç‰¹å¾æå–ã€ç‰¹å¾èåˆã€ å’ŒæŸå¤±çº¦æŸã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŠ¨æ€è›‡å·ç§¯ï¼Œé€šè¿‡è‡ªé€‚åº”åœ°å…³æ³¨ç»†é•¿å’Œæ›²æŠ˜çš„å±€éƒ¨ç»“æ„æ¥å‡†ç¡®æ•è·ç®¡çŠ¶ç»“æ„çš„ç‰¹å¾ã€‚ éšåï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§å¤šè§†å›¾ç‰¹å¾èåˆç­–ç•¥ï¼Œä»¥è¡¥å……ç‰¹å¾èåˆè¿‡ç¨‹ä¸­å¤šè§’åº¦å¯¹ç‰¹å¾çš„å…³æ³¨ï¼Œç¡®ä¿ä¿ç•™æ¥è‡ªä¸åŒå…¨å±€å½¢æ€çš„é‡è¦ä¿¡æ¯ã€‚ æœ€åï¼Œæå‡ºäº†ä¸€ç§åŸºäºæŒä¹…åŒæºæ€§çš„è¿ç»­æ€§çº¦æŸæŸå¤±å‡½æ•°ï¼Œä»¥æ›´å¥½åœ°çº¦æŸåˆ†å‰²çš„æ‹“æ‰‘è¿ç»­æ€§ã€‚ 2D å’Œ 3D æ•°æ®é›†ä¸Šçš„å®éªŒè¡¨æ˜ï¼Œä¸å¤šç§æ–¹æ³•ç›¸æ¯”ï¼Œæˆ‘ä»¬çš„ DSCNet åœ¨ç®¡çŠ¶ç»“æ„åˆ†å‰²ä»»åŠ¡ä¸Šæä¾›äº†æ›´å¥½çš„å‡†ç¡®æ€§å’Œè¿ç»­æ€§ã€‚ æˆ‘ä»¬çš„ä»£ç æ˜¯å…¬å¼€çš„ã€‚&nbsp;</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸»è¦çš„æŒ‘æˆ˜æºäºç»†é•¿å¾®å¼±çš„å±€éƒ¨ç»“æ„ç‰¹å¾ä¸å¤æ‚å¤šå˜çš„å…¨å±€å½¢æ€ç‰¹å¾ã€‚æœ¬æ–‡å…³æ³¨åˆ°ç®¡çŠ¶ç»“æ„ç»†é•¿è¿ç»­çš„ç‰¹ç‚¹ï¼Œå¹¶åˆ©ç”¨è¿™ä¸€ä¿¡æ¯åœ¨ç¥ç»ç½‘ç»œä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µåŒæ—¶å¢å¼ºæ„ŸçŸ¥ï¼šç‰¹å¾æå–ã€ç‰¹å¾èåˆå’ŒæŸå¤±çº¦æŸã€‚åˆ†åˆ«è®¾è®¡äº†åŠ¨æ€è›‡å½¢å·ç§¯ï¼ˆDynamic&nbsp;Snake&nbsp;Convolutionï¼‰ï¼Œå¤šè§†è§’ç‰¹å¾èåˆç­–ç•¥ä¸è¿ç»­æ€§æ‹“æ‰‘çº¦æŸæŸå¤±ã€‚&nbsp;</p> 
<p><img alt="" height="550" src="https://img-blog.csdnimg.cn/0336f4a6258841bc90955af5e5c19c60.png" width="663"></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å¸Œæœ›<a href="https://so.csdn.net/so/search?q=%E5%8D%B7%E7%A7%AF%E6%A0%B8&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E5%8D%B7%E7%A7%AF%E6%A0%B8&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;å·ç§¯æ ¸\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E5%8D%B7%E7%A7%AF%E6%A0%B8&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;å·ç§¯æ ¸\&quot;}&quot;}" data-tit="å·ç§¯æ ¸" data-pretit="å·ç§¯æ ¸">å·ç§¯æ ¸</a>ä¸€æ–¹é¢èƒ½å¤Ÿ<strong>è‡ªç”±</strong>åœ°è´´åˆç»“æ„å­¦ä¹ ç‰¹å¾ï¼Œå¦ä¸€æ–¹é¢èƒ½å¤Ÿåœ¨<strong>çº¦æŸ</strong>æ¡ä»¶ä¸‹ä¸åç¦»ç›®æ ‡ç»“æ„å¤ªè¿œã€‚åœ¨è§‚å¯Ÿç®¡çŠ¶ç»“æ„çš„ç»†é•¿è¿ç»­çš„ç‰¹å¾åï¼Œè„‘æµ·é‡Œæƒ³åˆ°äº†ä¸€ä¸ªåŠ¨ç‰©â€”â€”<strong>è›‡</strong>ã€‚æˆ‘ä»¬å¸Œæœ›å·ç§¯æ ¸èƒ½å¤Ÿåƒè›‡ä¸€æ ·åŠ¨æ€åœ°æ‰­åŠ¨ï¼Œæ¥è´´åˆç›®æ ‡çš„ç»“æ„ã€‚</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å¸Œæœ›å·ç§¯æ ¸ä¸€æ–¹é¢èƒ½å¤Ÿ<strong>è‡ªç”±</strong>åœ°è´´åˆç»“æ„å­¦ä¹ ç‰¹å¾ï¼Œå¦ä¸€æ–¹é¢èƒ½å¤Ÿåœ¨<strong>çº¦æŸ</strong>æ¡ä»¶ä¸‹ä¸åç¦»ç›®æ ‡ç»“æ„å¤ªè¿œã€‚åœ¨è§‚å¯Ÿç®¡çŠ¶ç»“æ„çš„ç»†é•¿è¿ç»­çš„ç‰¹å¾åï¼Œè„‘æµ·é‡Œæƒ³åˆ°äº†ä¸€ä¸ªåŠ¨ç‰©â€”â€”<strong>è›‡</strong>ã€‚æˆ‘ä»¬å¸Œæœ›å·ç§¯æ ¸èƒ½å¤Ÿåƒè›‡ä¸€æ ·åŠ¨æ€åœ°æ‰­åŠ¨ï¼Œæ¥è´´åˆç›®æ ‡çš„ç»“æ„ã€‚</p> 
<p><img alt="" height="544" src="https://img-blog.csdnimg.cn/233730e43b9445eeb8652c380bd96fe7.png" width="1200"></p> 
<p></p> 
<h2><a name="t1"></a>&nbsp;2.Dynamic Snake Convolutionå¼•å…¥åˆ°yolov8</h2> 
<h3><a name="t2"></a>2.1 æ–°å»ºDynamic Snake ConvolutionåŠ å…¥ultralytics/nn/Conv/dynamic_snake_conv.py</h3> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-haskell"><ol class="hljs-ln hundred" style="width:1092px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> torch</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-meta">#from ..modules import C2f,Conv,C3,Bottleneck</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-title">__all__</span> = ['<span class="hljs-type">DySnakeConv'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-title">def</span> autopad(k, p=<span class="hljs-type">None</span>, d=<span class="hljs-number">1</span>):  # kernel, padding, dilation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-type">Pad</span> to 'same' shape outputs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> d &gt; <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k = d * (k - <span class="hljs-number">1</span>) + <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [d * (x - <span class="hljs-number">1</span>) + <span class="hljs-number">1</span> for x <span class="hljs-keyword">in</span> k]  # actual kernel-size</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> p is <span class="hljs-type">None</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p = k // <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [x // <span class="hljs-number">2</span> for x <span class="hljs-keyword">in</span> k]  # auto-pad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    return p</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-class"></span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Conv</span>(<span class="hljs-title">nn</span>.<span class="hljs-type">Module</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    # <span class="hljs-type">Standard</span> convolution with args(<span class="hljs-title">ch_in</span>, <span class="hljs-title">ch_out</span>, <span class="hljs-title">kernel</span>, <span class="hljs-title">stride</span>, <span class="hljs-title">padding</span>, <span class="hljs-title">groups</span>, <span class="hljs-title">dilation</span>, <span class="hljs-title">activation</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    default_act = nn.<span class="hljs-type">SiLU</span>()  # default activation</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">k</span>=1, <span class="hljs-title">s</span>=1, <span class="hljs-title">p</span>=<span class="hljs-type">None</span>, <span class="hljs-title">g</span>=1, <span class="hljs-title">d</span>=1, <span class="hljs-title">act</span>=<span class="hljs-type">True</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        super().__init__()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.conv = nn.<span class="hljs-type">Conv2d</span>(<span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">k</span>, <span class="hljs-title">s</span>, <span class="hljs-title">autopad</span>(<span class="hljs-title">k</span>, <span class="hljs-title">p</span>, <span class="hljs-title">d</span>), groups=g, dilation=d, bias=<span class="hljs-type">False</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.bn = nn.<span class="hljs-type">BatchNorm2d</span>(<span class="hljs-title">c2</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.act = self.default_act if act is <span class="hljs-type">True</span> else act if isinstance(<span class="hljs-title">act</span>, <span class="hljs-title">nn</span>.<span class="hljs-type">Module</span>) else nn.<span class="hljs-type">Identity</span>()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward(<span class="hljs-title">self</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return self.act(<span class="hljs-title">self</span>.<span class="hljs-title">bn</span>(<span class="hljs-title">self</span>.<span class="hljs-title">conv</span>(<span class="hljs-title">x</span>)))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward_fuse(<span class="hljs-title">self</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return self.act(<span class="hljs-title">self</span>.<span class="hljs-title">conv</span>(<span class="hljs-title">x</span>))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">C2f</span>(<span class="hljs-title">nn</span>.<span class="hljs-type">Module</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    # <span class="hljs-type">CSP</span> <span class="hljs-type">Bottleneck</span> with 2 convolutions</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">n</span>=1, <span class="hljs-title">shortcut</span>=<span class="hljs-type">False</span>, <span class="hljs-title">g</span>=1, <span class="hljs-title">e</span>=0.5):  # ch_in, ch_out, number, shortcut, groups, expansion</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        super().__init__()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.c = int(<span class="hljs-title">c2</span> * <span class="hljs-title">e</span>)  # hidden channels</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.cv1 = <span class="hljs-type">Conv</span>(<span class="hljs-title">c1</span>, 2 * <span class="hljs-title">self</span>.<span class="hljs-title">c</span>, 1, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.cv2 = <span class="hljs-type">Conv</span>((2 + <span class="hljs-title">n</span>) * self.c, c2, 1)  # optional act=<span class="hljs-type">FReLU</span>(<span class="hljs-title">c2</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.m = nn.<span class="hljs-type">ModuleList</span>(<span class="hljs-type">Bottleneck</span>(<span class="hljs-title">self</span>.<span class="hljs-title">c</span>, <span class="hljs-title">self</span>.<span class="hljs-title">c</span>, <span class="hljs-title">shortcut</span>, <span class="hljs-title">g</span>, <span class="hljs-title">k</span>=((3, 3), (3, 3)), e=1.0) for _ in range(<span class="hljs-title">n</span>))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward(<span class="hljs-title">self</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y = list(<span class="hljs-title">self</span>.<span class="hljs-title">cv1</span>(<span class="hljs-title">x</span>).chunk(2, 1))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y.extend(<span class="hljs-title">m</span>(<span class="hljs-title">y</span>[-1]) for m in self.m)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return self.cv2(<span class="hljs-title">torch</span>.<span class="hljs-title">cat</span>(<span class="hljs-title">y</span>, 1))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward_split(<span class="hljs-title">self</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y = list(<span class="hljs-title">self</span>.<span class="hljs-title">cv1</span>(<span class="hljs-title">x</span>).split((<span class="hljs-title">self</span>.<span class="hljs-title">c</span>, <span class="hljs-title">self</span>.<span class="hljs-title">c</span>), 1))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y.extend(<span class="hljs-title">m</span>(<span class="hljs-title">y</span>[-1]) for m in self.m)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return self.cv2(<span class="hljs-title">torch</span>.<span class="hljs-title">cat</span>(<span class="hljs-title">y</span>, 1))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Bottleneck</span>(<span class="hljs-title">nn</span>.<span class="hljs-type">Module</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    # <span class="hljs-type">Standard</span> bottleneck</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">shortcut</span>=<span class="hljs-type">True</span>, <span class="hljs-title">g</span>=1, <span class="hljs-title">k</span>=(3, 3), e=0.5):  # ch_in, ch_out, shortcut, groups, kernels, expand</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        super().__init__()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        c_ = int(<span class="hljs-title">c2</span> * <span class="hljs-title">e</span>)  # hidden channels</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.cv1 = <span class="hljs-type">Conv</span>(<span class="hljs-title">c1</span>, <span class="hljs-title">c_</span>, <span class="hljs-title">k</span>[0], 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.cv2 = <span class="hljs-type">Conv</span>(<span class="hljs-title">c_</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">k</span>[1], 1, <span class="hljs-title">g</span>=<span class="hljs-title">g</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.add = shortcut and c1 == c2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward(<span class="hljs-title">self</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return x + self.cv2(<span class="hljs-title">self</span>.<span class="hljs-title">cv1</span>(<span class="hljs-title">x</span>)) if self.add else self.cv2(<span class="hljs-title">self</span>.<span class="hljs-title">cv1</span>(<span class="hljs-title">x</span>))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">DySnakeConv</span>(<span class="hljs-title">nn</span>.<span class="hljs-type">Module</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">inc</span>, <span class="hljs-title">ouc</span>, <span class="hljs-title">k</span>=3) -&gt; <span class="hljs-type">None</span>:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        super().__init__()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        </span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.conv_0 = <span class="hljs-type">Conv</span>(<span class="hljs-title">inc</span>, <span class="hljs-title">ouc</span>, <span class="hljs-title">k</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.conv_x = <span class="hljs-type">DSConv</span>(<span class="hljs-title">inc</span>, <span class="hljs-title">ouc</span>, 0, <span class="hljs-title">k</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.conv_y = <span class="hljs-type">DSConv</span>(<span class="hljs-title">inc</span>, <span class="hljs-title">ouc</span>, 1, <span class="hljs-title">k</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    </span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward(<span class="hljs-title">self</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return torch.cat([<span class="hljs-title">self</span>.<span class="hljs-title">conv_0</span>(<span class="hljs-title">x</span>), self.conv_x(<span class="hljs-title">x</span>), self.conv_y(<span class="hljs-title">x</span>)], dim=1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">DSConv</span>(<span class="hljs-title">nn</span>.<span class="hljs-type">Module</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">in_ch</span>, <span class="hljs-title">out_ch</span>, <span class="hljs-title">morph</span>, <span class="hljs-title">kernel_size</span>=3, <span class="hljs-title">if_offset</span>=<span class="hljs-type">True</span>, <span class="hljs-title">extend_scope</span>=1):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        <span class="hljs-type">The</span> <span class="hljs-type">Dynamic</span> <span class="hljs-type">Snake</span> <span class="hljs-type">Convolution</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        :param in_ch: input channel</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        :param out_ch: output channel</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        :param kernel_size: the size of kernel</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        :param extend_scope: the range to expand (<span class="hljs-title">default</span> 1 <span class="hljs-title">for</span> <span class="hljs-title">this</span> <span class="hljs-title">method</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        :param morph: the morphology of the convolution kernel is mainly divided into two types</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                        along the x-axis (0) and the y-axis (1) (<span class="hljs-title">see</span> <span class="hljs-title">the</span> <span class="hljs-title">paper</span> <span class="hljs-title">for</span> <span class="hljs-title">details</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        :param if_offset: whether deformation is required, if it is <span class="hljs-type">False</span>, it is the standard convolution kernel</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        super(<span class="hljs-type">DSConv</span>, <span class="hljs-title">self</span>).__init__()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # use the &lt;offset_conv&gt; to learn the deformable offset</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.offset_conv = nn.<span class="hljs-type">Conv2d</span>(<span class="hljs-title">in_ch</span>, 2 * <span class="hljs-title">kernel_size</span>, 3, <span class="hljs-title">padding</span>=1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.bn = nn.<span class="hljs-type">BatchNorm2d</span>(2 * <span class="hljs-title">kernel_size</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.kernel_size = kernel_size</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # two types of the <span class="hljs-type">DSConv</span> (<span class="hljs-title">along</span> <span class="hljs-title">x</span>-<span class="hljs-title">axis</span> <span class="hljs-title">and</span> <span class="hljs-title">y</span>-<span class="hljs-title">axis</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.dsc_conv_x = nn.<span class="hljs-type">Conv2d</span>(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-title">in_ch</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-title">out_ch</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-title">kernel_size</span>=(<span class="hljs-title">kernel_size</span>, 1),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            stride=(<span class="hljs-title">kernel_size</span>, 1),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            padding=0,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        )</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.dsc_conv_y = nn.<span class="hljs-type">Conv2d</span>(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-title">in_ch</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-title">out_ch</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-title">kernel_size</span>=(1, <span class="hljs-title">kernel_size</span>),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            stride=(1, <span class="hljs-title">kernel_size</span>),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            padding=0,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        )</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.gn = nn.<span class="hljs-type">GroupNorm</span>(<span class="hljs-title">out_ch</span> // 4, <span class="hljs-title">out_ch</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.act = <span class="hljs-type">Conv</span>.default_act</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.extend_scope = extend_scope</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.morph = morph</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.if_offset = if_offset</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward(<span class="hljs-title">self</span>, <span class="hljs-title">f</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        offset = self.offset_conv(<span class="hljs-title">f</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        offset = self.bn(<span class="hljs-title">offset</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # <span class="hljs-type">We</span> need a range of deformation between -1 and 1 to mimic the snake's swing</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        offset = torch.tanh(<span class="hljs-title">offset</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        input_shape = f.shape</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        dsc = <span class="hljs-type">DSC</span>(<span class="hljs-title">input_shape</span>, <span class="hljs-title">self</span>.<span class="hljs-title">kernel_size</span>, <span class="hljs-title">self</span>.<span class="hljs-title">extend_scope</span>, <span class="hljs-title">self</span>.<span class="hljs-title">morph</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        deformed_feature = dsc.deform_conv(<span class="hljs-title">f</span>, <span class="hljs-title">offset</span>, <span class="hljs-title">self</span>.<span class="hljs-title">if_offset</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        if self.morph == 0:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = self.dsc_conv_x(<span class="hljs-title">deformed_feature</span>.<span class="hljs-title">type</span>(<span class="hljs-title">f</span>.<span class="hljs-title">dtype</span>))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = self.gn(<span class="hljs-title">x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = self.act(<span class="hljs-title">x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            return x</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        else:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = self.dsc_conv_y(<span class="hljs-title">deformed_feature</span>.<span class="hljs-title">type</span>(<span class="hljs-title">f</span>.<span class="hljs-title">dtype</span>))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = self.gn(<span class="hljs-title">x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = self.act(<span class="hljs-title">x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            return x</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"># <span class="hljs-type">Core</span> code, for ease of understanding, we mark the dimensions of input and output next to the code</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">DSC</span>(<span class="hljs-title">object</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">input_shape</span>, <span class="hljs-title">kernel_size</span>, <span class="hljs-title">extend_scope</span>, <span class="hljs-title">morph</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.num_points = kernel_size</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.width = input_shape[2]</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.height = input_shape[3]</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.morph = morph</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.extend_scope = extend_scope  # offset (-1 ~ 1) * extend_scope</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # define feature map shape</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        <span class="hljs-type">B</span>: <span class="hljs-type">Batch</span> size  <span class="hljs-type">C</span>: <span class="hljs-type">Channel</span>  <span class="hljs-type">W</span>: <span class="hljs-type">Width</span>  <span class="hljs-type">H</span>: <span class="hljs-type">Height</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.num_batch = input_shape[0]</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.num_channels = input_shape[1]</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    input: offset [<span class="hljs-type">B</span>,2*<span class="hljs-type">K</span>,<span class="hljs-type">W</span>,<span class="hljs-type">H</span>]  <span class="hljs-type">K</span>: <span class="hljs-type">Kernel</span> size (2*<span class="hljs-type">K</span>: 2D <span class="hljs-title">image</span>, <span class="hljs-title">deformation</span> <span class="hljs-title">contains</span> &lt;<span class="hljs-title">x_offset</span>&gt; <span class="hljs-title">and</span> &lt;<span class="hljs-title">y_offset</span>&gt;)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    output_x: [<span class="hljs-type">B</span>,1,<span class="hljs-type">W</span>,<span class="hljs-type">K</span>*<span class="hljs-type">H</span>]   coordinate map</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    output_y: [<span class="hljs-type">B</span>,1,<span class="hljs-type">K</span>*<span class="hljs-type">W</span>,<span class="hljs-type">H</span>]   coordinate map</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def _coordinate_map_3D(<span class="hljs-title">self</span>, <span class="hljs-title">offset</span>, <span class="hljs-title">if_offset</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        device = offset.device</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # offset</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y_offset, x_offset = torch.split(<span class="hljs-title">offset</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, <span class="hljs-title">dim</span>=1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y_center = torch.arange(0, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>).repeat([<span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y_center = y_center.reshape(<span class="hljs-title">self</span>.<span class="hljs-title">height</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y_center = y_center.permute(1, 0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y_center = y_center.reshape([-1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y_center = y_center.repeat([<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, 1, 1]).float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y_center = y_center.unsqueeze(0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x_center = torch.arange(0, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>).repeat([<span class="hljs-title">self</span>.<span class="hljs-title">width</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x_center = x_center.reshape(<span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x_center = x_center.permute(0, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x_center = x_center.reshape([-1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x_center = x_center.repeat([<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, 1, 1]).float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x_center = x_center.unsqueeze(0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        if self.morph == 0:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-type">Initialize</span> the kernel and flatten the kernel</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                y: only need 0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                x: -num_points//2 ~ num_points//2 (<span class="hljs-type">Determined</span> <span class="hljs-title">by</span> <span class="hljs-title">the</span> <span class="hljs-title">kernel</span> <span class="hljs-title">size</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                !!! <span class="hljs-type">The</span> related <span class="hljs-type">PPT</span> will be submitted later, and the <span class="hljs-type">PPT</span> will contain the whole changes of each step</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y = torch.linspace(0, 0, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = torch.linspace(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                -<span class="hljs-title">int</span>(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> // 2),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                int(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> // 2),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                int(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            )</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y, x = torch.meshgrid(<span class="hljs-title">y</span>, <span class="hljs-title">x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_spread = y.reshape(-1, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_spread = x.reshape(-1, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_grid = y_spread.repeat([1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_grid = y_grid.reshape([<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_grid = y_grid.unsqueeze(0)  # [<span class="hljs-type">B</span>*<span class="hljs-type">K</span>*<span class="hljs-type">K</span>, <span class="hljs-type">W</span>,<span class="hljs-type">H</span>]</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_grid = x_spread.repeat([1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_grid = x_grid.reshape([<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_grid = x_grid.unsqueeze(0)  # [<span class="hljs-type">B</span>*<span class="hljs-type">K</span>*<span class="hljs-type">K</span>, <span class="hljs-type">W</span>,<span class="hljs-type">H</span>]</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_center + y_grid</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_center + x_grid</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.repeat(<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1, 1, 1).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.repeat(<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1, 1, 1).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_offset_new = y_offset.detach().clone()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            if if_offset:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                y_offset = y_offset.permute(1, 0, 2, 3)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                y_offset_new = y_offset_new.permute(1, 0, 2, 3)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                center = int(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> // 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                # <span class="hljs-type">The</span> center position remains unchanged and the rest of the positions begin to swing</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                # <span class="hljs-type">This</span> part is quite simple. <span class="hljs-type">The</span> main idea is that "offset is an iterative process"</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                y_offset_new[center] = 0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                for index in range(1, <span class="hljs-title">center</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                    y_offset_new[center + index] = (<span class="hljs-title">y_offset_new</span>[<span class="hljs-title">center</span> + <span class="hljs-title">index</span> - 1] + <span class="hljs-title">y_offset</span>[<span class="hljs-title">center</span> + <span class="hljs-title">index</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                    y_offset_new[center - index] = (<span class="hljs-title">y_offset_new</span>[<span class="hljs-title">center</span> - <span class="hljs-title">index</span> + 1] + <span class="hljs-title">y_offset</span>[<span class="hljs-title">center</span> - <span class="hljs-title">index</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                y_offset_new = y_offset_new.permute(1, 0, 2, 3).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                y_new = y_new.add(<span class="hljs-title">y_offset_new</span>.<span class="hljs-title">mul</span>(<span class="hljs-title">self</span>.<span class="hljs-title">extend_scope</span>))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.reshape(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                [<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, 1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.permute(0, 3, 1, 4, 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.reshape([</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> * <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, 1 * <span class="hljs-title">self</span>.<span class="hljs-title">height</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            ])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.reshape(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                [<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, 1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.permute(0, 3, 1, 4, 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.reshape([</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> * <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, 1 * <span class="hljs-title">self</span>.<span class="hljs-title">height</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            ])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            return y_new, x_new</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        else:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-type">Initialize</span> the kernel and flatten the kernel</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                y: -num_points//2 ~ num_points//2 (<span class="hljs-type">Determined</span> <span class="hljs-title">by</span> <span class="hljs-title">the</span> <span class="hljs-title">kernel</span> <span class="hljs-title">size</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                x: only need 0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y = torch.linspace(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                -<span class="hljs-title">int</span>(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> // 2),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                int(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> // 2),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                int(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>),</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            )</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x = torch.linspace(0, 0, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y, x = torch.meshgrid(<span class="hljs-title">y</span>, <span class="hljs-title">x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_spread = y.reshape(-1, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_spread = x.reshape(-1, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_grid = y_spread.repeat([1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_grid = y_grid.reshape([<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_grid = y_grid.unsqueeze(0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_grid = x_spread.repeat([1, <span class="hljs-title">self</span>.<span class="hljs-title">width</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_grid = x_grid.reshape([<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_grid = x_grid.unsqueeze(0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_center + y_grid</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_center + x_grid</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.repeat(<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1, 1, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.repeat(<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1, 1, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_offset_new = x_offset.detach().clone()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            if if_offset:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                x_offset = x_offset.permute(1, 0, 2, 3)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                x_offset_new = x_offset_new.permute(1, 0, 2, 3)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                center = int(<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> // 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                x_offset_new[center] = 0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                for index in range(1, <span class="hljs-title">center</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                    x_offset_new[center + index] = (<span class="hljs-title">x_offset_new</span>[<span class="hljs-title">center</span> + <span class="hljs-title">index</span> - 1] + <span class="hljs-title">x_offset</span>[<span class="hljs-title">center</span> + <span class="hljs-title">index</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                    x_offset_new[center - index] = (<span class="hljs-title">x_offset_new</span>[<span class="hljs-title">center</span> - <span class="hljs-title">index</span> + 1] + <span class="hljs-title">x_offset</span>[<span class="hljs-title">center</span> - <span class="hljs-title">index</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                x_offset_new = x_offset_new.permute(1, 0, 2, 3).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                x_new = x_new.add(<span class="hljs-title">x_offset_new</span>.<span class="hljs-title">mul</span>(<span class="hljs-title">self</span>.<span class="hljs-title">extend_scope</span>))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.reshape(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                [<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.permute(0, 3, 1, 4, 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            y_new = y_new.reshape([</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1 * <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            ])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.reshape(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                [<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.permute(0, 3, 1, 4, 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            x_new = x_new.reshape([</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, 1 * <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            ])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            return y_new, x_new</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="299"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="300"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="301"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    input: input feature map [<span class="hljs-type">N</span>,<span class="hljs-type">C</span>,<span class="hljs-type">D</span>,<span class="hljs-type">W</span>,<span class="hljs-type">H</span>]ï¼›coordinate map [<span class="hljs-type">N</span>,<span class="hljs-type">K</span>*<span class="hljs-type">D</span>,<span class="hljs-type">K</span>*<span class="hljs-type">W</span>,<span class="hljs-type">K</span>*<span class="hljs-type">H</span>] </span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="302"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    output: [<span class="hljs-type">N</span>,1,<span class="hljs-type">K</span>*<span class="hljs-type">D</span>,<span class="hljs-type">K</span>*<span class="hljs-type">W</span>,<span class="hljs-type">K</span>*<span class="hljs-type">H</span>]  deformed feature map</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="303"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    """</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="304"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def _bilinear_interpolate_3D(<span class="hljs-title">self</span>, <span class="hljs-title">input_feature</span>, <span class="hljs-title">y</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="305"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        device = input_feature.device</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="306"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y = y.reshape([-1]).float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="307"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x = x.reshape([-1]).float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="308"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="309"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        zero = torch.zeros([]).int()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="310"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        max_y = self.width - 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="311"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        max_x = self.height - 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="312"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="313"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # find 8 grid locations</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="314"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y0 = torch.floor(<span class="hljs-title">y</span>).int()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="315"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y1 = y0 + 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="316"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x0 = torch.floor(<span class="hljs-title">x</span>).int()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="317"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x1 = x0 + 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="318"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="319"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # clip out coordinates exceeding feature map volume</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="320"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y0 = torch.clamp(<span class="hljs-title">y0</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_y</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="321"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y1 = torch.clamp(<span class="hljs-title">y1</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_y</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="322"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x0 = torch.clamp(<span class="hljs-title">x0</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="323"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x1 = torch.clamp(<span class="hljs-title">x1</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="324"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="325"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        input_feature_flat = input_feature.flatten()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="326"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        input_feature_flat = input_feature_flat.reshape(</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="327"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            <span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>, <span class="hljs-title">self</span>.<span class="hljs-title">num_channels</span>, <span class="hljs-title">self</span>.<span class="hljs-title">width</span>, <span class="hljs-title">self</span>.<span class="hljs-title">height</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="328"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        input_feature_flat = input_feature_flat.permute(0, 2, 3, 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="329"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        input_feature_flat = input_feature_flat.reshape(-1, <span class="hljs-title">self</span>.<span class="hljs-title">num_channels</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="330"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        dimension = self.height * self.width</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="331"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="332"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        base = torch.arange(<span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>) * dimension</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="333"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        base = base.reshape([-1, 1]).float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="334"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="335"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        repeat = torch.ones([<span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> * <span class="hljs-title">self</span>.<span class="hljs-title">width</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="336"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                             ]).unsqueeze(0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="337"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        repeat = repeat.float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="338"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="339"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        base = torch.matmul(<span class="hljs-title">base</span>, <span class="hljs-title">repeat</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="340"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        base = base.reshape([-1])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="341"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="342"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        base = base.to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="343"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="344"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        base_y0 = base + y0 * self.height</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="345"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        base_y1 = base + y1 * self.height</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="346"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="347"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # top rectangle of the neighbourhood volume</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="348"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        index_a0 = base_y0 - base + x0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="349"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        index_c0 = base_y0 - base + x1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="350"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="351"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # bottom rectangle of the neighbourhood volume</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="352"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        index_a1 = base_y1 - base + x0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="353"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        index_c1 = base_y1 - base + x1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="354"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="355"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # get 8 grid values</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="356"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        value_a0 = input_feature_flat[index_a0.type(<span class="hljs-title">torch</span>.<span class="hljs-title">int64</span>)].to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="357"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        value_c0 = input_feature_flat[index_c0.type(<span class="hljs-title">torch</span>.<span class="hljs-title">int64</span>)].to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="358"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        value_a1 = input_feature_flat[index_a1.type(<span class="hljs-title">torch</span>.<span class="hljs-title">int64</span>)].to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="359"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        value_c1 = input_feature_flat[index_c1.type(<span class="hljs-title">torch</span>.<span class="hljs-title">int64</span>)].to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="360"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="361"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # find 8 grid locations</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="362"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y0 = torch.floor(<span class="hljs-title">y</span>).int()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="363"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y1 = y0 + 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="364"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x0 = torch.floor(<span class="hljs-title">x</span>).int()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="365"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x1 = x0 + 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="366"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="367"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        # clip out coordinates exceeding feature map volume</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="368"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y0 = torch.clamp(<span class="hljs-title">y0</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_y</span> + 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="369"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y1 = torch.clamp(<span class="hljs-title">y1</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_y</span> + 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="370"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x0 = torch.clamp(<span class="hljs-title">x0</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_x</span> + 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="371"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x1 = torch.clamp(<span class="hljs-title">x1</span>, <span class="hljs-title">zero</span>, <span class="hljs-title">max_x</span> + 1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="372"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="373"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x0_float = x0.float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="374"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        x1_float = x1.float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="375"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y0_float = y0.float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="376"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y1_float = y1.float()</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="377"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="378"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        vol_a0 = ((<span class="hljs-title">y1_float</span> - <span class="hljs-title">y</span>) * (<span class="hljs-title">x1_float</span> - <span class="hljs-title">x</span>)).unsqueeze(-1).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="379"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        vol_c0 = ((<span class="hljs-title">y1_float</span> - <span class="hljs-title">y</span>) * (<span class="hljs-title">x</span> - <span class="hljs-title">x0_float</span>)).unsqueeze(-1).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="380"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        vol_a1 = ((<span class="hljs-title">y</span> - <span class="hljs-title">y0_float</span>) * (<span class="hljs-title">x1_float</span> - <span class="hljs-title">x</span>)).unsqueeze(-1).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="381"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        vol_c1 = ((<span class="hljs-title">y</span> - <span class="hljs-title">y0_float</span>) * (<span class="hljs-title">x</span> - <span class="hljs-title">x0_float</span>)).unsqueeze(-1).to(<span class="hljs-title">device</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="382"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="383"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        outputs = (<span class="hljs-title">value_a0</span> * <span class="hljs-title">vol_a0</span> + <span class="hljs-title">value_c0</span> * <span class="hljs-title">vol_c0</span> + <span class="hljs-title">value_a1</span> * <span class="hljs-title">vol_a1</span> +</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="384"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                   <span class="hljs-title">value_c1</span> * <span class="hljs-title">vol_c1</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="385"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="386"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        if self.morph == 0:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="387"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            outputs = outputs.reshape([</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="388"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="389"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> * <span class="hljs-title">self</span>.<span class="hljs-title">width</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="390"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                1 * <span class="hljs-title">self</span>.<span class="hljs-title">height</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="391"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_channels</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="392"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            ])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="393"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            outputs = outputs.permute(0, 3, 1, 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="394"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        else:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="395"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            outputs = outputs.reshape([</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="396"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_batch</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="397"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                1 * <span class="hljs-title">self</span>.<span class="hljs-title">width</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="398"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_points</span> * <span class="hljs-title">self</span>.<span class="hljs-title">height</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="399"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">                <span class="hljs-title">self</span>.<span class="hljs-title">num_channels</span>,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="400"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            ])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="401"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">            outputs = outputs.permute(0, 3, 1, 2)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="402"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return outputs</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="403"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="404"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def deform_conv(<span class="hljs-title">self</span>, <span class="hljs-title">input</span>, <span class="hljs-title">offset</span>, <span class="hljs-title">if_offset</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="405"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        y, x = self._coordinate_map_3D(<span class="hljs-title">offset</span>, <span class="hljs-title">if_offset</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="406"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        deformed_feature = self._bilinear_interpolate_3D(<span class="hljs-title">input</span>, <span class="hljs-title">y</span>, <span class="hljs-title">x</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="407"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return deformed_feature</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="408"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="409"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="410"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Bottleneck_DySnakeConv</span>(<span class="hljs-type">Bottleneck</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="411"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    """<span class="hljs-type">Standard</span> bottleneck with <span class="hljs-type">DySnakeConv</span>."""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="412"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="413"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">shortcut</span>=<span class="hljs-type">True</span>, <span class="hljs-title">g</span>=1, <span class="hljs-title">k</span>=(3, 3), e=0.5):  # ch_in, ch_out, shortcut, groups, kernels, expand</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="414"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        super().__init__(<span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">shortcut</span>, <span class="hljs-title">g</span>, <span class="hljs-title">k</span>, <span class="hljs-title">e</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="415"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        c_ = int(<span class="hljs-title">c2</span> * <span class="hljs-title">e</span>)  # hidden channels</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="416"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.cv2 = <span class="hljs-type">DySnakeConv</span>(<span class="hljs-title">c_</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">k</span>[1])</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="417"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.cv3 = <span class="hljs-type">Conv</span>(<span class="hljs-title">c2</span> * 3, <span class="hljs-title">c2</span>, <span class="hljs-title">k</span>=1)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="418"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="419"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def forward(<span class="hljs-title">self</span>, <span class="hljs-title">x</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="420"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        """'forward()' applies the <span class="hljs-type">YOLOv5</span> <span class="hljs-type">FPN</span> to input data."""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="421"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        return x + self.cv3(<span class="hljs-title">self</span>.<span class="hljs-title">cv2</span>(<span class="hljs-title">self</span>.<span class="hljs-title">cv1</span>(<span class="hljs-title">x</span>))) if self.add else self.cv3(<span class="hljs-title">self</span>.<span class="hljs-title">cv2</span>(<span class="hljs-title">self</span>.<span class="hljs-title">cv1</span>(<span class="hljs-title">x</span>)))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="422"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="423"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="424"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">C2f_DySnakeConv</span>(<span class="hljs-type">C2f</span>):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="425"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">    def __init__(<span class="hljs-title">self</span>, <span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">n</span>=1, <span class="hljs-title">shortcut</span>=<span class="hljs-type">False</span>, <span class="hljs-title">g</span>=1, <span class="hljs-title">e</span>=0.5):</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="426"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        super().__init__(<span class="hljs-title">c1</span>, <span class="hljs-title">c2</span>, <span class="hljs-title">n</span>, <span class="hljs-title">shortcut</span>, <span class="hljs-title">g</span>, <span class="hljs-title">e</span>)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="427"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-class">        self.m = nn.<span class="hljs-type">ModuleList</span>(<span class="hljs-type">Bottleneck_DySnakeConv</span>(<span class="hljs-title">self</span>.<span class="hljs-title">c</span>, <span class="hljs-title">self</span>.<span class="hljs-title">c</span>, <span class="hljs-title">shortcut</span>, <span class="hljs-title">g</span>, <span class="hljs-title">k</span>=(3, 3), e=1.0) for _ in range(<span class="hljs-title">n</span>))</span></div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t3"></a>2.2 æ³¨å†Œultralytics/nn/tasks.py</h3> 
<pre data-index="1">C2f_DySnakeConvæ³¨å†Œ</pre> 
<pre data-index="2"><code class="hljs language-cobol"><span class="hljs-keyword">from</span> ultralytics.nn.Conv.<span class="hljs-keyword">dynamic</span>_snake_conv import C<span class="hljs-number">2</span>f_DySnakeConv</code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<p>ä¿®æ”¹def parse_model(d, ch, verbose=True): # model_dict, input_channels(3)</p> 
<pre data-index="3"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1170px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (Classify, Conv, ConvTranspose, GhostConv, Bottleneck, GhostBottleneck, SPP, SPPF, DWConv, Focus,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 BottleneckCSP, C<span class="hljs-number">1</span>, C<span class="hljs-number">2</span>, C<span class="hljs-number">2</span>f, C<span class="hljs-number">3</span>, C<span class="hljs-number">3</span>TR, C<span class="hljs-number">3</span>Ghost, nn.ConvTranspose<span class="hljs-number">2</span>d, DWConvTranspose<span class="hljs-number">2</span>d, C<span class="hljs-number">3</span>x, C<span class="hljs-number">2</span>f_KW,C<span class="hljs-number">2</span>f_DySnakeConv</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 ):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>[f], args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> !<span class="hljs-operator">=</span> nc:  # <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">equal</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes (i.e. <span class="hljs-keyword">for</span> Classify() <span class="hljs-keyword">output</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> make_divisible(min(c<span class="hljs-number">2</span>, max_channels) <span class="hljs-operator">*</span> width, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, <span class="hljs-operator">*</span>args[<span class="hljs-number">1</span>:]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (BottleneckCSP, C<span class="hljs-number">1</span>, C<span class="hljs-number">2</span>, C<span class="hljs-number">2</span>f, C<span class="hljs-number">3</span>, C<span class="hljs-number">3</span>TR, C<span class="hljs-number">3</span>Ghost, C<span class="hljs-number">3</span>x,C<span class="hljs-number">2</span>f_DySnakeConv):</div></div></li></ol></code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t4"></a>2.3&nbsp;yolov8_C2f-DySnakeConv.yaml</h3> 
<pre data-index="4" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1052px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Ultralytics YOLO ğŸš€, AGPL-<span class="hljs-number">3.0</span> license</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8</span> <span class="hljs-keyword">object</span> detection model <span class="hljs-keyword">with</span> P<span class="hljs-number">3</span>-P<span class="hljs-number">5</span> outputs. <span class="hljs-keyword">For</span> <span class="hljs-keyword">Usage</span> examples see https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>docs.ultralytics.com<span class="hljs-operator">/</span>tasks<span class="hljs-operator">/</span>detect</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Parameters</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">nc: <span class="hljs-number">80</span>  # <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">scales: # model compound scaling constants, i.e. <span class="hljs-string">'model=yolov8n.yaml'</span> will <span class="hljs-keyword">call</span> yolov<span class="hljs-number">8</span>.yaml <span class="hljs-keyword">with</span> scale <span class="hljs-string">'n'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [depth, width, max_channels]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  n: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>n summary: <span class="hljs-number">225</span> layers,  <span class="hljs-number">3157200</span> parameters,  <span class="hljs-number">3157184</span> gradients,   <span class="hljs-number">8.9</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  s: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.50</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>s summary: <span class="hljs-number">225</span> layers, <span class="hljs-number">11166560</span> parameters, <span class="hljs-number">11166544</span> gradients,  <span class="hljs-number">28.8</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  m: [<span class="hljs-number">0.67</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">768</span>]   # YOLOv<span class="hljs-number">8</span>m summary: <span class="hljs-number">295</span> layers, <span class="hljs-number">25902640</span> parameters, <span class="hljs-number">25902624</span> gradients,  <span class="hljs-number">79.3</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  l: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>l summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">43691520</span> parameters, <span class="hljs-number">43691504</span> gradients, <span class="hljs-number">165.7</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  x: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>x summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">68229648</span> parameters, <span class="hljs-number">68229632</span> gradients, <span class="hljs-number">258.5</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n backbone</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">backbone:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [<span class="hljs-keyword">from</span>, repeats, module, args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">0</span>-P<span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">1</span>-P<span class="hljs-number">2</span><span class="hljs-operator">/</span><span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">128</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">3</span>-P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">5</span>-P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">7</span>-P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, SPPF, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]]  # <span class="hljs-number">9</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n head</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">head:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">12</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f_DySnakeConv, [<span class="hljs-number">256</span>]]  # <span class="hljs-number">15</span> (P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span>-small)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">12</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f_DySnakeConv, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">18</span> (P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span>-medium)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">9</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f_DySnakeConv, [<span class="hljs-number">1024</span>]]  # <span class="hljs-number">21</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>], <span class="hljs-number">1</span>, Detect, [nc]]  # Detect(P<span class="hljs-number">3</span>, P<span class="hljs-number">4</span>, P<span class="hljs-number">5</span>)</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<h2><a name="t5"></a></h2>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/132689577&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>