<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-044f2cf1dc.css">
                <div id="content_views" class="htmledit_views">
                    <p>&nbsp;💡💡💡<strong>本文独家改进：<span style="color:#fe2c24;">Inner-IoU引入尺度因子&nbsp;ratio&nbsp;控制辅助边框的尺度大小用于计算损失，并与现有的基于&nbsp;IoU （&nbsp;GIoU, DIoU,&nbsp; CIoU，SIoU&nbsp;）损失进行有效结合</span></strong></p> 
<p>推荐指数：5颗星&nbsp; &nbsp; &nbsp; &nbsp; 新颖指数：5颗星</p> 
<p>💡💡💡Yolov8魔术师，独家首发创新（原创），适用于Yolov5、Yolov7、Yolov8等各个Yolo系列，专栏文章提供每一步步骤和源码，轻松带你上手魔改网络</p> 
<p>💡💡💡重点：通过本专栏的阅读，后续你也可以自己魔改网络，在网络不同位置（Backbone、head、detect、loss等）进行魔改，实现创新！！！</p> 
<p>专栏介绍：</p> 
<p>https://blog.csdn.net/m0_63774211/category_12289773.html</p> 
<p>✨✨✨原创魔改网络、复现前沿论文，组合优化创新</p> 
<p>🚀🚀🚀小目标、遮挡物、难样本性能提升</p> 
<p>🍉🍉🍉持续更新中，定期更新不同数据集涨点情况<br> &nbsp;</p> 
<h2><a name="t0"></a>1.&nbsp;<strong>Inner-IoU介绍</strong></h2> 
<p><img alt="" height="191" src="https://img-blog.csdnimg.cn/231da9c76a4d4ee4a72a8c6517e70723.png" width="1032"></p> 
<p>论文：<a href="https://arxiv.org/pdf/2311.02877.pdf" title="https://arxiv.org/pdf/2311.02877.pdf">https://arxiv.org/pdf/2311.02877.pdf</a>&nbsp;</p> 
<p></p> 
<p>摘要：随着检测器的迅速发展<strong>,&nbsp;</strong>边框回归取得了巨大的进步。然而，现有的基于&nbsp;<strong>IoU&nbsp;</strong>的边框回归仍聚焦在通过加入新的损失项来加速收敛，忽视&nbsp;<strong>IoU&nbsp;</strong>损失项其自身的限制。尽管理论上&nbsp;<strong>IoU&nbsp;</strong>损失能够有效描述边框回归状态，在实际应用中，它无法根据不同检测器与检测任务进行自我调整，不具有很强的泛化性。基于以上，我们首先分析了&nbsp;<strong>BBR&nbsp;</strong>模式，得出结论在回归过程区分不同回归样本并且使用不同尺度的辅助边框计算损失能够有效加速边框回归过程。对于高&nbsp;<strong>IoU&nbsp;</strong>样本，使用较小的辅助边框计算损失能够加速收敛，而较大辅助边框适用于低&nbsp;<strong>IoU&nbsp;</strong>样本。接着，我们提出了&nbsp;<strong>Inner-IoU Loss,&nbsp;</strong>其通过辅助边框计算&nbsp;<strong>IoU&nbsp;</strong>损失。针对不同的数据集与检测器，我们引入尺度因子&nbsp;<strong>ratio&nbsp;</strong>控制辅助边框的尺度大小用于计算损失。最后，将&nbsp;<strong>Inner-IoU&nbsp;</strong>集成至现有的基于&nbsp;<strong>IoU&nbsp;</strong>损失函数中进行仿真实验与对比实验。实验结果表明在使用本文所提出方法后检测效果得到进一步提升，验证了本文方法的有效性以及泛化能力。</p> 
<p>IoU损失函数在计算机视觉任务中有广泛的应用。在边界框回归过程中，不仅可以评估回归状态，还可以通过计算回归损失来加速收敛。在这里，作者讨论IoU变化与边界框大小之间的关系，分析边界框回归问题的本质特征，并解释本文提出方法的可行性。</p> 
<p><img alt="" height="439" src="https://img-blog.csdnimg.cn/2eb72e2ada0f40c0afae3dcaa2250633.png" width="697"></p> 
<p>为弥补现有IoU损失函数在不同的检测任务中的泛化能力较弱且收敛速度较慢的不足，作者提出使用辅助边界框计算损失以加速边界框回归过程。在Inner-IoU中，作者引入了尺度因子比，可以控制辅助边界框的尺度大小。通过为不同数据集和检测器使用不同尺度的辅助边界框，可以克服现有方法在泛化能力方面的局限。</p> 
<p><img alt="" height="551" src="https://img-blog.csdnimg.cn/0ffdad3a3e05456aa70d7fe5c3f5ea5e.png" width="810"></p> 
<p>&nbsp;<img alt="" height="478" src="https://img-blog.csdnimg.cn/640be176afb54d64aaec196dc9bdaf65.png" width="672"></p> 
<p>&nbsp;图8.a, 8.b和8.c 为<a href="https://so.csdn.net/so/search?q=CIoU&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=CIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;CIoU\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=CIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;CIoU\&quot;}&quot;}" data-tit="CIoU" data-pretit="ciou">CIoU</a> and Inner-CIoU的训练过程曲线图，三张图分别对应ratio 为0.7, 0.75, and 0.8。图8.d, 图8.e和 图8.f 为ratio 分别为0.7, 0.75, and 0.8时,SIoU and Inner-SIoU的训练过程曲线图。在以上图中，橙色曲线代表本文方法，现有方法用绿色曲线表示。不难看出在训练过程中50至150 epochs 本文方法优于现有的方法。<br> &nbsp;</p> 
<p>&nbsp;<img alt="" height="685" src="https://img-blog.csdnimg.cn/deed551516d8418eb244e6a017e7e02e.png" width="1150"></p> 
<p>&nbsp;&nbsp;&nbsp;测试集对比实验结果如表1所示。可以看出，应用本文方法后，检测效果有所提高，AP50和mAP50:95提高了0.5%以上。图6和图7是检测样本的对比图。<strong>从图中可以看出，与现有方法相比，所提出的方法定位更准确，误检和漏检更少。</strong>&nbsp;</p> 
<p><img alt="" height="721" src="https://img-blog.csdnimg.cn/cb2a530459f74b6f906eef447045937a.png" width="1200">&nbsp;原理可参考作者博客：</p> 
<p><a href="https://blog.csdn.net/qq_45911380/article/details/134320866" title="作者导读：Inner-IoU：基于辅助边框的IoU损失-CSDN博客">作者导读：Inner-IoU：基于辅助边框的IoU损失-CSDN博客</a></p> 
<h2><a name="t1"></a>2.&nbsp;&nbsp;<strong>Inner-IoU加入YOLOv8</strong></h2> 
<h3><a name="t2"></a>2.1&nbsp;&nbsp;&nbsp;Inner-IoU加入ultralytics/utils/metrics.py</h3> 
<p>&nbsp;bbox_inner_iou结合各个IOU实现</p> 
<pre data-index="0" class="set-code-show" name="code"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> ultralytics.<span class="hljs-property">utils</span> <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">LOGGER</span>, <span class="hljs-title class_">SimpleClass</span>, <span class="hljs-title class_">TryExcept</span>, plt_settings,ops</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<pre data-index="1" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1111px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> xywh:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ops.xyxy<span class="hljs-number">2</span>xywh(box<span class="hljs-number">1</span>), ops.xyxy<span class="hljs-number">2</span>xywh(box<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>(w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> (w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>(h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> (h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio <span class="hljs-operator">*</span> ratio <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio <span class="hljs-operator">*</span> ratio<span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> inter <span class="hljs-operator">/</span> union</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def bbox_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, GIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, DIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, EIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, SIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Calculate Intersection over Union (IoU) of box1(1, 4) to box2(n, 4).</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        box1 (torch.Tensor): A tensor representing a single bounding box with shape (1, 4).</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        box2 (torch.Tensor): A tensor representing n bounding boxes with shape (n, 4).</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        xywh (bool, optional): If True, input boxes are in (x, y, w, h) format. If False, input boxes are in</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">                               (x1, y1, x2, y2) format. Defaults to True.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        GIoU (bool, optional): If True, calculate Generalized IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        DIoU (bool, optional): If True, calculate Distance IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        CIoU (bool, optional): If True, calculate Complete IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        EIoU (bool, optional): If True, calculate Efficient IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        SIoU (bool, optional): If True, calculate Scylla IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        eps (float, optional): A small value to avoid division by zero. Defaults to 1e-7.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Returns:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        (torch.Tensor): IoU, GIoU, DIoU, or CIoU values depending on the specified flags.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Get</span> the coordinates <span class="hljs-keyword">of</span> bounding boxes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> xywh:  # transform <span class="hljs-keyword">from</span> xywh <span class="hljs-keyword">to</span> xyxy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>_, h<span class="hljs-number">1</span>_, w<span class="hljs-number">2</span>_, h<span class="hljs-number">2</span>_ <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">1</span>_, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> h<span class="hljs-number">1</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>_, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> h<span class="hljs-number">2</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:  # x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    innner_iou <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span>xywh, ratio<span class="hljs-operator">=</span>ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span><span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou <span class="hljs-operator">=</span> inter <span class="hljs-operator">/</span> union</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> GIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cw <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)  # convex (smallest enclosing box) width</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)  # convex height</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU:  # Distance <span class="hljs-keyword">or</span> Complete IoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>abs<span class="hljs-operator">/</span><span class="hljs-number">1911.08287</span>v<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps  # convex diagonal squared</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            rho<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span> <span class="hljs-number">4</span>  # center dist <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> CIoU:  # https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>github.com<span class="hljs-operator">/</span>Zzh-tju<span class="hljs-operator">/</span>DIoU-SSD-pytorch<span class="hljs-operator">/</span>blob<span class="hljs-operator">/</span>master<span class="hljs-operator">/</span>utils<span class="hljs-operator">/</span>box<span class="hljs-operator">/</span>box_utils.py#L<span class="hljs-number">47</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                v <span class="hljs-operator">=</span> (<span class="hljs-number">4</span> <span class="hljs-operator">/</span> math.pi <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">*</span> (torch.atan(w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> h<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>torch.atan(w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> h<span class="hljs-number">1</span>)).pow(<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">with</span> torch.<span class="hljs-keyword">no</span>_grad():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    alpha <span class="hljs-operator">=</span> v <span class="hljs-operator">/</span> (v<span class="hljs-operator"> - </span>iou <span class="hljs-operator">+</span> (<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> v <span class="hljs-operator">*</span> alpha)  # CIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif EIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_w<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                cw<span class="hljs-number">2</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">ch</span><span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>) # EIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif SIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                # SIoU Loss https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">2205.12740</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_cw <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sigma <span class="hljs-operator">=</span> torch.pow(s_cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">=</span> torch.abs(s_cw) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.abs(s_<span class="hljs-keyword">ch</span>) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                threshold <span class="hljs-operator">=</span> pow(<span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha <span class="hljs-operator">=</span> torch.where(sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">&gt;</span> threshold, sin_alpha_<span class="hljs-number">2</span>, sin_alpha_<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                angle_cost <span class="hljs-operator">=</span> torch.cos(torch.arcsin(sin_alpha) <span class="hljs-operator">*</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>math.pi <span class="hljs-operator">/</span> <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_x <span class="hljs-operator">=</span> (s_cw <span class="hljs-operator">/</span> cw) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_y <span class="hljs-operator">=</span> (s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                gamma <span class="hljs-operator">=</span> angle_cost<span class="hljs-operator"> - </span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                distance_cost <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_x)<span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_w <span class="hljs-operator">=</span> torch.abs(w<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(w<span class="hljs-number">1</span>, w<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_h <span class="hljs-operator">=</span> torch.abs(h<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(h<span class="hljs-number">1</span>, h<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                shape_cost <span class="hljs-operator">=</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_w), <span class="hljs-number">4</span>) <span class="hljs-operator">+</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_h), <span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span><span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> (distance_cost <span class="hljs-operator">+</span> shape_cost) <span class="hljs-operator">+</span> eps # SIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>  # DIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        c_<span class="hljs-keyword">area</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">*</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">+</span> eps  # convex <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>(c_<span class="hljs-keyword">area</span><span class="hljs-operator"> - </span>union) <span class="hljs-operator">/</span> c_<span class="hljs-keyword">area</span>  # GIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">1902.09630</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> innner_iou  # IoU</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3 style="background-color:transparent;"><a name="t3"></a>2.2&nbsp;修改ultralytics/utils/loss.py</h3> 
<p>1）bbox_inner_iou进行定义</p> 
<pre data-index="2" class="set-code-show" name="code"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> .<span class="hljs-property">metrics</span> <span class="hljs-keyword">import</span> bbox_iou, bbox_inner_iou</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>2）修改class BboxLoss(nn.Module):</p> 
<pre data-index="3" class="set-code-show" name="code"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span> bbox_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改为</p> 
<pre data-index="4" class="set-code-show" name="code"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span> bbox_inner_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>)</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/134417670&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>