<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <p><span style="color:#fe2c24;"><strong>性能比较</strong></span></p> 
<div class="table-box"><table cellspacing="0" style="width:369pt;"><tbody><tr><td style="vertical-align:bottom;width:165pt;"></td><td style="vertical-align:bottom;width:41pt;"><span style="color:#000000;">layers</span></td><td style="vertical-align:bottom;width:71pt;"><span style="color:#000000;">&nbsp;parameters</span></td><td style="vertical-align:bottom;width:51pt;"><span style="color:#000000;">GFLOPs</span></td><td style="vertical-align:bottom;width:41pt;"><span style="color:#000000;">kb</span></td></tr><tr><td style="vertical-align:bottom;"><span style="color:#000000;">YOLOv8s</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">168</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">11125971</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">28.4</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">21991</span></td></tr><tr><td style="vertical-align:bottom;"><span style="color:#000000;">yolov8_C2f_repghosts</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">352</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">2589699</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">7</span></td><td style="vertical-align:bottom;"><span style="color:#000000;">5341</span></td></tr></tbody></table></div> 
<p></p> 
<p>&nbsp;💡💡💡<span style="color:#956fe7;">本文独家改进：RepGhost，通过重参数化实现硬件高效的Ghost模块，性能优于GhostNet、MobileNetV3等，在移动设备上具有更少的参数和可比的延迟。</span></p> 
<p><span style="color:#fe2c24;"><strong>RepGhost和C2f结合&nbsp; |&nbsp; &nbsp;轻量化的同时在数据集并有小幅涨点；</strong></span></p> 
<p>💡💡💡<span style="color:#4da8ee;">Yolov8魔术师，独家首发创新（原创），适用于Yolov5、Yolov7、Yolov8等各个Yolo系列，专栏文章提供每一步步骤和源码，轻松带你上手魔改网络</span></p> 
<p>💡💡💡<span style="color:#38d8f0;">重点：通过本专栏的阅读，后续你也可以自己魔改网络，在网络不同位置（Backbone、head、detect、loss等）进行魔改，实现创新！！！</span></p> 
<p><span style="color:#fe2c24;">专栏介绍：</span></p> 
<p>✨✨✨<span style="color:#ff9900;"><strong>原创魔改网络、复现前沿论文，组合优化创新</strong></span></p> 
<p>🚀🚀🚀<span style="color:#a2e043;">小目标、遮挡物、难样本性能提升</span></p> 
<p>🍉🍉🍉持<span style="color:#956fe7;">续更新中，定期更新不同数据集涨点情况</span></p> 
<h2><a name="t0"></a>&nbsp;1.RepGhost介绍</h2> 
<p><img alt="" height="194" src="https://img-blog.csdnimg.cn/0721d2400bc04b0985044ea64b6a6215.png" width="849"></p> 
<p>论文：<a href="https://arxiv.org/pdf/2211.06088.pdf" title="https://arxiv.org/pdf/2211.06088.pdf">https://arxiv.org/pdf/2211.06088.pdf</a>&nbsp;</p> 
<p></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;特征重用一直是轻量级卷积神经网络（CNN）设计中的关键技术。当前的方法通常利用级联运算符通过重用来自其他层的特征图来廉价地保持大通道数（从而大网络容量）。尽管级联是无参数和无FLOPs的，但其在硬件设备上的计算成本是不可忽略的。</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了解决这个问题，本文提供了一个通过结构重<a href="https://so.csdn.net/so/search?q=%E5%8F%82%E6%95%B0%E5%8C%96&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E5%8F%82%E6%95%B0%E5%8C%96&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;参数化\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E5%8F%82%E6%95%B0%E5%8C%96&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;参数化\&quot;}&quot;}" data-tit="参数化" data-pretit="参数化">参数化</a>技术实现特征重用的新视角。提出了一种新的硬件高效的RepGhost模块，用于通过重参数化实现隐式特征重用，而不是使用级联运算符。</p> 
<p><img alt="" height="727" src="https://img-blog.csdnimg.cn/1a1b82d255ae48adb6838a0b5e1cfdc4.png" width="839">&nbsp;图3.从Ghost模块到RepGhost模块的演变。我们省略了输入的1x1卷积，更多的结构细节请参见图4。dconv:深度卷积层（后跟BN)。Cat：连接层。a)带有ReLU的Ghost模块[14]；b)用添add替换concat；c)向后移动ReLU，使模块满足结构重新参数化的规则；d)训练过程中的RepGhost模块；e)推理过程中的RepGhost模块。模块c和模块d可以在推理过程中融合到模块e中。</p> 
<p><img alt="" height="751" src="https://img-blog.csdnimg.cn/24d47bad37234bc49e958fdf3ff4e0a5.png" width="934">&nbsp;图4：与Ghost bottleneck[14]相比。S Block：跳跃连接块，DS：下采样层，SE：SE块[21]。RG-block ：RepGhost bottleneck。虚线中的方块只在必要时插入。Cin、Cmid和Cout分别表示bottleneck的输入通道、中间通道和输出通道。请注意，这些被标记为红色的bottleneck，即RepGhost bottleneck不同于bottleneck内部通道中的Ghost bottleneck。</p> 
<p>&nbsp;<img alt="" height="655" src="https://img-blog.csdnimg.cn/5a5ecea67db04d36818231c95155decb.png" width="800"></p> 
<p></p> 
<p>&nbsp;基于ReppGhost模块，我们开发了我们<a href="https://so.csdn.net/so/search?q=%E9%AB%98%E6%95%88%E7%9A%84&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E9%AB%98%E6%95%88%E7%9A%84&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;高效的\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E9%AB%98%E6%95%88%E7%9A%84&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;高效的\&quot;}&quot;}" data-tit="高效的" data-pretit="高效的">高效的</a>RepGhost bottleneck 和RepGhostNet。</p> 
<p class="img-center"><img alt="" height="650" src="https://img-blog.csdnimg.cn/cb11ab532b5540f5a8a245c8449e268e.png" width="468"></p> 
<p>&nbsp;实验结果</p> 
<p>在ImageNet和COCO基准测试上的实验表明，在移动设备上，所提出的RepGhostNet比<a href="https://so.csdn.net/so/search?q=GhostNet&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=GhostNet&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;GhostNet\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=GhostNet&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;GhostNet\&quot;}&quot;}" data-tit="GhostNet" data-pretit="ghostnet">GhostNet</a>和MobileNetV3更有效和高效。特别是，我们的RepGhostNet在ImageNet数据集上以2.5%的准确率超过GhostNet 0.5倍，在基于ARM的手机上具有更少的参数和可比的延迟。</p> 
<p><img alt="" height="776" src="https://img-blog.csdnimg.cn/636d3e9139494db3a47cd2767f17b688.png" width="1005"></p> 
<h2><a name="t1"></a>&nbsp;2.Yolov8引入RepGhost</h2> 
<h3><a name="t2"></a>2.1&nbsp;加入ultralytics/nn/<a href="https://so.csdn.net/so/search?q=backbone&amp;spm=1001.2101.3001.7020" title="backbone">backbone</a>/repghost.py</h3> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln hundred" style="width:1083px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import <span class="hljs-keyword">copy</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import numpy <span class="hljs-keyword">as</span> np</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn <span class="hljs-keyword">as</span> nn</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn.functional <span class="hljs-keyword">as</span> F</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def _make_divisible(v, divisor, min_<span class="hljs-keyword">value</span><span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    This function is taken from the original tf repo.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    It ensures that all layers have a channel number that is divisible by 8 mg</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    It can be seen here:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    https://github.com/tensorflow/models/blob/master/research/slim/nets/mobilenet/mobilenet.py</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> min_<span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        min_<span class="hljs-keyword">value</span> <span class="hljs-operator">=</span> divisor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    new_v <span class="hljs-operator">=</span> max(min_<span class="hljs-keyword">value</span>, int(v <span class="hljs-operator">+</span> divisor <span class="hljs-operator">/</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> divisor <span class="hljs-operator">*</span> divisor)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Make sure that round <span class="hljs-keyword">down</span> does <span class="hljs-keyword">not</span> <span class="hljs-keyword">go</span> <span class="hljs-keyword">down</span> <span class="hljs-keyword">by</span> more <span class="hljs-keyword">than</span> <span class="hljs-number">10</span>%.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> new_v <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.9</span> <span class="hljs-operator">*</span> v:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        new_v <span class="hljs-operator">+</span><span class="hljs-operator">=</span> divisor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> new_v</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def hard_sigmoid(x, inplace: bool <span class="hljs-operator">=</span> <span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> inplace:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x.<span class="hljs-keyword">add</span>_(<span class="hljs-number">3.0</span>).clamp_(<span class="hljs-number">0.0</span>, <span class="hljs-number">6.0</span>).div_(<span class="hljs-number">6.0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> F.relu<span class="hljs-number">6</span>(x <span class="hljs-operator">+</span> <span class="hljs-number">3.0</span>) <span class="hljs-operator">/</span> <span class="hljs-number">6.0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SqueezeExcite(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">in</span>_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            se_ratio<span class="hljs-operator">=</span><span class="hljs-number">0.25</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reduced_base_chs<span class="hljs-operator">=</span>None,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # act_layer<span class="hljs-operator">=</span>nn.ReLU,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            act_layer<span class="hljs-operator">=</span>nn.SiLU,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            gate_fn<span class="hljs-operator">=</span>hard_sigmoid,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            divisor<span class="hljs-operator">=</span><span class="hljs-number">4</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-operator">**</span>_,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    ):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(SqueezeExcite, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.gate_fn <span class="hljs-operator">=</span> gate_fn</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        reduced_chs <span class="hljs-operator">=</span> _make_divisible(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (reduced_base_chs <span class="hljs-keyword">or</span> <span class="hljs-keyword">in</span>_chs) <span class="hljs-operator">*</span> se_ratio, divisor,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.avg_pool <span class="hljs-operator">=</span> nn.AdaptiveAvgPool<span class="hljs-number">2</span>d(<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv_reduce <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_chs, reduced_chs, <span class="hljs-number">1</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act<span class="hljs-number">1</span> <span class="hljs-operator">=</span> act_layer(inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv_expand <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(reduced_chs, <span class="hljs-keyword">in</span>_chs, <span class="hljs-number">1</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_se <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.avg_pool(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_se <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv_reduce(x_se)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_se <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.act<span class="hljs-number">1</span>(x_se)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x_se <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv_expand(x_se)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> x <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.gate_fn(x_se)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> ConvBnAct(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">in</span>_chs, out_chs, kernel_<span class="hljs-keyword">size</span>, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, act_layer<span class="hljs-operator">=</span>nn.SiLU):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(ConvBnAct, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">in</span>_chs, out_chs, kernel_<span class="hljs-keyword">size</span>, stride, kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.bn<span class="hljs-number">1</span> <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(out_chs)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act<span class="hljs-number">1</span> <span class="hljs-operator">=</span> act_layer(inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.bn<span class="hljs-number">1</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.act<span class="hljs-number">1</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RepGhostModule(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>, inp, oup, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>, dw_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">3</span>, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, relu<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, deploy<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, reparam_bn<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam_identity<span class="hljs-operator">=</span><span class="hljs-keyword">False</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    ):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(RepGhostModule, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        init_channels <span class="hljs-operator">=</span> oup</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        new_channels <span class="hljs-operator">=</span> oup</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.deploy <span class="hljs-operator">=</span> deploy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.primary_conv <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                inp, init_channels, kernel_<span class="hljs-keyword">size</span>, stride, kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            ),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            nn.BatchNorm<span class="hljs-number">2</span>d(init_channels),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            nn.SiLU(inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>) <span class="hljs-keyword">if</span> relu <span class="hljs-keyword">else</span> nn.<span class="hljs-keyword">Sequential</span>(),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        fusion_conv <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        fusion_bn <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> deploy <span class="hljs-keyword">and</span> reparam_bn:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            fusion_conv.append(nn.Identity())</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            fusion_bn.append(nn.BatchNorm<span class="hljs-number">2</span>d(init_channels))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> deploy <span class="hljs-keyword">and</span> reparam_identity:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            fusion_conv.append(nn.Identity())</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            fusion_bn.append(nn.Identity())</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fusion_conv <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(<span class="hljs-operator">*</span>fusion_conv)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fusion_bn <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(<span class="hljs-operator">*</span>fusion_bn)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cheap_operation <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                init_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                new_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                dw_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                dw_<span class="hljs-keyword">size</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                groups<span class="hljs-operator">=</span>init_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                bias<span class="hljs-operator">=</span>deploy,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            ),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            nn.BatchNorm<span class="hljs-number">2</span>d(new_channels) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> deploy <span class="hljs-keyword">else</span> nn.<span class="hljs-keyword">Sequential</span>(),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # nn.ReLU(inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>) <span class="hljs-keyword">if</span> relu <span class="hljs-keyword">else</span> nn.<span class="hljs-keyword">Sequential</span>(),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> deploy:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.cheap_operation <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> relu:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.relu <span class="hljs-operator">=</span> nn.SiLU(inplace<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.relu <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.primary_conv(x)  # mg</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.cheap_operation(x<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> conv, bn <span class="hljs-keyword">in</span> zip(<span class="hljs-keyword">self</span>.fusion_conv, <span class="hljs-keyword">self</span>.fusion_bn):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> bn(conv(x<span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.relu(x<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def <span class="hljs-keyword">get</span>_equivalent_kernel_bias(<span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span>, bias<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(<span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>], <span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> conv, bn <span class="hljs-keyword">in</span> zip(<span class="hljs-keyword">self</span>.fusion_conv, <span class="hljs-keyword">self</span>.fusion_bn):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel, bias <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(conv, bn, kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span>.shape[<span class="hljs-number">0</span>], kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span>.device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._pad_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>_<span class="hljs-keyword">to</span>_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_tensor(kernel)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            bias<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">+</span><span class="hljs-operator">=</span> bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span>, bias<span class="hljs-number">3</span>x<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    @staticmethod</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _pad_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>_<span class="hljs-keyword">to</span>_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_tensor(kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> torch.nn.functional.pad(kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    @staticmethod</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _fuse_bn_tensor(conv, bn, <span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span>None, device<span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">in</span>_channels <span class="hljs-operator">=</span> <span class="hljs-keyword">in</span>_channels <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span>_channels <span class="hljs-keyword">else</span> bn.running_mean.shape[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        device <span class="hljs-operator">=</span> device <span class="hljs-keyword">if</span> device <span class="hljs-keyword">else</span> bn.weight.device</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> isinstance(conv, nn.Conv<span class="hljs-number">2</span>d):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel <span class="hljs-operator">=</span> conv.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert conv.bias <span class="hljs-keyword">is</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert isinstance(conv, nn.Identity)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel_<span class="hljs-keyword">value</span> <span class="hljs-operator">=</span> np.<span class="hljs-literal">zeros</span>((<span class="hljs-keyword">in</span>_channels, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), dtype<span class="hljs-operator">=</span>np.float<span class="hljs-number">32</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-keyword">in</span>_channels):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                kernel_<span class="hljs-keyword">value</span>[i, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <span class="hljs-operator">=</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel <span class="hljs-operator">=</span> torch.<span class="hljs-keyword">from</span>_numpy(kernel_<span class="hljs-keyword">value</span>).<span class="hljs-keyword">to</span>(device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> isinstance(bn, nn.BatchNorm<span class="hljs-number">2</span>d):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_mean <span class="hljs-operator">=</span> bn.running_mean</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_var <span class="hljs-operator">=</span> bn.running_var</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            gamma <span class="hljs-operator">=</span> bn.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            beta <span class="hljs-operator">=</span> bn.bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            eps <span class="hljs-operator">=</span> bn.eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            std <span class="hljs-operator">=</span> (running_var <span class="hljs-operator">+</span> eps).sqrt()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            t <span class="hljs-operator">=</span> (gamma <span class="hljs-operator">/</span> std).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> kernel <span class="hljs-operator">*</span> t, beta<span class="hljs-operator"> - </span>running_mean <span class="hljs-operator">*</span> gamma <span class="hljs-operator">/</span> std</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert isinstance(bn, nn.Identity)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> kernel, torch.<span class="hljs-literal">zeros</span>(<span class="hljs-keyword">in</span>_channels).<span class="hljs-keyword">to</span>(kernel.device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def switch_<span class="hljs-keyword">to</span>_deploy(<span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> len(<span class="hljs-keyword">self</span>.fusion_conv) <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> len(<span class="hljs-keyword">self</span>.fusion_bn) <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel, bias <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">get</span>_equivalent_kernel_bias()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cheap_operation <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>].<span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         out_channels<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>].out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>].kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         padding<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>].padding,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         dilation<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>].dilation,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         groups<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.cheap_operation[<span class="hljs-number">0</span>].groups,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cheap_operation.weight.<span class="hljs-keyword">data</span> <span class="hljs-operator">=</span> kernel</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cheap_operation.bias.<span class="hljs-keyword">data</span> <span class="hljs-operator">=</span> bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'fusion_conv'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'fusion_bn'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fusion_conv <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fusion_bn <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.deploy <span class="hljs-operator">=</span> <span class="hljs-keyword">True</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RepGhostBottleneck(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string">"RepGhost bottleneck w/ optional SE"</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">in</span>_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            mid_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            out_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            dw_kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">3</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            se_ratio<span class="hljs-operator">=</span><span class="hljs-number">0.0</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            shortcut<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam_bn<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam_identity<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            deploy<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    ):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(RepGhostBottleneck, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        has_se <span class="hljs-operator">=</span> se_ratio <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None <span class="hljs-keyword">and</span> se_ratio <span class="hljs-operator">&gt;</span> <span class="hljs-number">0.0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">=</span> stride</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.enable_shortcut <span class="hljs-operator">=</span> shortcut</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_chs <span class="hljs-operator">=</span> <span class="hljs-keyword">in</span>_chs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.out_chs <span class="hljs-operator">=</span> out_chs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Point-wise expansion</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.ghost<span class="hljs-number">1</span> <span class="hljs-operator">=</span> RepGhostModule(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">in</span>_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            mid_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            relu<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam_bn<span class="hljs-operator">=</span>reparam <span class="hljs-keyword">and</span> reparam_bn,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam_identity<span class="hljs-operator">=</span>reparam <span class="hljs-keyword">and</span> reparam_identity,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            deploy<span class="hljs-operator">=</span>deploy,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Depth-wise convolution</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.conv_dw <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                mid_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                mid_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                dw_kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                padding<span class="hljs-operator">=</span>(dw_kernel_<span class="hljs-keyword">size</span><span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                groups<span class="hljs-operator">=</span>mid_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.bn_dw <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(mid_chs)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Squeeze-and-excitation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> has_se:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.se <span class="hljs-operator">=</span> SqueezeExcite(mid_chs, se_ratio<span class="hljs-operator">=</span>se_ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.se <span class="hljs-operator">=</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Point-wise linear projection</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.ghost<span class="hljs-number">2</span> <span class="hljs-operator">=</span> RepGhostModule(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            mid_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            out_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            relu<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam_bn<span class="hljs-operator">=</span>reparam <span class="hljs-keyword">and</span> reparam_bn,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            reparam_identity<span class="hljs-operator">=</span>reparam <span class="hljs-keyword">and</span> reparam_identity,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            deploy<span class="hljs-operator">=</span>deploy,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # shortcut</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">in</span>_chs <span class="hljs-operator">=</span><span class="hljs-operator">=</span> out_chs <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.shortcut <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.shortcut <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">in</span>_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">in</span>_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    dw_kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    padding<span class="hljs-operator">=</span>(dw_kernel_<span class="hljs-keyword">size</span><span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    groups<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_chs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                ),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                nn.BatchNorm<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_chs),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">in</span>_chs, out_chs, <span class="hljs-number">1</span>, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    padding<span class="hljs-operator">=</span><span class="hljs-number">0</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                ),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                nn.BatchNorm<span class="hljs-number">2</span>d(out_chs),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        residual <span class="hljs-operator">=</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.ghost<span class="hljs-number">1</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv_dw(x<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.bn_dw(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> x<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.se <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.se(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # <span class="hljs-number">2</span>nd repghost bottleneck mg</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.ghost<span class="hljs-number">2</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">self</span>.enable_shortcut <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_chs <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.out_chs <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.shortcut(residual)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="299"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def autopad(k, p<span class="hljs-operator">=</span>None, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>):  # kernel, padding, dilation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="300"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Pad <span class="hljs-keyword">to</span> <span class="hljs-string">'same'</span> shape outputs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="301"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> d <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="302"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k <span class="hljs-operator">=</span> d <span class="hljs-operator">*</span> (k<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [d <span class="hljs-operator">*</span> (x<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # actual kernel-size</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="303"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> p <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="304"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p <span class="hljs-operator">=</span> k <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [x <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # auto-pad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="305"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> p</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="306"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="307"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="308"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Conv(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="309"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Standard</span> convolution <span class="hljs-keyword">with</span> args(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_out, kernel, stride, padding, groups, dilation, activation)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="310"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">default</span>_act <span class="hljs-operator">=</span> nn.SiLU()  # <span class="hljs-keyword">default</span> activation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="311"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="312"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k<span class="hljs-operator">=</span><span class="hljs-number">1</span>, s<span class="hljs-operator">=</span><span class="hljs-number">1</span>, p<span class="hljs-operator">=</span>None, g<span class="hljs-operator">=</span><span class="hljs-number">1</span>, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="313"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="314"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k, s, autopad(k, p, d), groups<span class="hljs-operator">=</span>g, dilation<span class="hljs-operator">=</span>d, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="315"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.bn <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(c<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="316"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">default</span>_act <span class="hljs-keyword">if</span> act <span class="hljs-keyword">is</span> <span class="hljs-keyword">True</span> <span class="hljs-keyword">else</span> act <span class="hljs-keyword">if</span> isinstance(act, nn.Module) <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="317"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="318"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="319"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.bn(<span class="hljs-keyword">self</span>.conv(x)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="320"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="321"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward_fuse(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="322"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.conv(x))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="323"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="324"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="325"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> C<span class="hljs-number">2</span>f_repghost(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="326"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # CSP Bottleneck <span class="hljs-keyword">with</span> <span class="hljs-number">2</span> convolutions</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="327"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, n<span class="hljs-operator">=</span><span class="hljs-number">1</span>, shortcut<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, g<span class="hljs-operator">=</span><span class="hljs-number">1</span>, e<span class="hljs-operator">=</span><span class="hljs-number">0.5</span>):  # <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_out, <span class="hljs-keyword">number</span>, shortcut, groups, expansion</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="328"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="329"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.c <span class="hljs-operator">=</span> int(c<span class="hljs-number">2</span> <span class="hljs-operator">*</span> e)  # hidden channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="330"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span> <span class="hljs-operator">=</span> Conv(c<span class="hljs-number">1</span>, <span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.c, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="331"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">2</span> <span class="hljs-operator">=</span> Conv((<span class="hljs-number">2</span> <span class="hljs-operator">+</span> n) <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.c, c<span class="hljs-number">2</span>, <span class="hljs-number">1</span>)  #</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="332"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.m <span class="hljs-operator">=</span> nn.ModuleList(RepGhostBottleneck(<span class="hljs-keyword">self</span>.c, <span class="hljs-keyword">self</span>.c, <span class="hljs-keyword">self</span>.c, dw_kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>((<span class="hljs-number">3</span>), (<span class="hljs-number">3</span>))) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(n))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="333"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="334"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="335"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> list(<span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span>(x).split((<span class="hljs-keyword">self</span>.c, <span class="hljs-keyword">self</span>.c), <span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="336"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y.<span class="hljs-keyword">extend</span>(m(y[-<span class="hljs-number">1</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.m)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="337"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.cv<span class="hljs-number">2</span>(torch.cat(y, <span class="hljs-number">1</span>))</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t3"></a>&nbsp;2.2&nbsp;&nbsp;tasks.py注册</h3> 
<p><span style="color:#fe2c24;"><strong>加入C2f_repghost</strong></span></p> 
<pre data-index="1"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> ultralytics.<span class="hljs-property">nn</span>.<span class="hljs-property">backbone</span>.<span class="hljs-property">repghost</span> <span class="hljs-keyword">import</span> C2f_repghost</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改def parse_model(d, ch, verbose=True): # model_dict, input_channels(3)</p> 
<pre data-index="2"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1102px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (Classify, Conv, ConvTranspose, GhostConv, Bottleneck, GhostBottleneck, SPP, SPPF, DWConv, Focus,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 BottleneckCSP, C<span class="hljs-number">1</span>, C<span class="hljs-number">2</span>, C<span class="hljs-number">2</span>f, C<span class="hljs-number">3</span>, C<span class="hljs-number">3</span>TR, C<span class="hljs-number">3</span>Ghost, nn.ConvTranspose<span class="hljs-number">2</span>d, DWConvTranspose<span class="hljs-number">2</span>d, C<span class="hljs-number">3</span>x, C<span class="hljs-number">2</span>f_repghost):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>[f], args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> !<span class="hljs-operator">=</span> nc:  # <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">equal</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes (i.e. <span class="hljs-keyword">for</span> Classify() <span class="hljs-keyword">output</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> make_divisible(min(c<span class="hljs-number">2</span>, max_channels) <span class="hljs-operator">*</span> width, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, <span class="hljs-operator">*</span>args[<span class="hljs-number">1</span>:]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (BottleneckCSP, C<span class="hljs-number">1</span>, C<span class="hljs-number">2</span>, C<span class="hljs-number">2</span>f, C<span class="hljs-number">3</span>, C<span class="hljs-number">3</span>TR, C<span class="hljs-number">3</span>Ghost, C<span class="hljs-number">3</span>x,C<span class="hljs-number">2</span>f_repghost):</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t4"></a>2.3&nbsp;yolov8_C2f_repghost.yaml</h3> 
<pre data-index="3" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1052px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Ultralytics YOLO 🚀, GPL-<span class="hljs-number">3.0</span> license</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8</span> <span class="hljs-keyword">object</span> detection model <span class="hljs-keyword">with</span> P<span class="hljs-number">3</span>-P<span class="hljs-number">5</span> outputs. <span class="hljs-keyword">For</span> <span class="hljs-keyword">Usage</span> examples see https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>docs.ultralytics.com<span class="hljs-operator">/</span>tasks<span class="hljs-operator">/</span>detect</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Parameters</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">nc: <span class="hljs-number">4</span>  # <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">scales: # model compound scaling constants, i.e. <span class="hljs-string">'model=yolov8n.yaml'</span> will <span class="hljs-keyword">call</span> yolov<span class="hljs-number">8</span>.yaml <span class="hljs-keyword">with</span> scale <span class="hljs-string">'n'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [depth, width, max_channels]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  n: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>n summary: <span class="hljs-number">225</span> layers,  <span class="hljs-number">3157200</span> parameters,  <span class="hljs-number">3157184</span> gradients,   <span class="hljs-number">8.9</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  s: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.50</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>s summary: <span class="hljs-number">225</span> layers, <span class="hljs-number">11166560</span> parameters, <span class="hljs-number">11166544</span> gradients,  <span class="hljs-number">28.8</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  m: [<span class="hljs-number">0.67</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">768</span>]   # YOLOv<span class="hljs-number">8</span>m summary: <span class="hljs-number">295</span> layers, <span class="hljs-number">25902640</span> parameters, <span class="hljs-number">25902624</span> gradients,  <span class="hljs-number">79.3</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  l: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>l summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">43691520</span> parameters, <span class="hljs-number">43691504</span> gradients, <span class="hljs-number">165.7</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  x: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>x summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">68229648</span> parameters, <span class="hljs-number">68229632</span> gradients, <span class="hljs-number">258.5</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n backbone</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">backbone:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [<span class="hljs-keyword">from</span>, repeats, module, args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">0</span>-P<span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">1</span>-P<span class="hljs-number">2</span><span class="hljs-operator">/</span><span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f_repghost, [<span class="hljs-number">128</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">3</span>-P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f_repghost, [<span class="hljs-number">256</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">5</span>-P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f_repghost, [<span class="hljs-number">512</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">7</span>-P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f_repghost, [<span class="hljs-number">1024</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, SPPF, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]]  # <span class="hljs-number">9</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n head</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">head:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">12</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>]]  # <span class="hljs-number">15</span> (P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span>-small)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">12</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">18</span> (P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span>-medium)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">9</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>]]  # <span class="hljs-number">21</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>], <span class="hljs-number">1</span>, Detect, [nc]]  # Detect(P<span class="hljs-number">3</span>, P<span class="hljs-number">4</span>, P<span class="hljs-number">5</span>)</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/132022000&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>