<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-044f2cf1dc.css">
                <div id="content_views" class="htmledit_views">
                    <p>💡💡💡<strong>本文独家改进：<span style="color:#fe2c24;">Inner-IoU引入尺度因子&nbsp;ratio&nbsp;控制辅助边框的尺度大小用于计算损失，新型边界框相似度度量（MPDIoU）MPDIoU损失进行有效结合</span></strong></p> 
<p>推荐指数：5颗星&nbsp; &nbsp; &nbsp; &nbsp; 新颖指数：5颗星</p> 
<p>💡💡💡Yolov8魔术师，独家首发创新（原创），适用于<a href="https://so.csdn.net/so/search?q=Yolov5&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=Yolov5&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;Yolov5\&quot;}&quot;}" data-tit="Yolov5" data-pretit="yolov5">Yolov5</a>、Yolov7、Yolov8等各个Yolo系列，专栏文章提供每一步步骤和源码，轻松带你上手魔改网络</p> 
<p>💡💡💡重点：通过本专栏的阅读，后续你也可以自己魔改网络，在网络不同位置（Backbone、head、detect、loss等）进行魔改，实现创新！！！</p> 
<p>专栏介绍：</p> 
<p>https://blog.csdn.net/m0_63774211/category_12289773.html</p> 
<p>✨✨✨原创魔改网络、复现前沿论文，组合优化创新</p> 
<p>🚀🚀🚀小目标、遮挡物、难样本性能提升</p> 
<p>🍉🍉🍉持续更新中，定期更新不同数据集涨点情况<br> &nbsp;</p> 
<h2><a name="t0"></a>1.&nbsp;<strong>Inner-IoU介绍</strong></h2> 
<p><img alt="" height="191" src="https://img-blog.csdnimg.cn/231da9c76a4d4ee4a72a8c6517e70723.png" width="1032"></p> 
<p>论文：<a href="https://arxiv.org/pdf/2311.02877.pdf" title="https://arxiv.org/pdf/2311.02877.pdf">https://arxiv.org/pdf/2311.02877.pdf</a>&nbsp;</p> 
<p></p> 
<p>摘要：随着检测器的迅速发展<strong>,&nbsp;</strong>边框回归取得了巨大的进步。然而，现有的基于&nbsp;<strong>IoU&nbsp;</strong>的边框回归仍聚焦在通过加入新的损失项来加速收敛，忽视&nbsp;<strong>IoU&nbsp;</strong>损失项其自身的限制。尽管理论上&nbsp;<strong>IoU&nbsp;</strong>损失能够有效描述边框回归状态，在实际应用中，它无法根据不同检测器与检测任务进行自我调整，不具有很强的泛化性。基于以上，我们首先分析了&nbsp;<strong>BBR&nbsp;</strong>模式，得出结论在回归过程区分不同回归样本并且使用不同尺度的辅助边框计算损失能够有效加速边框回归过程。对于高&nbsp;<strong>IoU&nbsp;</strong>样本，使用较小的辅助边框计算损失能够加速收敛，而较大辅助边框适用于低&nbsp;<strong>IoU&nbsp;</strong>样本。接着，我们提出了&nbsp;<strong>Inner-IoU Loss,&nbsp;</strong>其通过辅助边框计算&nbsp;<strong>IoU&nbsp;</strong>损失。针对不同的数据集与检测器，我们引入尺度因子&nbsp;<strong>ratio&nbsp;</strong>控制辅助边框的尺度大小用于计算损失。最后，将&nbsp;<strong>Inner-IoU&nbsp;</strong>集成至现有的基于&nbsp;<strong>IoU&nbsp;</strong>损失函数中进行仿真实验与对比实验。实验结果表明在使用本文所提出方法后检测效果得到进一步提升，验证了本文方法的有效性以及泛化能力。</p> 
<p>IoU损失函数在计算机视觉任务中有广泛的应用。在<a href="https://so.csdn.net/so/search?q=%E8%BE%B9%E7%95%8C%E6%A1%86&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E8%BE%B9%E7%95%8C%E6%A1%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;边界框\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E8%BE%B9%E7%95%8C%E6%A1%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;边界框\&quot;}&quot;}" data-tit="边界框" data-pretit="边界框">边界框</a>回归过程中，不仅可以评估回归状态，还可以通过计算回归损失来加速收敛。在这里，作者讨论IoU变化与边界框大小之间的关系，分析边界框回归问题的本质特征，并解释本文提出方法的可行性。</p> 
<p><img alt="" height="439" src="https://img-blog.csdnimg.cn/2eb72e2ada0f40c0afae3dcaa2250633.png" width="697"></p> 
<p>为弥补现有IoU损失函数在不同的检测任务中的泛化能力较弱且收敛速度较慢的不足，作者提出使用辅助边界框计算损失以加速边界框回归过程。在Inner-IoU中，作者引入了尺度因子比，可以控制辅助边界框的尺度大小。通过为不同数据集和检测器使用不同尺度的辅助边界框，可以克服现有方法在泛化能力方面的局限。</p> 
<p><img alt="" height="551" src="https://img-blog.csdnimg.cn/0ffdad3a3e05456aa70d7fe5c3f5ea5e.png" width="810"></p> 
<p>&nbsp;<img alt="" height="478" src="https://img-blog.csdnimg.cn/640be176afb54d64aaec196dc9bdaf65.png" width="672"></p> 
<p>&nbsp;图8.a, 8.b和8.c 为CIoU and Inner-CIoU的训练过程曲线图，三张图分别对应ratio 为0.7, 0.75, and 0.8。图8.d, 图8.e和 图8.f 为ratio 分别为0.7, 0.75, and 0.8时,SIoU and Inner-SIoU的训练过程曲线图。在以上图中，橙色曲线代表本文方法，现有方法用绿色曲线表示。不难看出在训练过程中50至150 epochs 本文方法优于现有的方法。<br> &nbsp;</p> 
<p>&nbsp;<img alt="" height="685" src="https://img-blog.csdnimg.cn/deed551516d8418eb244e6a017e7e02e.png" width="1150"></p> 
<p>&nbsp;&nbsp;&nbsp;测试集对比实验结果如表1所示。可以看出，应用本文方法后，检测效果有所提高，AP50和mAP50:95提高了0.5%以上。图6和图7是检测样本的对比图。<strong>从图中可以看出，与现有方法相比，所提出的方法定位更准确，误检和漏检更少。</strong>&nbsp;</p> 
<p><img alt="" height="721" src="https://img-blog.csdnimg.cn/cb2a530459f74b6f906eef447045937a.png" width="1200">&nbsp;原理可参考作者博客：</p> 
<p><a href="https://blog.csdn.net/qq_45911380/article/details/134320866" title="作者导读：Inner-IoU：基于辅助边框的IoU损失-CSDN博客">作者导读：Inner-IoU：基于辅助边框的IoU损失-CSDN博客</a></p> 
<h2 id="1.MPDIoU%E4%BB%8B%E7%BB%8D"><a name="t1"></a>2.&nbsp;<strong>MPDIoU介绍</strong></h2> 
<p><img alt="" height="397" src="https://img-blog.csdnimg.cn/64e9a1a8bccf46eebdee599e94672d72.png" width="852"></p> 
<p>论文：<a href="https://arxiv.org/pdf/2307.07662.pdf" title="https://arxiv.org/pdf/2307.07662.pdf">https://arxiv.org/pdf/2307.07662.pdf</a>&nbsp;</p> 
<p>&nbsp;摘要：边界框回归（BBR）已广泛应用于对象检测和实例分割，是对象定位的重要步骤。 然而，当预测框与真实框具有相同的长宽比，但宽度和高度值完全不同时，大多数现有的边界框回归损失函数无法优化。 为了解决上述问题，我们充分挖掘水平矩形的几何特征，提出了一种基于最小点距离的新型边界框相似度比较度量MPDIoU，它包含了现有损失函数中考虑的所有相关因素，即重叠 或非重叠区域、中心点距离、宽高偏差，同时简化计算过程。 在此基础上，我们提出了一种基于 MPDIoU 的边界框回归损失函数，称为 LMPDIoU 。 实验结果表明，MPDIoU 损失函数适用于在 PASCAL VOC、MS COCO 和 IIIT5k 上训练的最先进的实例分割（例如 YOLACT）和对象检测（例如 YOLOv7）模型优于现有的损失函数。</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;具有不同边界框回归结果的两种情况。绿色框表示真实边界框，红色框表示预测边界框。 这两种情况之间的 LGIoU 、 LDIoU 、LCIoU 、 LEIoU 的值完全相同，但LMPDIoU不同<img alt="" height="534" src="https://img-blog.csdnimg.cn/8870fbe183394e0eb45a1e7b43b4c4f0.png" width="1200"></p> 
<p>&nbsp;在分析了上面提到的基于 IoU 的损失函数的优缺点后，我们开始思考如何提高边界框回归的准确性和效率。 一般来说，我们使用左上角和右下角的坐标来定义一个唯一的矩形。 受边界框几何特性的启发，我们设计了一种名为 MPDIoU 的新颖的基于 IoU 的度量，以直接最小化预测边界框与真实边界框之间的左上角和右下点距离。 MPDIoU 算法流程如下：</p> 
<p><img alt="" height="328" src="https://img-blog.csdnimg.cn/78baeac834ae4bad95a72b8ea66fb8b3.png" width="1200"></p> 
<p><img alt="" height="698" src="https://img-blog.csdnimg.cn/79e8a38345914aadabf8476a50479341.png" width="1200"></p> 
<p></p> 
<p>&nbsp;图 4：具有相同长宽比但不同宽度和高度的预测边界框和真实边界框的示例，其中 k &gt; 1 且 k ∈ R，绿色框表示真实框，红色框表示预测框。&nbsp;<img alt="" height="463" src="https://img-blog.csdnimg.cn/537d0fe6d0694b4b8221302d0e78d0be.png" width="1200"></p> 
<p>详见：<a href="https://blog.csdn.net/m0_63774211/article/details/131991064" title="Yolov8损失函数改进：MPDIoU新型边界框相似度度量，效果秒杀GIoU 、 DIoU 、CIoU 、 EIoU等 | ELSEVIER 2023-CSDN博客">Yolov8损失函数改进：MPDIoU新型边界框相似度度量，效果秒杀GIoU 、 DIoU 、CIoU 、 EIoU等 | ELSEVIER 2023-CSDN博客</a></p> 
<h2 style="background-color:transparent;"><a name="t2"></a>3.&nbsp;Inner-MPDIoU加入YOLOv8</h2> 
<h3><a name="t3"></a>3.1&nbsp;&nbsp;&nbsp;Inner-MPDIoU加入ultralytics/utils/metrics.py</h3> 
<pre data-index="0" class="set-code-show" name="code"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> ultralytics.<span class="hljs-property">utils</span> <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">LOGGER</span>, <span class="hljs-title class_">SimpleClass</span>, <span class="hljs-title class_">TryExcept</span>, plt_settings,ops</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<pre data-index="1" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1111px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> xywh:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ops.xyxy<span class="hljs-number">2</span>xywh(box<span class="hljs-number">1</span>), ops.xyxy<span class="hljs-number">2</span>xywh(box<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>(w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> (w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>(h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> (h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio <span class="hljs-operator">*</span> ratio <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio <span class="hljs-operator">*</span> ratio<span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> inter <span class="hljs-operator">/</span> union</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def bbox_inner_mpdiou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, mpdiou_hw<span class="hljs-operator">=</span><span class="hljs-number">1</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Calculate Intersection over Union (IoU) of box1(1, 4) to box2(n, 4).</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Get</span> the coordinates <span class="hljs-keyword">of</span> bounding boxes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> xywh:  # transform <span class="hljs-keyword">from</span> xywh <span class="hljs-keyword">to</span> xyxy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>_, h<span class="hljs-number">1</span>_, w<span class="hljs-number">2</span>_, h<span class="hljs-number">2</span>_ <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">1</span>_, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> h<span class="hljs-number">1</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>_, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> h<span class="hljs-number">2</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:  # x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Inner-IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    innner_iou <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span>xywh, ratio<span class="hljs-operator">=</span>ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span><span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou <span class="hljs-operator">=</span> inter <span class="hljs-operator">/</span> union</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    d<span class="hljs-number">1</span> <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    d<span class="hljs-number">2</span> <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>d<span class="hljs-number">1</span> <span class="hljs-operator">/</span> mpdiou_hw<span class="hljs-operator"> - </span>d<span class="hljs-number">2</span> <span class="hljs-operator">/</span> mpdiou_hw  # MPDIoU</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3 style="background-color:transparent;"><a name="t4"></a>3.2&nbsp;修改ultralytics/utils/loss.py</h3> 
<p style="background-color:transparent;"><span style="color:#fe2c24;"><strong>第一处修改</strong></span></p> 
<pre data-index="2" class="set-code-show" name="code"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> .<span class="hljs-property">metrics</span> <span class="hljs-keyword">import</span> bbox_iou, bbox_inner_iou, bbox_inner_mpdiou</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p><span style="color:#fe2c24;"><strong>第二处修改</strong></span></p> 
<p><span style="color:#0d0016;">修改class BboxLoss(nn.Module):</span></p> 
<pre data-index="3" class="set-code-show" name="code"><code class="hljs language-ruby"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, pred_dist, pred_bboxes, anchor_points, target_bboxes, target_scores, target_scores_sum, fg_mask</span>)<span class="hljs-symbol">:</span></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改为：</p> 
<pre data-index="4" class="set-code-show" name="code"><code class="hljs language-ruby"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, pred_dist, pred_bboxes, anchor_points, target_bboxes, target_scores, target_scores_sum, fg_mask,mpdiou_hw=<span class="hljs-title class_">None</span></span>)<span class="hljs-symbol">:</span></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>&nbsp;<span style="color:#fe2c24;"><strong>第三处修改</strong></span></p> 
<p><span style="color:#0d0016;">修改class BboxLoss(nn.Module):</span></p> 
<pre data-index="5" class="set-code-show" name="code"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span> bbox_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改为</p> 
<pre data-index="6" class="set-code-show" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1001px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        iou <span class="hljs-operator">=</span> bbox_inner_mpdiou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, mpdiou_hw<span class="hljs-operator">=</span>mpdiou_hw,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>)</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p><span style="color:#fe2c24;"><strong>第四处修改</strong></span></p> 
<p>&nbsp; &nbsp; def __call__(self, preds, batch):</p> 
<p>原始为</p> 
<pre data-index="7" class="set-code-show" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1288px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # bbox loss</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> fg_mask.<span class="hljs-keyword">sum</span>():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            target_bboxes <span class="hljs-operator">/</span><span class="hljs-operator">=</span> stride_tensor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            loss[<span class="hljs-number">0</span>], loss[<span class="hljs-number">2</span>] <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.bbox_loss(pred_distri, pred_bboxes, anchor_points, target_bboxes, target_scores, target_scores_<span class="hljs-keyword">sum</span>, fg_mask)</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改为：</p> 
<pre data-index="8" class="set-code-show" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1102px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # bbox loss</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> fg_mask.<span class="hljs-keyword">sum</span>():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            target_bboxes <span class="hljs-operator">/</span><span class="hljs-operator">=</span> stride_tensor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            loss[<span class="hljs-number">0</span>], loss[<span class="hljs-number">2</span>] <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.bbox_loss(pred_distri, pred_bboxes, anchor_points, target_bboxes, target_scores,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                              target_scores_<span class="hljs-keyword">sum</span>, fg_mask, feats[<span class="hljs-number">0</span>].shape[<span class="hljs-number">0</span>] <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> feats[<span class="hljs-number">0</span>].shape[<span class="hljs-number">1</span>] <span class="hljs-operator">**</span> <span class="hljs-number">2</span>)</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/134400187&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>