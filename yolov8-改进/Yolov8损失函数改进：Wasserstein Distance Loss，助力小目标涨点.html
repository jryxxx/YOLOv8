<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <p>&nbsp;💡💡💡<span style="color:#fe2c24;"><strong>本文改进：</strong></span><span style="color:#4da8ee;">基于Wasserstein距离的小目标检测评估方法</span></p> 
<p><span style="color:#956fe7;"><strong>Wasserstein Distance Loss</strong></span> | &nbsp; <span style="color:#ff9900;">亲测在多个数据集能够实现涨点，对小目标、遮挡物性能提升明显</span></p> 
<p>💡💡💡<span style="color:#4da8ee;">Yolov8魔术师，独家首发创新（原创），适用于Yolov5、Yolov7、Yolov8等各个Yolo系列，专栏文章提供每一步步骤和源码，轻松带你上手魔改网络</span></p> 
<p>💡💡💡<span style="color:#a2e043;">重点：通过本专栏的阅读，后续你也可以自己魔改网络，在网络不同位置（Backbone、head、detect、loss等）进行魔改，实现创新！！！</span></p> 
<p><span style="color:#fe2c24;"><strong>专栏介绍：</strong></span></p> 
<p>✨✨✨<span style="color:#4da8ee;">原创魔改网络、复现前沿论文，组合优化创新</span></p> 
<p>🚀🚀🚀<span style="color:#956fe7;">小目标、遮挡物、难样本性能提升</span></p> 
<p>🍉🍉🍉<span style="color:#a2e043;">持续更新中，定期更新不同数据集涨点情况</span></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t0" target="_self">1.Wasserstein Distance Loss介绍</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t1" target="_self">2.微小目标提升：加入yolov8</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t2" target="_self">2.1&nbsp;ultralytics/yolo/utils/loss.py加入&nbsp;Wasserstein</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="1.Wasserstein%20Distance%20Loss%E4%BB%8B%E7%BB%8D"><a name="t0"></a>1.Wasserstein Distance Loss介绍</h2> 
<p>&nbsp;论文名称：《A Normalized Gaussian Wasserstein Distance for Tiny Object Detection》<br> 作者：Jinwang Wang、Chang Xu、Chang Xu、Lei Yu<br> 论文地址：<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2110.13389" title="https://arxiv.org/abs/2110.13389">https://arxiv.org/abs/2110.13389</a></p> 
<p>小目标检测是一个非常具有挑战性的问题，因为小目标只包含几个像素大小。作者证明，由于缺乏外观信息，最先进的检测器也不能在小目标上得到令人满意的结果。作者的主要观察结果是，基于IoU (Intersection over Union, IoU)的指标，如IoU本身及其扩展，对小目标的位置偏差非常敏感，在基于Anchor的检测器中使用时，严重降低了检测性能。<br> 为了解决这一问题，本文提出了一种新的基于<a href="https://so.csdn.net/so/search?q=Wasserstein%E8%B7%9D%E7%A6%BB&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=Wasserstein%E8%B7%9D%E7%A6%BB&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;Wasserstein距离\&quot;}&quot;}" data-tit="Wasserstein距离" data-pretit="wasserstein距离">Wasserstein距离</a>的小目标检测评估方法。具体来说，首先将BBox建模为二维高斯分布，然后提出一种新的度量标准，称为Normalized Wasserstein Distance(NWD)，通过它们对应的高斯分布计算它们之间的相似性。提出的NWD度量可以很容易地嵌入到任何基于Anchor的检测器的Assignment、非最大抑制和损失函数中，以取代常用的IoU度量。</p> 
<p><strong>1）分析了 IoU 对微小物体位置偏差的敏感性，并提出 NWD 作为衡量两个边界框之间相似性的更好指标；</strong></p> 
<p><strong>2）通过将NWD 应用于基于锚的检测器中的标签分配、NMS 和损失函数来设计强大的微小物体检测器；</strong></p> 
<p><strong>3）提出的 NWD 可以显着提高流行的基于锚的检测器的 TOD 性能，它在 AI-TOD 数据集上的 Faster R-CNN 上实现了从 11.1% 到 17.6% 的性能提升；</strong></p> 
<p>&nbsp;具体来说，对于6×6像素的小目标，轻微的位置偏差会导致明显的IoU下降(从0.53下降到0.06)，导致标签分配不准确。然而，对于36×36像素的正常目标，IoU略有变化(从0.90到0.65)，位置偏差相同。此外，图2给出了4条不同目标尺度的IoU-Deviation曲线，随着目标尺度的减小，曲线下降速度更快。值得注意的是，IoU的敏感性来自于BBox位置只能离散变化的特殊性。</p> 
<p></p> 
<p><img alt="" height="765" src="https://img-blog.csdnimg.cn/af3f0e2838f04e3787dceba45a27f43d.png" width="1031"></p> 
<p><strong>Wasserstein distance的主要优点是</strong>：</p> 
<ol><li>无论小目标之间有没有重叠都可以度量分布相似性;</li><li>NWD对不同尺度的目标不敏感，更适合测量小目标之间的相似性。</li></ol> 
<p>NWD可应用于One-Stage和Multi-Stage Anchor-Based检测器。此外，NWD不仅可以替代标签分配中的IoU，还可以替代非最大抑制中的IoU(NMS)和回归损失函数。在一个新的TOD<a href="https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;数据集\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;数据集\&quot;}&quot;}" data-tit="数据集" data-pretit="数据集">数据集</a>AI-TOD上的大量实验表明，本文提出的NWD可以持续地提高所有检测器的检测性能。</p> 
<p></p> 
<p>AI-TOD数据集上基于IoU的检测器(第1行)和基于NWD的检测器(第2行)的可视化结果上图所示。可以观察到与IoU相比，NWD可显著降低假阴性(FN)。</p> 
<h2 id="2.%E5%BE%AE%E5%B0%8F%E7%9B%AE%E6%A0%87%E6%8F%90%E5%8D%87%EF%BC%9A%E5%8A%A0%E5%85%A5yolov8"><a name="t1"></a>2.微小目标提升：加入yolov8</h2> 
<h3 id="2.1%C2%A0ultralytics%2Fyolo%2Futils%2Floss.py%E5%8A%A0%E5%85%A5%C2%A0Wasserstein"><a name="t2"></a>2.1&nbsp;ultralytics/yolo/utils/loss.py加入&nbsp;Wasserstein</h3> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def Wasserstein(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    box<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>.T</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> xywh:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_cx, b<span class="hljs-number">1</span>_cy <span class="hljs-operator">=</span> (box<span class="hljs-number">1</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">+</span> box<span class="hljs-number">1</span>[<span class="hljs-number">2</span>]) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, (box<span class="hljs-number">1</span>[<span class="hljs-number">1</span>] <span class="hljs-operator">+</span> box<span class="hljs-number">1</span>[<span class="hljs-number">3</span>]) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_w, b<span class="hljs-number">1</span>_h <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>[<span class="hljs-number">2</span>]<span class="hljs-operator"> - </span>box<span class="hljs-number">1</span>[<span class="hljs-number">0</span>], box<span class="hljs-number">1</span>[<span class="hljs-number">3</span>]<span class="hljs-operator"> - </span>box<span class="hljs-number">1</span>[<span class="hljs-number">1</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_cx, b<span class="hljs-number">2</span>_cy <span class="hljs-operator">=</span> (box<span class="hljs-number">2</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">+</span> box<span class="hljs-number">2</span>[<span class="hljs-number">0</span>]) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, (box<span class="hljs-number">2</span>[<span class="hljs-number">1</span>] <span class="hljs-operator">+</span> box<span class="hljs-number">2</span>[<span class="hljs-number">3</span>]) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_w, b<span class="hljs-number">1</span>_h <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>[<span class="hljs-number">2</span>]<span class="hljs-operator"> - </span>box<span class="hljs-number">2</span>[<span class="hljs-number">0</span>], box<span class="hljs-number">2</span>[<span class="hljs-number">3</span>]<span class="hljs-operator"> - </span>box<span class="hljs-number">2</span>[<span class="hljs-number">1</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_cx, b<span class="hljs-number">1</span>_cy, b<span class="hljs-number">1</span>_w, b<span class="hljs-number">1</span>_h <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>[<span class="hljs-number">0</span>], box<span class="hljs-number">1</span>[<span class="hljs-number">1</span>], box<span class="hljs-number">1</span>[<span class="hljs-number">2</span>], box<span class="hljs-number">1</span>[<span class="hljs-number">3</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_cx, b<span class="hljs-number">2</span>_cy, b<span class="hljs-number">2</span>_w, b<span class="hljs-number">2</span>_h <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>[<span class="hljs-number">0</span>], box<span class="hljs-number">2</span>[<span class="hljs-number">1</span>], box<span class="hljs-number">2</span>[<span class="hljs-number">2</span>], box<span class="hljs-number">2</span>[<span class="hljs-number">3</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    cx_L<span class="hljs-number">2</span>Norm <span class="hljs-operator">=</span> torch.pow((b<span class="hljs-number">1</span>_cx<span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_cx), <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    cy_L<span class="hljs-number">2</span>Norm <span class="hljs-operator">=</span> torch.pow((b<span class="hljs-number">1</span>_cy<span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_cy), <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    p<span class="hljs-number">1</span> <span class="hljs-operator">=</span> cx_L<span class="hljs-number">2</span>Norm <span class="hljs-operator">+</span> cy_L<span class="hljs-number">2</span>Norm</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    w_FroNorm <span class="hljs-operator">=</span> torch.pow((b<span class="hljs-number">1</span>_w<span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_w)<span class="hljs-operator">/</span><span class="hljs-number">2</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    h_FroNorm <span class="hljs-operator">=</span> torch.pow((b<span class="hljs-number">1</span>_h<span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_h)<span class="hljs-operator">/</span><span class="hljs-number">2</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    p<span class="hljs-number">2</span> <span class="hljs-operator">=</span> w_FroNorm <span class="hljs-operator">+</span> h_FroNorm</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> p<span class="hljs-number">1</span> <span class="hljs-operator">+</span> p<span class="hljs-number">2</span></div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>class BboxLoss(nn.Module):</p> 
<pre data-index="1"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">iou <span class="hljs-operator">=</span> bbox_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">loss_iou <span class="hljs-operator">=</span> ((<span class="hljs-number">1.0</span><span class="hljs-operator"> - </span>iou) <span class="hljs-operator">*</span> weight).<span class="hljs-keyword">sum</span>() <span class="hljs-operator">/</span> target_scores_<span class="hljs-keyword">sum</span></div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>替换为以下代码&nbsp;</p> 
<pre data-index="2"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1237px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        loss_iou <span class="hljs-operator">=</span> <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        iou <span class="hljs-operator">=</span> bbox_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        nwd <span class="hljs-operator">=</span> torch.exp(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            -torch.pow(Wasserstein(pred_bboxes[fg_mask].T, target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>), <span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span> <span class="hljs-number">1.0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # loss_iou <span class="hljs-operator">=</span> (((<span class="hljs-number">1.0</span><span class="hljs-operator"> - </span>iou) <span class="hljs-operator">*</span> weight).<span class="hljs-keyword">sum</span>() <span class="hljs-operator">/</span> target_scores_<span class="hljs-keyword">sum</span> ) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span>  <span class="hljs-operator">+</span>(((<span class="hljs-number">1.0</span><span class="hljs-operator"> - </span>nwd) <span class="hljs-operator">*</span> weight).<span class="hljs-keyword">sum</span>() <span class="hljs-operator">/</span> target_scores_<span class="hljs-keyword">sum</span> ) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        loss_iou<span class="hljs-number">1</span> <span class="hljs-operator">=</span> ((<span class="hljs-number">1.0</span><span class="hljs-operator"> - </span>iou).mean()) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> ((<span class="hljs-number">1.0</span><span class="hljs-operator"> - </span>nwd).mean()) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        loss_iou <span class="hljs-operator">=</span> loss_iou <span class="hljs-operator">+</span> loss_iou<span class="hljs-number">1</span></div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/130321185&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>