<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t5" target="_self">1.SeaFormer介绍​编辑</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t6" target="_self">&nbsp;2.Sea_AttentionBlock和C2f_SeaformerBlock引入Yolov8</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t7" target="_self">2.1 加入ultralytics/nn/attention/seaformer.py</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t8" target="_self">&nbsp;2.2 tasks.py注册</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t9" target="_self">2.3&nbsp;&nbsp;yolov8_Sea_Attention.yaml</a></p> 
<p id="2.4%C2%A0yolov5s_Sea_AttentionBlock.yaml-toc" style="margin: 0px;"></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86Yolov5%2FYolov7%E9%AD%94%E6%9C%AF%E5%B8%88%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86"><a name="t0"></a>&nbsp;🏆🏆🏆🏆🏆🏆Yolov8魔术师🏆🏆🏆🏆🏆🏆</h2> 
<h2><a name="t1"></a><a name="t2"></a></h2> 
<h3 id="%E2%9C%A8%E2%9C%A8%E2%9C%A8%E9%AD%94%E6%94%B9%E7%BD%91%E7%BB%9C%E3%80%81%E5%A4%8D%E7%8E%B0%E5%89%8D%E6%B2%BF%E8%AE%BA%E6%96%87%EF%BC%8C%E7%BB%84%E5%90%88%E4%BC%98%E5%8C%96%E5%88%9B%E6%96%B0"><a name="t2"></a>✨✨✨魔改网络、复现前沿论文，组合优化创新</h3> 
<h3 id="%F0%9F%9A%80%F0%9F%9A%80%F0%9F%9A%80%E5%B0%8F%E7%9B%AE%E6%A0%87%E3%80%81%E9%81%AE%E6%8C%A1%E7%89%A9%E3%80%81%E9%9A%BE%E6%A0%B7%E6%9C%AC%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87"><a name="t3"></a>🚀🚀🚀小目标、遮挡物、难样本性能提升</h3> 
<h3 id="%F0%9F%8D%89%F0%9F%8D%89%F0%9F%8D%89%E6%9C%AC%E6%96%87%E5%BC%95%E5%85%A5%E8%BD%BB%E9%87%8F%E9%AB%98%E6%95%88%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%A8%A1%E5%9D%97Sea_AttentionBlock%20%E5%92%8C%E4%BA%8Ec2f%E7%BB%93%E5%90%88%E6%8F%90%E5%8D%87%E6%A3%80%E6%B5%8B%E7%B2%BE%E5%BA%A6"><a name="t4"></a>🍉🍉🍉本文引入轻量高效注意力模块Sea_AttentionBlock 和于c2f结合提升检测精度</h3> 
<p>🌰&nbsp;🌰&nbsp;🌰在不同<a href="https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;数据集\&quot;}&quot;}" data-tit="数据集" data-pretit="数据集">数据集</a>验证能够涨点，对小目标涨点明显</p> 
<p><img alt="" src="https://img-blog.csdnimg.cn/f619b8be448343a39f514cb345742adf.jpeg"></p> 
<p></p> 
<h2 id="main-toc"><a name="t5"></a>1.SeaFormer介绍<img alt="" height="171" src="https://img-blog.csdnimg.cn/ef03ef11e7f9405d8522b80a6e7e1d00.png" width="725"></h2> 
<p>论文：&nbsp;<a href="https://arxiv.org/pdf/2301.13156.pdf" title="https://arxiv.org/pdf/2301.13156.pdf">https://arxiv.org/pdf/2301.13156.pdf</a></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;相较于 CNNs 而言，<a href="https://so.csdn.net/so/search?q=ViT&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=ViT&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;ViT\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=ViT&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;ViT\&quot;}&quot;}" data-tit="ViT" data-pretit="vit">ViT</a> 模型在精度方面现已逐渐主导 CV 领域。然而，我们知道 ViT 的一个普遍缺陷便是计算成本和内存要求高。特别地，针对高分辨率的逐像素密集分类的语义分割任务来说，应用 ViT 模型简直不敢相信。</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了更好的解决这个问题，本文提出了一种面向移动端应用的新方法——<code>SeaFormer</code>，即&nbsp;<strong>Squeeze-erunhanced Axial Transoformer</strong>。其主要创新点在于设计了一种即插即用的通用注意力模块，通过由该模块构建而成的模型在基于 ARM 的移动设备上实现了分割精度和推理延迟之间的最佳权衡，最终在图像分类及其下游任务上表现良好。</p> 
<p>本文提出了一种新方法：squeeze-enhanced Axial Transformer，简称SeaFormer，这是一个轻量级算法，创新点：</p> 
<ul><li>带有squeeze Axial和细节增强（detail enhancement）的attention block，使用该模块构建backbone。</li><li>轻量级的分割head。</li><li>兼顾速度和精度。</li></ul> 
<p></p> 
<p><img alt="" height="470" src="https://img-blog.csdnimg.cn/41ab32dff1d740b98b9278488be3d824.png" width="1121"></p> 
<p>&nbsp;SeaFormer由STEM、context分支（红色）、spatial分支（蓝色）、fusion模块、分割head组成。上图中的MV2表示MobileNetV2 block，MV2 ↓2表示带有下采样的MobileNetV2 block，⊗表示元素相乘。<img alt="" height="430" src="https://img-blog.csdnimg.cn/99c979c324a741ffbba3c0b418f2fdb8.png" width="1088"></p> 
<p>上面这张图是 SeaFormer 的网络架构图，可以看到整体上仍然是一个不对称的编码器-解码器结构，网络设计成双分支的结构侧重于捕捉不同的特征信息，如上下文语义信息和空间细节信息。其主要包含以下几个模块：</p> 
<ul><li><strong>共享的骨干网络层</strong></li><li><strong>上下文分支</strong></li><li><strong>空间分支</strong></li><li><strong>融合模块</strong></li><li><strong>轻量级的分割头</strong></li></ul> 
<p>&nbsp;该网络先对图像进行1/2、1/4和1/8的下采样，再分别用两个分支进行处理，红色的是上下文分支，蓝色的是空间分支。上下文分支交替使用了MobileNetV2 Block（MV2）和SeaFormer Layers，中间使用Fusion block对两个分支进行融合，使用卷积和Sigmoid提取权重信息，再将权重信息与空间分支相乘，连续迭代三次后使用Light segmentation head进行处理。</p> 
<p>&nbsp;<img alt="" height="563" src="https://img-blog.csdnimg.cn/4e3060b199f34d5cbb8a15b6c4ae2193.png" width="1059"></p> 
<p>&nbsp;<img alt="" height="735" src="https://img-blog.csdnimg.cn/6dccd2c4848c436986b5a932d2a95e39.png" width="575"></p> 
<h2 id="%C2%A02.Sea_AttentionBlock%E5%92%8CC2f_SeaformerBlock%E5%BC%95%E5%85%A5Yolov5"><a name="t6"></a>&nbsp;2.Sea_AttentionBlock和C2f_SeaformerBlock引入Yolov8</h2> 
<h3 id="2.1%20%E5%8A%A0%E5%85%A5models%2Fattention%2Fseaformer.py"><a name="t7"></a>2.1 加入ultralytics/nn/attention/seaformer.py</h3> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln hundred" style="width:1117px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import math</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> torch import nn</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn.functional <span class="hljs-keyword">as</span> F</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> mmcv.cnn import ConvModule</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> mmcv.cnn import build_norm_layer</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> timm.models.registry import register_model</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">__<span class="hljs-literal">all</span>__ <span class="hljs-operator">=</span> [<span class="hljs-string">"SeaFormer_T"</span>, <span class="hljs-string">"SeaFormer_S"</span>, <span class="hljs-string">"SeaFormer_B"</span>, <span class="hljs-string">"SeaFormer_L"</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def autopad(k, p<span class="hljs-operator">=</span>None, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>):  # kernel, padding, dilation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Pad <span class="hljs-keyword">to</span> <span class="hljs-string">'same'</span> shape outputs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> d <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k <span class="hljs-operator">=</span> d <span class="hljs-operator">*</span> (k<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [d <span class="hljs-operator">*</span> (x<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # actual kernel-size</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> p <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p <span class="hljs-operator">=</span> k <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [x <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # auto-pad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> p</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Conv(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Standard</span> convolution <span class="hljs-keyword">with</span> args(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_out, kernel, stride, padding, groups, dilation, activation)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">default</span>_act <span class="hljs-operator">=</span> nn.SiLU()  # <span class="hljs-keyword">default</span> activation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k<span class="hljs-operator">=</span><span class="hljs-number">1</span>, s<span class="hljs-operator">=</span><span class="hljs-number">1</span>, p<span class="hljs-operator">=</span>None, g<span class="hljs-operator">=</span><span class="hljs-number">1</span>, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k, s, autopad(k, p, d), groups<span class="hljs-operator">=</span>g, dilation<span class="hljs-operator">=</span>d, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.bn <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(c<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">default</span>_act <span class="hljs-keyword">if</span> act <span class="hljs-keyword">is</span> <span class="hljs-keyword">True</span> <span class="hljs-keyword">else</span> act <span class="hljs-keyword">if</span> isinstance(act, nn.Module) <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.bn(<span class="hljs-keyword">self</span>.conv(x)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward_fuse(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.conv(x))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def _make_divisible(v, divisor, min_<span class="hljs-keyword">value</span><span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    This function is taken from the original tf repo.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    It ensures that all layers have a channel number that is divisible by 8</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    It can be seen here:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    https://github.com/tensorflow/models/blob/master/research/slim/nets/mobilenet/mobilenet.py</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    :param v:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    :param divisor:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    :param min_value:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    :return:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> min_<span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        min_<span class="hljs-keyword">value</span> <span class="hljs-operator">=</span> divisor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    new_v <span class="hljs-operator">=</span> max(min_<span class="hljs-keyword">value</span>, int(v <span class="hljs-operator">+</span> divisor <span class="hljs-operator">/</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> divisor <span class="hljs-operator">*</span> divisor)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Make sure that round <span class="hljs-keyword">down</span> does <span class="hljs-keyword">not</span> <span class="hljs-keyword">go</span> <span class="hljs-keyword">down</span> <span class="hljs-keyword">by</span> more <span class="hljs-keyword">than</span> <span class="hljs-number">10</span>%.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> new_v <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.9</span> <span class="hljs-operator">*</span> v:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        new_v <span class="hljs-operator">+</span><span class="hljs-operator">=</span> divisor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> new_v</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def drop_path(x, drop_prob: float <span class="hljs-operator">=</span> <span class="hljs-number">0</span>., training: bool <span class="hljs-operator">=</span> <span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Drop paths (Stochastic Depth) per sample (when applied in main path of residual blocks).</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    This is the same as the DropConnect impl I created for EfficientNet, etc networks, however,</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    the original name is misleading as 'Drop Connect' is a different form of dropout in a separate paper...</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    See discussion: https://github.com/tensorflow/tpu/issues/494#issuecomment-532968956 ... I've opted for</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    changing the layer and argument names to 'drop path' rather than mix DropConnect as a layer name and use</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    'survival rate' as the argument.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> drop_prob <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>. <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> training:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    keep_prob <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator"> - </span>drop_prob</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    shape <span class="hljs-operator">=</span> (x.shape[<span class="hljs-number">0</span>],) <span class="hljs-operator">+</span> (<span class="hljs-number">1</span>,) <span class="hljs-operator">*</span> (x.ndim<span class="hljs-operator"> - </span><span class="hljs-number">1</span>)  # work <span class="hljs-keyword">with</span> diff dim tensors, <span class="hljs-keyword">not</span> <span class="hljs-keyword">just</span> <span class="hljs-number">2</span>D ConvNets</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">random</span>_tensor <span class="hljs-operator">=</span> keep_prob <span class="hljs-operator">+</span> torch.rand(shape, dtype<span class="hljs-operator">=</span>x.dtype, device<span class="hljs-operator">=</span>x.device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">random</span>_tensor.floor_()  # binarize</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">output</span> <span class="hljs-operator">=</span> x.div(keep_prob) <span class="hljs-operator">*</span> <span class="hljs-keyword">random</span>_tensor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">output</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> DropPath(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Drop paths (Stochastic Depth) per sample  (when applied in main path of residual blocks).</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, drop_prob<span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(DropPath, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.drop_prob <span class="hljs-operator">=</span> drop_prob</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> drop_path(x, <span class="hljs-keyword">self</span>.drop_prob, <span class="hljs-keyword">self</span>.training)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_shape(tensor):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    shape <span class="hljs-operator">=</span> tensor.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> torch.onnx.<span class="hljs-keyword">is</span>_<span class="hljs-keyword">in</span>_onnx_export():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        shape <span class="hljs-operator">=</span> [i.cpu().numpy() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> shape]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Conv<span class="hljs-number">2</span>d_BN(nn.<span class="hljs-keyword">Sequential</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, a, b, ks<span class="hljs-operator">=</span><span class="hljs-number">1</span>, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, pad<span class="hljs-operator">=</span><span class="hljs-number">0</span>, dilation<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 groups<span class="hljs-operator">=</span><span class="hljs-number">1</span>, bn_weight_init<span class="hljs-operator">=</span><span class="hljs-number">1</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.inp_channel <span class="hljs-operator">=</span> a</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.out_channel <span class="hljs-operator">=</span> b</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.ks <span class="hljs-operator">=</span> ks</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pad <span class="hljs-operator">=</span> pad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">=</span> stride</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dilation <span class="hljs-operator">=</span> dilation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.groups <span class="hljs-operator">=</span> groups</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # <span class="hljs-keyword">self</span>.bias <span class="hljs-operator">=</span> bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">add</span>_module(<span class="hljs-string">'c'</span>, nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            a, b, ks, stride, pad, dilation, groups, bias<span class="hljs-operator">=</span>bias))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        bn <span class="hljs-operator">=</span> build_norm_layer(norm_cfg, b)[<span class="hljs-number">1</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        nn.init.<span class="hljs-keyword">constant</span>_(bn.weight, bn_weight_init)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        nn.init.<span class="hljs-keyword">constant</span>_(bn.bias, <span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">add</span>_module(<span class="hljs-string">'bn'</span>, bn)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Mlp(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">in</span>_features, hidden_features<span class="hljs-operator">=</span>None, out_features<span class="hljs-operator">=</span>None, act_layer<span class="hljs-operator">=</span>nn.ReLU, drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>.,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out_features <span class="hljs-operator">=</span> out_features <span class="hljs-keyword">or</span> <span class="hljs-keyword">in</span>_features</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        hidden_features <span class="hljs-operator">=</span> hidden_features <span class="hljs-keyword">or</span> <span class="hljs-keyword">in</span>_features</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fc<span class="hljs-number">1</span> <span class="hljs-operator">=</span> Conv<span class="hljs-number">2</span>d_BN(<span class="hljs-keyword">in</span>_features, hidden_features, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dwconv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(hidden_features, hidden_features, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, groups<span class="hljs-operator">=</span>hidden_features)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> act_layer()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.fc<span class="hljs-number">2</span> <span class="hljs-operator">=</span> Conv<span class="hljs-number">2</span>d_BN(hidden_features, out_features, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.drop <span class="hljs-operator">=</span> nn.Dropout(drop)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.fc<span class="hljs-number">1</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.dwconv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.act(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.drop(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.fc<span class="hljs-number">2</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.drop(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> InvertedResidual(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            inp: int,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            oup: int,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            ks: int,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            stride: int,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            expand_ratio: int,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            activations<span class="hljs-operator">=</span>None,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    ) -<span class="hljs-operator">&gt;</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(InvertedResidual, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">=</span> stride</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.expand_ratio <span class="hljs-operator">=</span> expand_ratio</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert stride <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> activations <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            activations <span class="hljs-operator">=</span> nn.ReLU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        hidden_dim <span class="hljs-operator">=</span> int(round(inp <span class="hljs-operator">*</span> expand_ratio))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">use</span>_res_connect <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.stride <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> inp <span class="hljs-operator">=</span><span class="hljs-operator">=</span> oup</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        layers <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> expand_ratio !<span class="hljs-operator">=</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # pw</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            layers.append(Conv<span class="hljs-number">2</span>d_BN(inp, hidden_dim, ks<span class="hljs-operator">=</span><span class="hljs-number">1</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            layers.append(activations())</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        layers.<span class="hljs-keyword">extend</span>([</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # dw</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            Conv<span class="hljs-number">2</span>d_BN(hidden_dim, hidden_dim, ks<span class="hljs-operator">=</span>ks, stride<span class="hljs-operator">=</span>stride, pad<span class="hljs-operator">=</span>ks <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>, groups<span class="hljs-operator">=</span>hidden_dim, norm_cfg<span class="hljs-operator">=</span>norm_cfg),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            activations(),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # pw-linear</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            Conv<span class="hljs-number">2</span>d_BN(hidden_dim, oup, ks<span class="hljs-operator">=</span><span class="hljs-number">1</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        ])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(<span class="hljs-operator">*</span>layers)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.out_channels <span class="hljs-operator">=</span> oup</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>._<span class="hljs-keyword">is</span>_cn <span class="hljs-operator">=</span> stride <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">use</span>_res_connect:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> x <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.conv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.conv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> StackedMV<span class="hljs-number">2</span><span class="hljs-keyword">Block</span>(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            cfgs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            stem,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            inp_channel<span class="hljs-operator">=</span><span class="hljs-number">16</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            activation<span class="hljs-operator">=</span>nn.ReLU,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            width_mult<span class="hljs-operator">=</span><span class="hljs-number">1</span>.):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.stem <span class="hljs-operator">=</span> stem</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> stem:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.stem_<span class="hljs-keyword">block</span> <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                Conv<span class="hljs-number">2</span>d_BN(<span class="hljs-number">3</span>, inp_channel, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                activation()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cfgs <span class="hljs-operator">=</span> cfgs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.layers <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i, (k, t, c, s) <span class="hljs-keyword">in</span> enumerate(cfgs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">output</span>_channel <span class="hljs-operator">=</span> _make_divisible(c <span class="hljs-operator">*</span> width_mult, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            exp_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> t <span class="hljs-operator">*</span> inp_channel</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            exp_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span> _make_divisible(exp_<span class="hljs-keyword">size</span> <span class="hljs-operator">*</span> width_mult, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            layer_name <span class="hljs-operator">=</span> <span class="hljs-string">'layer{}'</span>.<span class="hljs-keyword">format</span>(i <span class="hljs-operator">+</span> <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            layer <span class="hljs-operator">=</span> InvertedResidual(inp_channel, <span class="hljs-keyword">output</span>_channel, ks<span class="hljs-operator">=</span>k, stride<span class="hljs-operator">=</span>s, expand_ratio<span class="hljs-operator">=</span>t, norm_cfg<span class="hljs-operator">=</span>norm_cfg,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     activations<span class="hljs-operator">=</span>activation)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.<span class="hljs-keyword">add</span>_module(layer_name, layer)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            inp_channel <span class="hljs-operator">=</span> <span class="hljs-keyword">output</span>_channel</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.layers.append(layer_name)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.stem:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.stem_<span class="hljs-keyword">block</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i, layer_name <span class="hljs-keyword">in</span> enumerate(<span class="hljs-keyword">self</span>.layers):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            layer <span class="hljs-operator">=</span> getattr(<span class="hljs-keyword">self</span>, layer_name)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> layer(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SqueezeAxialPositionalEmbedding(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, dim, shape):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pos_embed <span class="hljs-operator">=</span> nn.Parameter(torch.randn([<span class="hljs-number">1</span>, dim, shape]))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        B, C, N <span class="hljs-operator">=</span> x.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> x <span class="hljs-operator">+</span> F.interpolate(<span class="hljs-keyword">self</span>.pos_embed, <span class="hljs-keyword">size</span><span class="hljs-operator">=</span>(N), <span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'linear'</span>, align_corners<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Sea_Attention(torch.nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, dim, <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-number">16</span>, num_heads<span class="hljs-operator">=</span><span class="hljs-number">4</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 attn_ratio<span class="hljs-operator">=</span><span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 activation<span class="hljs-operator">=</span>None,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>), ):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.num_heads <span class="hljs-operator">=</span> num_heads</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.scale <span class="hljs-operator">=</span> <span class="hljs-keyword">key</span>_dim <span class="hljs-operator">**</span> -<span class="hljs-number">0.5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">key</span>_dim <span class="hljs-operator">=</span> <span class="hljs-keyword">key</span>_dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.nh_kd <span class="hljs-operator">=</span> nh_kd <span class="hljs-operator">=</span> <span class="hljs-keyword">key</span>_dim <span class="hljs-operator">*</span> num_heads  # num_head <span class="hljs-keyword">key</span>_dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.d <span class="hljs-operator">=</span> int(attn_ratio <span class="hljs-operator">*</span> <span class="hljs-keyword">key</span>_dim)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dh <span class="hljs-operator">=</span> int(attn_ratio <span class="hljs-operator">*</span> <span class="hljs-keyword">key</span>_dim) <span class="hljs-operator">*</span> num_heads</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.attn_ratio <span class="hljs-operator">=</span> attn_ratio</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_q <span class="hljs-operator">=</span> Conv<span class="hljs-number">2</span>d_BN(dim, nh_kd, <span class="hljs-number">1</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_k <span class="hljs-operator">=</span> Conv<span class="hljs-number">2</span>d_BN(dim, nh_kd, <span class="hljs-number">1</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_v <span class="hljs-operator">=</span> Conv<span class="hljs-number">2</span>d_BN(dim, <span class="hljs-keyword">self</span>.dh, <span class="hljs-number">1</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.proj <span class="hljs-operator">=</span> torch.nn.<span class="hljs-keyword">Sequential</span>(activation(), Conv<span class="hljs-number">2</span>d_BN(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.dh, dim, bn_weight_init<span class="hljs-operator">=</span><span class="hljs-number">0</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.proj_encode_row <span class="hljs-operator">=</span> torch.nn.<span class="hljs-keyword">Sequential</span>(activation(), Conv<span class="hljs-number">2</span>d_BN(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.dh, <span class="hljs-keyword">self</span>.dh, bn_weight_init<span class="hljs-operator">=</span><span class="hljs-number">0</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pos_emb_rowq <span class="hljs-operator">=</span> SqueezeAxialPositionalEmbedding(nh_kd, <span class="hljs-number">16</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pos_emb_rowk <span class="hljs-operator">=</span> SqueezeAxialPositionalEmbedding(nh_kd, <span class="hljs-number">16</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.proj_encode_<span class="hljs-keyword">column</span> <span class="hljs-operator">=</span> torch.nn.<span class="hljs-keyword">Sequential</span>(activation(), Conv<span class="hljs-number">2</span>d_BN(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.dh, <span class="hljs-keyword">self</span>.dh, bn_weight_init<span class="hljs-operator">=</span><span class="hljs-number">0</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pos_emb_columnq <span class="hljs-operator">=</span> SqueezeAxialPositionalEmbedding(nh_kd, <span class="hljs-number">16</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pos_emb_columnk <span class="hljs-operator">=</span> SqueezeAxialPositionalEmbedding(nh_kd, <span class="hljs-number">16</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dwconv <span class="hljs-operator">=</span> Conv<span class="hljs-number">2</span>d_BN(<span class="hljs-keyword">self</span>.dh <span class="hljs-operator">+</span> <span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.nh_kd, <span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.nh_kd <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.dh, ks<span class="hljs-operator">=</span><span class="hljs-number">3</span>, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, pad<span class="hljs-operator">=</span><span class="hljs-number">1</span>, dilation<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                groups<span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.nh_kd <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.dh, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> activation()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pwconv <span class="hljs-operator">=</span> Conv<span class="hljs-number">2</span>d_BN(<span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.nh_kd <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.dh, dim, ks<span class="hljs-operator">=</span><span class="hljs-number">1</span>, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.sigmoid <span class="hljs-operator">=</span> h_sigmoid()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        B, C, H, W <span class="hljs-operator">=</span> x.shape</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        q <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_q(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_k(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        v <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">to</span>_v(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # <span class="hljs-keyword">detail</span> enhance</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        qkv <span class="hljs-operator">=</span> torch.cat([q, k, v], dim<span class="hljs-operator">=</span><span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        qkv <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.dwconv(qkv))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        qkv <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.pwconv(qkv)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # squeeze axial attention</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        ## squeeze row</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        qrow <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.pos_emb_rowq(q.mean(-<span class="hljs-number">1</span>)).reshape(B, <span class="hljs-keyword">self</span>.num_heads, -<span class="hljs-number">1</span>, H).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        krow <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.pos_emb_rowk(k.mean(-<span class="hljs-number">1</span>)).reshape(B, <span class="hljs-keyword">self</span>.num_heads, -<span class="hljs-number">1</span>, H)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        vrow <span class="hljs-operator">=</span> v.mean(-<span class="hljs-number">1</span>).reshape(B, <span class="hljs-keyword">self</span>.num_heads, -<span class="hljs-number">1</span>, H).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_row <span class="hljs-operator">=</span> torch.matmul(qrow, krow) <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.scale</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_row <span class="hljs-operator">=</span> attn_row.softmax(dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx_row <span class="hljs-operator">=</span> torch.matmul(attn_row, vrow)  # B nH H C</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx_row <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.proj_encode_row(xx_row.permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>).reshape(B, <span class="hljs-keyword">self</span>.dh, H, <span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        ## squeeze <span class="hljs-keyword">column</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        qcolumn <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.pos_emb_columnq(q.mean(-<span class="hljs-number">2</span>)).reshape(B, <span class="hljs-keyword">self</span>.num_heads, -<span class="hljs-number">1</span>, W).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kcolumn <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.pos_emb_columnk(k.mean(-<span class="hljs-number">2</span>)).reshape(B, <span class="hljs-keyword">self</span>.num_heads, -<span class="hljs-number">1</span>, W)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        vcolumn <span class="hljs-operator">=</span> v.mean(-<span class="hljs-number">2</span>).reshape(B, <span class="hljs-keyword">self</span>.num_heads, -<span class="hljs-number">1</span>, W).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_<span class="hljs-keyword">column</span> <span class="hljs-operator">=</span> torch.matmul(qcolumn, kcolumn) <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.scale</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_<span class="hljs-keyword">column</span> <span class="hljs-operator">=</span> attn_<span class="hljs-keyword">column</span>.softmax(dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="299"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx_<span class="hljs-keyword">column</span> <span class="hljs-operator">=</span> torch.matmul(attn_<span class="hljs-keyword">column</span>, vcolumn)  # B nH W C</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="300"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx_<span class="hljs-keyword">column</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.proj_encode_<span class="hljs-keyword">column</span>(xx_<span class="hljs-keyword">column</span>.permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>).reshape(B, <span class="hljs-keyword">self</span>.dh, <span class="hljs-number">1</span>, W))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="301"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="302"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx <span class="hljs-operator">=</span> xx_row.<span class="hljs-keyword">add</span>(xx_<span class="hljs-keyword">column</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="303"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx <span class="hljs-operator">=</span> v.<span class="hljs-keyword">add</span>(xx)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="304"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.proj(xx)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="305"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="306"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        xx <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.sigmoid(xx) <span class="hljs-operator">*</span> qkv</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="307"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> xx</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="308"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="309"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="310"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Sea_AttentionBlock(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="311"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="312"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, dim, <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-number">64</span>, num_heads<span class="hljs-operator">=</span><span class="hljs-number">4</span>, mlp_ratio<span class="hljs-operator">=</span><span class="hljs-number">2</span>., attn_ratio<span class="hljs-operator">=</span><span class="hljs-number">2</span>., drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>.,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="313"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 drop_path<span class="hljs-operator">=</span><span class="hljs-number">0.1</span>, act_layer<span class="hljs-operator">=</span>nn.ReLU, norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN2d'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="314"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="315"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dim <span class="hljs-operator">=</span> dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="316"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.num_heads <span class="hljs-operator">=</span> num_heads</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="317"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.mlp_ratio <span class="hljs-operator">=</span> mlp_ratio</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="318"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">       </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="319"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.attn <span class="hljs-operator">=</span> Sea_Attention(dim, <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-keyword">key</span>_dim, num_heads<span class="hljs-operator">=</span>num_heads, attn_ratio<span class="hljs-operator">=</span>attn_ratio,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="320"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                      activation<span class="hljs-operator">=</span>act_layer, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="321"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # NOTE: drop path <span class="hljs-keyword">for</span> stochastic depth, we shall see <span class="hljs-keyword">if</span> this <span class="hljs-keyword">is</span> better <span class="hljs-keyword">than</span> dropout here</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="322"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.drop_path <span class="hljs-operator">=</span> DropPath(drop_path) <span class="hljs-keyword">if</span> drop_path <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>. <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="323"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_hidden_dim <span class="hljs-operator">=</span> int(dim <span class="hljs-operator">*</span> mlp_ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="324"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.mlp <span class="hljs-operator">=</span> Mlp(<span class="hljs-keyword">in</span>_features<span class="hljs-operator">=</span>dim, hidden_features<span class="hljs-operator">=</span>mlp_hidden_dim, act_layer<span class="hljs-operator">=</span>act_layer, drop<span class="hljs-operator">=</span>drop, norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="325"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="326"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x<span class="hljs-number">1</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="327"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.drop_path(<span class="hljs-keyword">self</span>.attn(x<span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="328"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.drop_path(<span class="hljs-keyword">self</span>.mlp(x<span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="329"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="330"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="331"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="332"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> C<span class="hljs-number">2</span>f_SeaformerBlock(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="333"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # CSP Bottleneck <span class="hljs-keyword">with</span> <span class="hljs-number">2</span> convolutions</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="334"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, n<span class="hljs-operator">=</span><span class="hljs-number">1</span>, shortcut<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, g<span class="hljs-operator">=</span><span class="hljs-number">1</span>, e<span class="hljs-operator">=</span><span class="hljs-number">0.5</span>):  # <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_out, <span class="hljs-keyword">number</span>, shortcut, groups, expansion</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="335"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="336"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.c <span class="hljs-operator">=</span> int(c<span class="hljs-number">2</span> <span class="hljs-operator">*</span> e)  # hidden channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="337"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span> <span class="hljs-operator">=</span> Conv(c<span class="hljs-number">1</span>, <span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.c, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="338"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">2</span> <span class="hljs-operator">=</span> Conv((<span class="hljs-number">2</span> <span class="hljs-operator">+</span> n) <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.c, c<span class="hljs-number">2</span>, <span class="hljs-number">1</span>)  # <span class="hljs-keyword">optional</span> act<span class="hljs-operator">=</span>FReLU(c<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="339"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.m <span class="hljs-operator">=</span> nn.ModuleList(Sea_AttentionBlock(<span class="hljs-keyword">self</span>.c) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(n))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="340"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="341"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="342"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> list(<span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span>(x).chunk(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="343"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y.<span class="hljs-keyword">extend</span>(m(y[-<span class="hljs-number">1</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.m)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="344"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.cv<span class="hljs-number">2</span>(torch.cat(y, <span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="345"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="346"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward_split(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="347"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> list(<span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span>(x).split((<span class="hljs-keyword">self</span>.c, <span class="hljs-keyword">self</span>.c), <span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="348"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y.<span class="hljs-keyword">extend</span>(m(y[-<span class="hljs-number">1</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.m)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="349"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.cv<span class="hljs-number">2</span>(torch.cat(y, <span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="350"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="351"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SeaformerBasicLayer(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="352"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">block</span>_num, embedding_dim, <span class="hljs-keyword">key</span>_dim, num_heads,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="353"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 mlp_ratio<span class="hljs-operator">=</span><span class="hljs-number">4</span>., attn_ratio<span class="hljs-operator">=</span><span class="hljs-number">2</span>., drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>., attn_drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>., drop_path<span class="hljs-operator">=</span><span class="hljs-number">0</span>.,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="354"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN2d'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="355"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 act_layer<span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="356"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="357"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">block</span>_num <span class="hljs-operator">=</span> <span class="hljs-keyword">block</span>_num</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="358"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="359"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.transformer_blocks <span class="hljs-operator">=</span> nn.ModuleList()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="360"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">block</span>_num):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="361"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.transformer_blocks.append(Sea_AttentionBlock(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="362"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                embedding_dim, <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-keyword">key</span>_dim, num_heads<span class="hljs-operator">=</span>num_heads,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="363"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                mlp_ratio<span class="hljs-operator">=</span>mlp_ratio, attn_ratio<span class="hljs-operator">=</span>attn_ratio,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="364"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                drop<span class="hljs-operator">=</span>drop, drop_path<span class="hljs-operator">=</span>drop_path[i] <span class="hljs-keyword">if</span> isinstance(drop_path, list) <span class="hljs-keyword">else</span> drop_path,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="365"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                norm_cfg<span class="hljs-operator">=</span>norm_cfg,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="366"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                act_layer<span class="hljs-operator">=</span>act_layer))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="367"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="368"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="369"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # token <span class="hljs-operator">*</span> N</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="370"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">block</span>_num):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="371"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.transformer_blocks[i](x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="372"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="373"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="374"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="375"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="376"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> h_sigmoid(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="377"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="378"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(h_sigmoid, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="379"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.relu <span class="hljs-operator">=</span> nn.ReLU<span class="hljs-number">6</span>(inplace<span class="hljs-operator">=</span>inplace)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="380"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="381"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="382"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.relu(x <span class="hljs-operator">+</span> <span class="hljs-number">3</span>) <span class="hljs-operator">/</span> <span class="hljs-number">6</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="383"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="384"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="385"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SeaFormer(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="386"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, cfgs,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="387"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="388"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 emb_dims,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="389"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">key</span>_dims,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="390"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 depths<span class="hljs-operator">=</span>[<span class="hljs-number">2,2</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="391"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 num_heads<span class="hljs-operator">=</span><span class="hljs-number">4</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="392"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 attn_ratios<span class="hljs-operator">=</span><span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="393"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 mlp_ratios<span class="hljs-operator">=</span>[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="394"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 drop_path_rate<span class="hljs-operator">=</span><span class="hljs-number">0</span>.,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="395"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 norm_cfg<span class="hljs-operator">=</span>dict(<span class="hljs-keyword">type</span><span class="hljs-operator">=</span><span class="hljs-string">'BN'</span>, requires_grad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="396"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 act_layer<span class="hljs-operator">=</span>nn.ReLU<span class="hljs-number">6</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="397"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 init_cfg<span class="hljs-operator">=</span>None,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="398"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 num_classes<span class="hljs-operator">=</span><span class="hljs-number">1000</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="399"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="400"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="401"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.num_classes <span class="hljs-operator">=</span> num_classes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="402"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.channels <span class="hljs-operator">=</span> channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="403"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.depths <span class="hljs-operator">=</span> depths</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="404"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cfgs <span class="hljs-operator">=</span> cfgs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="405"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.norm_cfg <span class="hljs-operator">=</span> norm_cfg</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="406"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.init_cfg <span class="hljs-operator">=</span> init_cfg</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="407"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.init_cfg <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="408"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pretrained <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.init_cfg[<span class="hljs-string">'checkpoint'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="409"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="410"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(cfgs)):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="411"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            smb <span class="hljs-operator">=</span> StackedMV<span class="hljs-number">2</span><span class="hljs-keyword">Block</span>(cfgs<span class="hljs-operator">=</span>cfgs[i], stem<span class="hljs-operator">=</span><span class="hljs-keyword">True</span> <span class="hljs-keyword">if</span> i <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">False</span>, inp_channel<span class="hljs-operator">=</span>channels[i], norm_cfg<span class="hljs-operator">=</span>norm_cfg)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="412"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            setattr(<span class="hljs-keyword">self</span>, f<span class="hljs-string">"smb{i + 1}"</span>, smb)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="413"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="414"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(depths)):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="415"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            dpr <span class="hljs-operator">=</span> [x.item() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> torch.linspace(<span class="hljs-number">0</span>, drop_path_rate, depths[i])]  # stochastic depth decay rule</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="416"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            trans <span class="hljs-operator">=</span> SeaformerBasicLayer(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="417"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">block</span>_num<span class="hljs-operator">=</span>depths[i],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="418"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                embedding_dim<span class="hljs-operator">=</span>emb_dims[i],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="419"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">key</span>_dim<span class="hljs-operator">=</span><span class="hljs-keyword">key</span>_dims[i],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="420"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                num_heads<span class="hljs-operator">=</span>num_heads,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="421"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                mlp_ratio<span class="hljs-operator">=</span>mlp_ratios[i],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="422"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                attn_ratio<span class="hljs-operator">=</span>attn_ratios,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="423"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>, attn_drop<span class="hljs-operator">=</span><span class="hljs-number">0</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="424"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                drop_path<span class="hljs-operator">=</span>dpr,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="425"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                norm_cfg<span class="hljs-operator">=</span>norm_cfg,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="426"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                act_layer<span class="hljs-operator">=</span>act_layer)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="427"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            setattr(<span class="hljs-keyword">self</span>, f<span class="hljs-string">"trans{i + 1}"</span>, trans)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="428"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="429"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.linear <span class="hljs-operator">=</span> nn.Linear(channels[-<span class="hljs-number">1</span>], <span class="hljs-number">1000</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="430"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.avgpool <span class="hljs-operator">=</span> nn.AdaptiveAvgPool<span class="hljs-number">2</span>d((<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="431"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.apply(<span class="hljs-keyword">self</span>.init_weights)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="432"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.channel <span class="hljs-operator">=</span> [i.<span class="hljs-keyword">size</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.forward(torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>))]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="433"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="434"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="435"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="436"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def init_weights(<span class="hljs-keyword">self</span>, m):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="437"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.modules():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="438"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> isinstance(m, nn.Conv<span class="hljs-number">2</span>d):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="439"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                n <span class="hljs-operator">=</span> m.kernel_<span class="hljs-keyword">size</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">*</span> m.kernel_<span class="hljs-keyword">size</span>[<span class="hljs-number">1</span>] <span class="hljs-operator">*</span> m.out_channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="440"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                n <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">=</span> m.groups</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="441"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                m.weight.<span class="hljs-keyword">data</span>.normal_(<span class="hljs-number">0</span>, math.sqrt(<span class="hljs-number">2</span>. <span class="hljs-operator">/</span> n))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="442"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> m.bias <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="443"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    m.bias.<span class="hljs-keyword">data</span>.<span class="hljs-literal">zero</span>_()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="444"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif isinstance(m, nn.BatchNorm<span class="hljs-number">2</span>d):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="445"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                m.weight.<span class="hljs-keyword">data</span>.fill_(<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="446"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                m.bias.<span class="hljs-keyword">data</span>.<span class="hljs-literal">zero</span>_()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="447"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif isinstance(m, nn.Linear):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="448"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                m.weight.<span class="hljs-keyword">data</span>.normal_(<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="449"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> m.bias <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="450"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    m.bias.<span class="hljs-keyword">data</span>.<span class="hljs-literal">zero</span>_()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="451"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="452"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="453"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_smb_stage <span class="hljs-operator">=</span> len(<span class="hljs-keyword">self</span>.cfgs)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="454"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_trans_stage <span class="hljs-operator">=</span> len(<span class="hljs-keyword">self</span>.depths)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="455"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(num_smb_stage):        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="456"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            smb <span class="hljs-operator">=</span> getattr(<span class="hljs-keyword">self</span>, f<span class="hljs-string">"smb{i + 1}"</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="457"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> smb(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="458"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> num_trans_stage <span class="hljs-operator">+</span> i <span class="hljs-operator">&gt;=</span> num_smb_stage:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="459"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                trans <span class="hljs-operator">=</span> getattr(<span class="hljs-keyword">self</span>, f<span class="hljs-string">"trans{i + num_trans_stage - num_smb_stage + 1}"</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="460"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                x <span class="hljs-operator">=</span> trans(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="461"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="462"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.avgpool(x).view(-<span class="hljs-number">1</span>, x.shape[<span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="463"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.linear(out)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="464"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> out</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="465"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="466"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="467"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">@register_model</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="468"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def SeaFormer_T(pretrained<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, <span class="hljs-operator">**</span>kwargs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="469"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    model_cfgs <span class="hljs-operator">=</span> dict(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="470"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">1</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="471"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # k,  t,  c, s</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="472"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>], </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="473"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">16</span>, <span class="hljs-number">2</span>], </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="474"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>]], </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="475"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">2</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="476"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">2</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="477"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">1</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="478"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">3</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="479"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">2</span>], </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="480"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">1</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="481"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">4</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="482"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">2</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="483"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">5</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="484"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">160</span>, <span class="hljs-number">2</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="485"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>[<span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">160</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="486"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span><span class="hljs-number">4</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="487"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>[<span class="hljs-number">2</span>, <span class="hljs-number">2</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="488"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>[<span class="hljs-number">128</span>, <span class="hljs-number">160</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="489"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>[<span class="hljs-number">16</span>, <span class="hljs-number">24</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="490"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span><span class="hljs-number">0.1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="491"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span><span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="492"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="493"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> SeaFormer(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="494"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfgs<span class="hljs-operator">=</span>[model_cfgs[<span class="hljs-string">'cfg1'</span>], model_cfgs[<span class="hljs-string">'cfg2'</span>], model_cfgs[<span class="hljs-string">'cfg3'</span>], model_cfgs[<span class="hljs-string">'cfg4'</span>], model_cfgs[<span class="hljs-string">'cfg5'</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="495"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'channels'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="496"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'emb_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="497"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'key_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="498"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'depths'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="499"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'attn_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="500"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'mlp_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="501"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'num_heads'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="502"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'drop_path_rate'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="503"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="504"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="505"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">@register_model</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="506"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def SeaFormer_S(pretrained<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, <span class="hljs-operator">**</span>kwargs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="507"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    model_cfgs <span class="hljs-operator">=</span> dict(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="508"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">1</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="509"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # k,  t,  c, s</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="510"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="511"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">24</span>, <span class="hljs-number">2</span>], </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="512"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">24</span>, <span class="hljs-number">1</span>]], </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="513"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">2</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="514"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">48</span>, <span class="hljs-number">2</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="515"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">48</span>, <span class="hljs-number">1</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="516"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">3</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="517"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">96</span>, <span class="hljs-number">2</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="518"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">96</span>, <span class="hljs-number">1</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="519"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">4</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="520"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">160</span>, <span class="hljs-number">2</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="521"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">5</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="522"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">192</span>, <span class="hljs-number">2</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="523"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>[<span class="hljs-number">16</span>, <span class="hljs-number">24</span>, <span class="hljs-number">48</span>, <span class="hljs-number">96</span>, <span class="hljs-number">160</span>, <span class="hljs-number">192</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="524"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span><span class="hljs-number">6</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="525"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>[<span class="hljs-number">3</span>, <span class="hljs-number">3</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="526"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>[<span class="hljs-number">16</span>, <span class="hljs-number">24</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="527"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>[<span class="hljs-number">160</span>, <span class="hljs-number">192</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="528"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span><span class="hljs-number">0.1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="529"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span><span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="530"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="531"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> SeaFormer(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="532"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfgs<span class="hljs-operator">=</span>[model_cfgs[<span class="hljs-string">'cfg1'</span>], model_cfgs[<span class="hljs-string">'cfg2'</span>], model_cfgs[<span class="hljs-string">'cfg3'</span>], model_cfgs[<span class="hljs-string">'cfg4'</span>], model_cfgs[<span class="hljs-string">'cfg5'</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="533"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'channels'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="534"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'emb_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="535"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'key_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="536"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'depths'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="537"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'attn_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="538"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'mlp_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="539"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'num_heads'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="540"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'drop_path_rate'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="541"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="542"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="543"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">@register_model</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="544"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def SeaFormer_B(pretrained<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, <span class="hljs-operator">**</span>kwargs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="545"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    model_cfgs <span class="hljs-operator">=</span> dict(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="546"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">1</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="547"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # k,  t,  c, s</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="548"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="549"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">32</span>, <span class="hljs-number">2</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="550"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">1</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="551"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">2</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="552"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">2</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="553"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">1</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="554"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">3</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="555"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">2</span>],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="556"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="557"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">4</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="558"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">192</span>, <span class="hljs-number">2</span>]],  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="559"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">5</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="560"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="561"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>[<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">192</span>, <span class="hljs-number">256</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="562"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span><span class="hljs-number">8</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="563"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>[<span class="hljs-number">4</span>, <span class="hljs-number">4</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="564"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>[<span class="hljs-number">16</span>, <span class="hljs-number">24</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="565"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>[<span class="hljs-number">192</span>, <span class="hljs-number">256</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="566"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span><span class="hljs-number">0.1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="567"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span><span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="568"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="569"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> SeaFormer(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="570"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfgs<span class="hljs-operator">=</span>[model_cfgs[<span class="hljs-string">'cfg1'</span>], model_cfgs[<span class="hljs-string">'cfg2'</span>], model_cfgs[<span class="hljs-string">'cfg3'</span>], model_cfgs[<span class="hljs-string">'cfg4'</span>], model_cfgs[<span class="hljs-string">'cfg5'</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="571"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'channels'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="572"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'emb_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="573"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'key_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="574"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'depths'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="575"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'attn_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="576"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'mlp_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="577"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'num_heads'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="578"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'drop_path_rate'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="579"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="580"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="581"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">@register_model</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="582"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def SeaFormer_L(pretrained<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, <span class="hljs-operator">**</span>kwargs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="583"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    model_cfgs <span class="hljs-operator">=</span> dict(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="584"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">1</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="585"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            # k,  t,  c, s</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="586"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">1</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="587"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">64</span>, <span class="hljs-number">2</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="588"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">64</span>, <span class="hljs-number">1</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="589"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">2</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="590"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">128</span>, <span class="hljs-number">2</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="591"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="592"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">3</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="593"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">192</span>, <span class="hljs-number">2</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="594"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">192</span>, <span class="hljs-number">1</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="595"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">4</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="596"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="597"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfg<span class="hljs-number">5</span><span class="hljs-operator">=</span>[</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="598"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">320</span>, <span class="hljs-number">2</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="599"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>[<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">192</span>, <span class="hljs-number">256</span>, <span class="hljs-number">320</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="600"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span><span class="hljs-number">8</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="601"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>[<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="602"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>[<span class="hljs-number">16</span>, <span class="hljs-number">20</span>, <span class="hljs-number">24</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="603"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>[<span class="hljs-number">192</span>, <span class="hljs-number">256</span>, <span class="hljs-number">320</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="604"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span><span class="hljs-number">0.1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="605"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span><span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="606"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>[<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="607"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> SeaFormer(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="608"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cfgs<span class="hljs-operator">=</span>[model_cfgs[<span class="hljs-string">'cfg1'</span>], model_cfgs[<span class="hljs-string">'cfg2'</span>], model_cfgs[<span class="hljs-string">'cfg3'</span>], model_cfgs[<span class="hljs-string">'cfg4'</span>], model_cfgs[<span class="hljs-string">'cfg5'</span>]],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="609"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        channels<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'channels'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="610"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        emb_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'emb_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="611"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">key</span>_dims<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'key_dims'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="612"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        depths<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'depths'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="613"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'attn_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="614"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mlp_ratios<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'mlp_ratios'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="615"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        num_heads<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'num_heads'</span>],</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="616"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        drop_path_rate<span class="hljs-operator">=</span>model_cfgs[<span class="hljs-string">'drop_path_rate'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="617"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="618"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">if</span> __name__ <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'__main__'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="619"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    model <span class="hljs-operator">=</span> SeaFormer_L()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="620"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#    ck <span class="hljs-operator">=</span> torch.load(<span class="hljs-string">'model.pth.tar'</span>, map_<span class="hljs-keyword">location</span><span class="hljs-operator">=</span><span class="hljs-string">'cpu'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="621"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#    model.load_state_dict(ck[<span class="hljs-string">'state_dict_ema'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="622"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">input</span> <span class="hljs-operator">=</span> torch.rand((<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="623"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    print(model)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="624"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">from</span> fvcore.nn import FlopCountAnalysis, flop_<span class="hljs-keyword">count</span>_<span class="hljs-keyword">table</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="625"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    model.eval()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="626"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    flops <span class="hljs-operator">=</span> FlopCountAnalysis(model, <span class="hljs-keyword">input</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="627"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    print(flop_<span class="hljs-keyword">count</span>_<span class="hljs-keyword">table</span>(flops))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="628"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3 id="%C2%A02.2%20yolo.py%E6%B3%A8%E5%86%8C"><a name="t8"></a>&nbsp;2.2 tasks.py注册</h3> 
<pre data-index="1"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> ultralytics.<span class="hljs-property">nn</span>.<span class="hljs-property">attention</span>.<span class="hljs-property">seaformer</span> <span class="hljs-keyword">import</span> C2f_SeaformerBlock,<span class="hljs-title class_">Sea</span>_AttentionBlock</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<pre data-index="2">def parse_model(d, ch, verbose=True):  # model_dict, input_channels(3)</pre> 
<pre data-index="3"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1313px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (Classify, Conv, ConvTranspose, GhostConv, Bottleneck, GhostBottleneck, SPP, SPPF, DWConv, Focus,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 BottleneckCSP, C<span class="hljs-number">1</span>, C<span class="hljs-number">2</span>, C<span class="hljs-number">2</span>f, C<span class="hljs-number">3</span>, C<span class="hljs-number">3</span>TR, C<span class="hljs-number">3</span>Ghost, nn.ConvTranspose<span class="hljs-number">2</span>d, DWConvTranspose<span class="hljs-number">2</span>d, C<span class="hljs-number">3</span>x, C<span class="hljs-number">2</span>f_SeaformerBlock,Sea_AttentionBlock):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>[f], args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> !<span class="hljs-operator">=</span> nc:  # <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">equal</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes (i.e. <span class="hljs-keyword">for</span> Classify() <span class="hljs-keyword">output</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> make_divisible(min(c<span class="hljs-number">2</span>, max_channels) <span class="hljs-operator">*</span> width, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, <span class="hljs-operator">*</span>args[<span class="hljs-number">1</span>:]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (BottleneckCSP, C<span class="hljs-number">1</span>, C<span class="hljs-number">2</span>, C<span class="hljs-number">2</span>f, C<span class="hljs-number">3</span>, C<span class="hljs-number">3</span>TR, C<span class="hljs-number">3</span>Ghost, C<span class="hljs-number">3</span>x,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                     C<span class="hljs-number">2</span>f_SeaformerBlock,Sea_AttentionBlock):</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3 id="2.3%C2%A0%C2%A0yolov5s_C2f_SeaformerBlock.yaml"><a name="t9"></a>2.3&nbsp;&nbsp;yolov8_Sea_Attention.yaml</h3> 
<pre data-index="4" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1052px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Ultralytics YOLO 🚀, GPL-<span class="hljs-number">3.0</span> license</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8</span> <span class="hljs-keyword">object</span> detection model <span class="hljs-keyword">with</span> P<span class="hljs-number">3</span>-P<span class="hljs-number">5</span> outputs. <span class="hljs-keyword">For</span> <span class="hljs-keyword">Usage</span> examples see https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>docs.ultralytics.com<span class="hljs-operator">/</span>tasks<span class="hljs-operator">/</span>detect</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Parameters</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">nc: <span class="hljs-number">1</span>  # <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">scales: # model compound scaling constants, i.e. <span class="hljs-string">'model=yolov8n.yaml'</span> will <span class="hljs-keyword">call</span> yolov<span class="hljs-number">8</span>.yaml <span class="hljs-keyword">with</span> scale <span class="hljs-string">'n'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [depth, width, max_channels]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  n: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>n summary: <span class="hljs-number">225</span> layers,  <span class="hljs-number">3157200</span> parameters,  <span class="hljs-number">3157184</span> gradients,   <span class="hljs-number">8.9</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  s: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.50</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>s summary: <span class="hljs-number">225</span> layers, <span class="hljs-number">11166560</span> parameters, <span class="hljs-number">11166544</span> gradients,  <span class="hljs-number">28.8</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  m: [<span class="hljs-number">0.67</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">768</span>]   # YOLOv<span class="hljs-number">8</span>m summary: <span class="hljs-number">295</span> layers, <span class="hljs-number">25902640</span> parameters, <span class="hljs-number">25902624</span> gradients,  <span class="hljs-number">79.3</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  l: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>l summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">43691520</span> parameters, <span class="hljs-number">43691504</span> gradients, <span class="hljs-number">165.7</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  x: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>x summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">68229648</span> parameters, <span class="hljs-number">68229632</span> gradients, <span class="hljs-number">258.5</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n backbone</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">backbone:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [<span class="hljs-keyword">from</span>, repeats, module, args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">0</span>-P<span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">1</span>-P<span class="hljs-number">2</span><span class="hljs-operator">/</span><span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">128</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">3</span>-P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">5</span>-P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">7</span>-P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, SPPF, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]]  # <span class="hljs-number">9</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n head</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">head:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">12</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Sea_AttentionBlock, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">13</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>]]  # <span class="hljs-number">15</span> (P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span>-small)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Sea_AttentionBlock, [<span class="hljs-number">256</span>]]  # <span class="hljs-number">17</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">13</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">18</span> (P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span>-medium)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Sea_AttentionBlock, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">21</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">9</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>]]  # <span class="hljs-number">21</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Sea_AttentionBlock, [<span class="hljs-number">1024</span>]]  # <span class="hljs-number">25</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">17</span>, <span class="hljs-number">21</span>, <span class="hljs-number">25</span>], <span class="hljs-number">1</span>, Detect, [nc]]  # Detect(P<span class="hljs-number">3</span>, P<span class="hljs-number">4</span>, P<span class="hljs-number">5</span>)</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3 id="2.4%C2%A0yolov5s_Sea_AttentionBlock.yaml"><a name="t10"></a></h3> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/131122041&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>