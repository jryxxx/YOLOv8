<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-044f2cf1dc.css">
                <div id="content_views" class="htmledit_views">
                    <p>💡💡💡<strong>本文全网首发独家改进：<span style="color:#fe2c24;">提出新颖的注意力BSAM（BiLevel Spatial&nbsp;&nbsp;Attention Module），创新度极佳，适合科研创新，</span>效果秒杀CBAM，</strong>Channel Attention+Spartial Attention升级为新颖的&nbsp;<strong><span style="color:#fe2c24;">BiLevel </span></strong>&nbsp;&nbsp;Attention+Spartial Attention</p> 
<p>&nbsp;1）作为注意力BSAM使用；</p> 
<p>推荐指数：五星</p> 
<p><span style="color:#fe2c24;"><strong>BSAM | &nbsp; 亲测在多个数据集能够实现涨点，多尺度特性在小目标检测表现也十分出色。</strong></span></p> 
<p><img alt="" height="273" src="https://img-blog.csdnimg.cn/fdaac352f0ef4ab5ba311b149c410448.png" width="852"></p> 
<p>💡💡💡Yolov8魔术师，独家首发创新（原创），适用于Yolov5、Yolov7、Yolov8等各个Yolo系列，专栏文章提供每一步步骤和源码，轻松带你上手魔改网络</p> 
<p>💡💡💡重点：通过本专栏的阅读，后续你也可以自己魔改网络，在网络不同位置（Backbone、head、detect、loss等）进行魔改，实现创新！！！</p> 
<p>专栏介绍：</p> 
<p>https://blog.csdn.net/m0_63774211/category_12289773.html</p> 
<p>✨✨✨原创魔改网络、复现前沿论文，组合优化创新</p> 
<p>🚀🚀🚀小目标、遮挡物、难样本性能提升</p> 
<p>🍉🍉🍉持续更新中，定期更新不同<a href="https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;数据集\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;数据集\&quot;}&quot;}" data-tit="数据集" data-pretit="数据集">数据集</a>涨点情况<br> &nbsp;</p> 
<h2><a name="t0"></a>1.原理介绍</h2> 
<p></p> 
<h3><a name="t1"></a>1.1.<a href="https://so.csdn.net/so/search?q=CBAM&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=CBAM&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;CBAM\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=CBAM&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;CBAM\&quot;}&quot;}" data-tit="CBAM" data-pretit="cbam">CBAM</a>：通道注意力和空间注意力的集成者</h3> 
<p>轻量级的卷积<a href="https://so.csdn.net/so/search?q=%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%A8%A1%E5%9D%97&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%A8%A1%E5%9D%97&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;注意力模块\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%A8%A1%E5%9D%97&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;注意力模块\&quot;}&quot;}" data-tit="注意力模块" data-pretit="注意力模块">注意力模块</a>，它结合了通道和空间的注意力机制模块</p> 
<p><strong>论文题目：《CBAM: Convolutional Block Attention Module》<br> 论文地址： &nbsp;https://arxiv.org/pdf/1807.06521.pdf</strong></p> 
<p><img alt="" src="https://img-blog.csdnimg.cn/img_convert/76d4eef819c1798c46d37cacb2d31ff7.png"></p> 
<p>上图可以看到，CBAM包含CAM（Channel Attention Module）和SAM（Spartial Attention Module）两个子模块，分别进行通道和空间上的Attention。这样不只能够节约参数和计算力，并且保证了其能够做为即插即用的模块集成到现有的网络架构中去。</p> 
<h3 id="main-toc"><a name="t2"></a><strong>&nbsp;&nbsp;</strong>1.2 BiFormer介绍</h3> 
<p><img alt="" height="152" src="https://img-blog.csdnimg.cn/3f050f6ca26a4b4eb00d67666682eb19.png" width="598"></p> 
<p></p> 
<p>论文：<a href="https://arxiv.org/pdf/2303.08810.pdf" title="https://arxiv.org/pdf/2303.08810.pdf">https://arxiv.org/pdf/2303.08810.pdf</a></p> 
<p>本文方法：本文提出一种动态稀疏注意力的双层路由方法。对于一个查询，首先在粗略的区域级别上过滤掉不相关的键值对，然后在剩余候选区域（即路由区域）的并集中应用细粒度的令牌对令牌关注力。所提出的双层路由注意力具有简单而有效的实现方式，利用稀疏性来节省计算和内存，只涉及GPU友好的密集矩阵乘法。在此基础上构建了一种新的通用Vision Transformer，称为BiFormer。</p> 
<p><img alt="" height="493" src="https://img-blog.csdnimg.cn/56566f82018c473ca73b16ce41b47a36.png" width="678">​</p> 
<p>&nbsp;其中图(a)是原始的注意力实现，其直接在全局范围内操作，导致高计算复杂性和大量内存占用；而对于图(b)-(d)，这些方法通过引入具有不同手工模式的稀疏注意力来减轻复杂性，例如局部窗口、轴向条纹和扩张窗口等；而图(e)则是基于可变形注意力通过不规则网格来实现图像自适应稀疏性；作者认为以上这些方法大都是通过将 手工制作 和 与内容无关 的稀疏性引入到注意力机制来试图缓解这个问题。因此，本文通过双层路由(<code>bi-level routing</code>)提出了一种新颖的<strong>动态稀疏注意力</strong>(<code>dynamic sparse attention&nbsp;</code>)，以实现更灵活的<strong>计算分配</strong>和<strong>内容感知</strong>，使其具备动态的查询感知稀疏性，如图(f)所示。</p> 
<p><img alt="" height="235" src="https://img-blog.csdnimg.cn/adc44bd4688b427395d1b3f7c817d750.png" width="830">​</p> 
<p></p> 
<p>基于<code>BRA</code>模块，本文构建了一种新颖的通用视觉转换器<code>BiFormer</code>。如上图所示，其遵循大多数的<code>vision transformer</code>架构设计，也是采用四级金字塔结构，即下采样32倍。</p> 
<p>具体来说，<code>BiFormer</code>在第一阶段使用重叠块嵌入，在第二到第四阶段使用块合并模块来降低输入空间分辨率，同时增加通道数，然后是采用连续的<code>BiFormer</code>块做特征变换。需要注意的是，在每个块的开始均是使用 的深度卷积来隐式编码相对位置信息。随后依次应用<code>BRA</code>模块和扩展率为 的 2 层 多层感知机(<code>Multi-Layer Perceptron, MLP</code>)模块，分别用于交叉位置关系建模和每个位置嵌</p> 
<p></p> 
<p><img alt="" height="308" src="https://img-blog.csdnimg.cn/5b0be6e4899647d2b4551c364972871a.png" width="836">​</p> 
<h2><a name="t3"></a>2.如何改进创新</h2> 
<p>将<strong>channel Attention Module替换为BiLevelRoutingAttention，命名为&nbsp;BiLevelRouting Spatial&nbsp;&nbsp;Attention Module简称BSAM</strong></p> 
<p><img alt="" height="273" src="https://img-blog.csdnimg.cn/92b3eb4640054c2984dc6a7fd7790110.png" width="852"></p> 
<h2><a name="t4"></a>3.BSAM加入&nbsp;YOLOv8</h2> 
<h3><a name="t5"></a>3.1&nbsp;BSAM加入ultralytics/nn/attention/BiFormer_CBAM.py</h3> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln hundred" style="width:1370px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">######################  BiLevelRoutingAttention  ####  AI<span class="hljs-operator">&amp;</span>CV   <span class="hljs-keyword">start</span> ###############################</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn <span class="hljs-keyword">as</span> nn</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> torch import Tensor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> typing import Tuple</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn.functional <span class="hljs-keyword">as</span> F</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> einops import rearrange</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def autopad(k, p<span class="hljs-operator">=</span>None, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>):  # kernel, padding, dilation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Pad <span class="hljs-keyword">to</span> <span class="hljs-string">'same'</span> shape outputs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> d <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k <span class="hljs-operator">=</span> d <span class="hljs-operator">*</span> (k<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [d <span class="hljs-operator">*</span> (x<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # actual kernel-size</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> p <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p <span class="hljs-operator">=</span> k <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> isinstance(k, int) <span class="hljs-keyword">else</span> [x <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> k]  # auto-pad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> p</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Conv(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Standard</span> convolution <span class="hljs-keyword">with</span> args(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_out, kernel, stride, padding, groups, dilation, activation)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">default</span>_act <span class="hljs-operator">=</span> nn.SiLU()  # <span class="hljs-keyword">default</span> activation</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k<span class="hljs-operator">=</span><span class="hljs-number">1</span>, s<span class="hljs-operator">=</span><span class="hljs-number">1</span>, p<span class="hljs-operator">=</span>None, g<span class="hljs-operator">=</span><span class="hljs-number">1</span>, d<span class="hljs-operator">=</span><span class="hljs-number">1</span>, act<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, k, s, autopad(k, p, d), groups<span class="hljs-operator">=</span>g, dilation<span class="hljs-operator">=</span>d, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.bn <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(c<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">default</span>_act <span class="hljs-keyword">if</span> act <span class="hljs-keyword">is</span> <span class="hljs-keyword">True</span> <span class="hljs-keyword">else</span> act <span class="hljs-keyword">if</span> isinstance(act, nn.Module) <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.bn(<span class="hljs-keyword">self</span>.conv(x)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward_fuse(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.conv(x))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SpatialAttention(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Spatial-attention module</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert kernel_<span class="hljs-keyword">size</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">3</span>, <span class="hljs-number">7</span>), <span class="hljs-string">'kernel size must be 3 or 7'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        padding <span class="hljs-operator">=</span> <span class="hljs-number">3</span> <span class="hljs-keyword">if</span> kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">7</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span> <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, kernel_<span class="hljs-keyword">size</span>, padding<span class="hljs-operator">=</span>padding, bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> nn.Sigmoid()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.cv<span class="hljs-number">1</span>(torch.cat([torch.mean(x, <span class="hljs-number">1</span>, keepdim<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>), torch.max(x, <span class="hljs-number">1</span>, keepdim<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)[<span class="hljs-number">0</span>]], <span class="hljs-number">1</span>)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> ChannelAttentionModule(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, reduction<span class="hljs-operator">=</span><span class="hljs-number">16</span>, light<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(ChannelAttentionModule, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mid_channel <span class="hljs-operator">=</span> c<span class="hljs-number">1</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> reduction</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.light <span class="hljs-operator">=</span> light</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.avg_pool <span class="hljs-operator">=</span> nn.AdaptiveAvgPool<span class="hljs-number">2</span>d(<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.light:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.max_pool <span class="hljs-operator">=</span> nn.AdaptiveMaxPool<span class="hljs-number">2</span>d(<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.shared_MLP <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                nn.Linear(<span class="hljs-keyword">in</span>_features<span class="hljs-operator">=</span>c<span class="hljs-number">1</span>, out_features<span class="hljs-operator">=</span>mid_channel),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                nn.LeakyReLU(<span class="hljs-number">0.1</span>, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                nn.Linear(<span class="hljs-keyword">in</span>_features<span class="hljs-operator">=</span>mid_channel, out_features<span class="hljs-operator">=</span>c<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.shared_MLP <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(c<span class="hljs-number">1</span>, c<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> nn.Sigmoid()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.light:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            avgout <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.shared_MLP(<span class="hljs-keyword">self</span>.avg_pool(x).view(x.<span class="hljs-keyword">size</span>(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>)).unsqueeze(<span class="hljs-number">2</span>).unsqueeze(<span class="hljs-number">3</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            maxout <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.shared_MLP(<span class="hljs-keyword">self</span>.max_pool(x).view(x.<span class="hljs-keyword">size</span>(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>)).unsqueeze(<span class="hljs-number">2</span>).unsqueeze(<span class="hljs-number">3</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            fc_out <span class="hljs-operator">=</span> (avgout <span class="hljs-operator">+</span> maxout)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            fc_out <span class="hljs-operator">=</span> (<span class="hljs-keyword">self</span>.shared_MLP(<span class="hljs-keyword">self</span>.avg_pool(x)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.act(fc_out)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> TopkRouting(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    differentiable topk routing with scaling</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        qk_dim: int, feature dimension of query and key</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        topk: int, the 'topk'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        qk_scale: int or None, temperature (multiply) of softmax activation</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        with_param: bool, wether inorporate learnable params in routing unit</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        diff_routing: bool, wether make routing differentiable</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        soft_routing: bool, wether make output value multiplied by routing weights</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, qk_dim, topk<span class="hljs-operator">=</span><span class="hljs-number">4</span>, qk_scale<span class="hljs-operator">=</span>None, param_routing<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, diff_routing<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.topk <span class="hljs-operator">=</span> topk</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.qk_dim <span class="hljs-operator">=</span> qk_dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.scale <span class="hljs-operator">=</span> qk_scale <span class="hljs-keyword">or</span> qk_dim <span class="hljs-operator">**</span> -<span class="hljs-number">0.5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.diff_routing <span class="hljs-operator">=</span> diff_routing</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.emb <span class="hljs-operator">=</span> nn.Linear(qk_dim, qk_dim) <span class="hljs-keyword">if</span> param_routing <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.routing_act <span class="hljs-operator">=</span> nn.Softmax(dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, query: Tensor, <span class="hljs-keyword">key</span>: Tensor) -<span class="hljs-operator">&gt;</span> Tuple[Tensor]:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">self</span>.diff_routing:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            query, <span class="hljs-keyword">key</span> <span class="hljs-operator">=</span> query.detach(), <span class="hljs-keyword">key</span>.detach()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        query_hat, <span class="hljs-keyword">key</span>_hat <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.emb(query), <span class="hljs-keyword">self</span>.emb(<span class="hljs-keyword">key</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_logit <span class="hljs-operator">=</span> (query_hat <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.scale) @ <span class="hljs-keyword">key</span>_hat.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        topk_attn_logit, topk_<span class="hljs-keyword">index</span> <span class="hljs-operator">=</span> torch.topk(attn_logit, k<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.topk, dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        r_weight <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.routing_act(topk_attn_logit)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> r_weight, topk_<span class="hljs-keyword">index</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> KVGather(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, mul_weight<span class="hljs-operator">=</span><span class="hljs-string">'none'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert mul_weight <span class="hljs-keyword">in</span> [<span class="hljs-string">'none'</span>, <span class="hljs-string">'soft'</span>, <span class="hljs-string">'hard'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.mul_weight <span class="hljs-operator">=</span> mul_weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, r_idx: Tensor, r_weight: Tensor, kv: Tensor):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        n, p<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, c_kv <span class="hljs-operator">=</span> kv.<span class="hljs-keyword">size</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        topk <span class="hljs-operator">=</span> r_idx.<span class="hljs-keyword">size</span>(-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        topk_kv <span class="hljs-operator">=</span> torch.gather(kv.view(n, <span class="hljs-number">1</span>, p<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, c_kv).expand(-<span class="hljs-number">1</span>, p<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                               dim<span class="hljs-operator">=</span><span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                               <span class="hljs-keyword">index</span><span class="hljs-operator">=</span>r_idx.view(n, p<span class="hljs-number">2</span>, topk, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).expand(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, w<span class="hljs-number">2</span>, c_kv)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                               )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.mul_weight <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'soft'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            topk_kv <span class="hljs-operator">=</span> r_weight.view(n, p<span class="hljs-number">2</span>, topk, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) <span class="hljs-operator">*</span> topk_kv</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.mul_weight <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'hard'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">'differentiable hard routing TBA'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> topk_kv</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> QKVLinear(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, dim, qk_dim, bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dim <span class="hljs-operator">=</span> dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.qk_dim <span class="hljs-operator">=</span> qk_dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.qkv <span class="hljs-operator">=</span> nn.Linear(dim, qk_dim <span class="hljs-operator">+</span> qk_dim <span class="hljs-operator">+</span> dim, bias<span class="hljs-operator">=</span>bias)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        q, kv <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.qkv(x).split([<span class="hljs-keyword">self</span>.qk_dim, <span class="hljs-keyword">self</span>.qk_dim <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.dim], dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> q, kv</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BiLevelRoutingAttention(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    n_win: number of windows in one side (so the actual number of windows is n_win*n_win)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    kv_per_win: for kv_downsample_mode='ada_xxxpool' only, number of key/values per window. Similar to n_win, the actual number is kv_per_win*kv_per_win.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    topk: topk for window filtering</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    param_attention: 'qkvo'-linear for q,k,v and o, 'none': param free attention</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    param_routing: extra linear for routing</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    diff_routing: wether to set routing differentiable</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    soft_routing: wether to multiply soft routing weights</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, dim, n_win<span class="hljs-operator">=</span><span class="hljs-number">7</span>, num_heads<span class="hljs-operator">=</span><span class="hljs-number">8</span>, qk_dim<span class="hljs-operator">=</span>None, qk_scale<span class="hljs-operator">=</span>None,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 kv_per_win<span class="hljs-operator">=</span><span class="hljs-number">4</span>, kv_downsample_ratio<span class="hljs-operator">=</span><span class="hljs-number">4</span>, kv_downsample_kernel<span class="hljs-operator">=</span>None, kv_downsample_<span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'identity'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 topk<span class="hljs-operator">=</span><span class="hljs-number">4</span>, param_attention<span class="hljs-operator">=</span><span class="hljs-string">"qkvo"</span>, param_routing<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, diff_routing<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, soft_routing<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 side_dwconv<span class="hljs-operator">=</span><span class="hljs-number">3</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 auto_pad<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.dim <span class="hljs-operator">=</span> dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.n_win <span class="hljs-operator">=</span> n_win  # Wh, Ww</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.num_heads <span class="hljs-operator">=</span> num_heads</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.qk_dim <span class="hljs-operator">=</span> qk_dim <span class="hljs-keyword">or</span> dim</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert <span class="hljs-keyword">self</span>.qk_dim % num_heads <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">self</span>.dim % num_heads <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>, <span class="hljs-string">'qk_dim and dim must be divisible by num_heads!'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.scale <span class="hljs-operator">=</span> qk_scale <span class="hljs-keyword">or</span> <span class="hljs-keyword">self</span>.qk_dim <span class="hljs-operator">**</span> -<span class="hljs-number">0.5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.lepe <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(dim, dim, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>side_dwconv, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, padding<span class="hljs-operator">=</span>side_dwconv <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                              groups<span class="hljs-operator">=</span>dim) <span class="hljs-keyword">if</span> side_dwconv <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            lambda x: torch.<span class="hljs-literal">zeros</span>_like(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.topk <span class="hljs-operator">=</span> topk</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.param_routing <span class="hljs-operator">=</span> param_routing</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.diff_routing <span class="hljs-operator">=</span> diff_routing</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.soft_routing <span class="hljs-operator">=</span> soft_routing</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # router</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert <span class="hljs-keyword">not</span> (<span class="hljs-keyword">self</span>.param_routing <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">self</span>.diff_routing)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.router <span class="hljs-operator">=</span> TopkRouting(qk_dim<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.qk_dim,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                  qk_scale<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.scale,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                  topk<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.topk,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                  diff_routing<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.diff_routing,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                  param_routing<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.param_routing)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.soft_routing:  # soft routing, always diffrentiable (<span class="hljs-keyword">if</span> <span class="hljs-keyword">no</span> detach)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            mul_weight <span class="hljs-operator">=</span> <span class="hljs-string">'soft'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.diff_routing:  # hard differentiable routing</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            mul_weight <span class="hljs-operator">=</span> <span class="hljs-string">'hard'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:  # hard non-differentiable routing</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            mul_weight <span class="hljs-operator">=</span> <span class="hljs-string">'none'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.kv_gather <span class="hljs-operator">=</span> KVGather(mul_weight<span class="hljs-operator">=</span>mul_weight)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # qkv mapping (shared <span class="hljs-keyword">by</span> both <span class="hljs-keyword">global</span> routing <span class="hljs-keyword">and</span> local attention)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.param_attention <span class="hljs-operator">=</span> param_attention</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.param_attention <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'qkvo'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.qkv <span class="hljs-operator">=</span> QKVLinear(<span class="hljs-keyword">self</span>.dim, <span class="hljs-keyword">self</span>.qk_dim)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.wo <span class="hljs-operator">=</span> nn.Linear(dim, dim)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.param_attention <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'qkv'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.qkv <span class="hljs-operator">=</span> QKVLinear(<span class="hljs-keyword">self</span>.dim, <span class="hljs-keyword">self</span>.qk_dim)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.wo <span class="hljs-operator">=</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> ValueError(f<span class="hljs-string">'param_attention mode {self.param_attention} is not surpported!'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span> kv_downsample_<span class="hljs-keyword">mode</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.kv_per_win <span class="hljs-operator">=</span> kv_per_win</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.kv_downsample_ratio <span class="hljs-operator">=</span> kv_downsample_ratio</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.kv_downsample_kenel <span class="hljs-operator">=</span> kv_downsample_kernel</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'ada_avgpool'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert <span class="hljs-keyword">self</span>.kv_per_win <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.kv_<span class="hljs-keyword">down</span> <span class="hljs-operator">=</span> nn.AdaptiveAvgPool<span class="hljs-number">2</span>d(<span class="hljs-keyword">self</span>.kv_per_win)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'ada_maxpool'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert <span class="hljs-keyword">self</span>.kv_per_win <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.kv_<span class="hljs-keyword">down</span> <span class="hljs-operator">=</span> nn.AdaptiveMaxPool<span class="hljs-number">2</span>d(<span class="hljs-keyword">self</span>.kv_per_win)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'maxpool'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert <span class="hljs-keyword">self</span>.kv_downsample_ratio <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.kv_<span class="hljs-keyword">down</span> <span class="hljs-operator">=</span> nn.MaxPool<span class="hljs-number">2</span>d(<span class="hljs-keyword">self</span>.kv_downsample_ratio) <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.kv_downsample_ratio <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'avgpool'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert <span class="hljs-keyword">self</span>.kv_downsample_ratio <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.kv_<span class="hljs-keyword">down</span> <span class="hljs-operator">=</span> nn.AvgPool<span class="hljs-number">2</span>d(<span class="hljs-keyword">self</span>.kv_downsample_ratio) <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.kv_downsample_ratio <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'identity'</span>:  # <span class="hljs-keyword">no</span> kv downsampling</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.kv_<span class="hljs-keyword">down</span> <span class="hljs-operator">=</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif <span class="hljs-keyword">self</span>.kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'fracpool'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">'fracpool policy is not implemented yet!'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif kv_downsample_<span class="hljs-keyword">mode</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'conv'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">'conv policy is not implemented yet!'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> ValueError(f<span class="hljs-string">'kv_down_sample_mode {self.kv_downsaple_mode} is not surpported!'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.attn_act <span class="hljs-operator">=</span> nn.Softmax(dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.auto_pad <span class="hljs-operator">=</span> auto_pad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x, ret_attn_mask<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        x: NHWC tensor</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        Return:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            NHWC tensor</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> rearrange(x, <span class="hljs-string">"n c h w -&gt; n h w c"</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.auto_pad:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            N, H_<span class="hljs-keyword">in</span>, W_<span class="hljs-keyword">in</span>, C <span class="hljs-operator">=</span> x.<span class="hljs-keyword">size</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            pad_l <span class="hljs-operator">=</span> pad_t <span class="hljs-operator">=</span> <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            pad_r <span class="hljs-operator">=</span> (<span class="hljs-keyword">self</span>.n_win<span class="hljs-operator"> - </span>W_<span class="hljs-keyword">in</span> % <span class="hljs-keyword">self</span>.n_win) % <span class="hljs-keyword">self</span>.n_win</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            pad_b <span class="hljs-operator">=</span> (<span class="hljs-keyword">self</span>.n_win<span class="hljs-operator"> - </span>H_<span class="hljs-keyword">in</span> % <span class="hljs-keyword">self</span>.n_win) % <span class="hljs-keyword">self</span>.n_win</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> F.pad(x, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>,  # dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                          pad_l, pad_r,  # dim<span class="hljs-operator">=</span>-<span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                          pad_t, pad_b))  # dim<span class="hljs-operator">=</span>-<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            _, H, W, _ <span class="hljs-operator">=</span> x.<span class="hljs-keyword">size</span>()  # padded <span class="hljs-keyword">size</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            N, H, W, C <span class="hljs-operator">=</span> x.<span class="hljs-keyword">size</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert H % <span class="hljs-keyword">self</span>.n_win <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> W % <span class="hljs-keyword">self</span>.n_win <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>  #</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> rearrange(x, <span class="hljs-string">"n (j h) (i w) c -&gt; n (j i) h w c"</span>, j<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win, i<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        q, kv <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.qkv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        q_pix <span class="hljs-operator">=</span> rearrange(q, <span class="hljs-string">'n p2 h w c -&gt; n p2 (h w) c'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kv_pix <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.kv_<span class="hljs-keyword">down</span>(rearrange(kv, <span class="hljs-string">'n p2 h w c -&gt; (n p2) c h w'</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kv_pix <span class="hljs-operator">=</span> rearrange(kv_pix, <span class="hljs-string">'(n j i) c h w -&gt; n (j i) (h w) c'</span>, j<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win, i<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        q_win, k_win <span class="hljs-operator">=</span> q.mean([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]), kv[..., <span class="hljs-number">0</span>:<span class="hljs-keyword">self</span>.qk_dim].mean(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>])  # window-wise qk, (n, p^<span class="hljs-number">2</span>, c_qk), (n, p^<span class="hljs-number">2</span>, c_qk)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        lepe <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.lepe(rearrange(kv[..., <span class="hljs-keyword">self</span>.qk_dim:], <span class="hljs-string">'n (j i) h w c -&gt; n c (j h) (i w)'</span>, j<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                   i<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win).contiguous())</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        lepe <span class="hljs-operator">=</span> rearrange(lepe, <span class="hljs-string">'n c (j h) (i w) -&gt; n (j h) (i w) c'</span>, j<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win, i<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        r_weight, r_idx <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.router(q_win, k_win)  # both <span class="hljs-keyword">are</span> (n, p^<span class="hljs-number">2</span>, topk) tensors</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kv_pix_sel <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.kv_gather(r_idx<span class="hljs-operator">=</span>r_idx, r_weight<span class="hljs-operator">=</span>r_weight, kv<span class="hljs-operator">=</span>kv_pix)  # (n, p^<span class="hljs-number">2</span>, topk, h_kv<span class="hljs-operator">*</span>w_kv, c_qk<span class="hljs-operator">+</span>c_v)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k_pix_sel, v_pix_sel <span class="hljs-operator">=</span> kv_pix_sel.split([<span class="hljs-keyword">self</span>.qk_dim, <span class="hljs-keyword">self</span>.dim], dim<span class="hljs-operator">=</span>-<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k_pix_sel <span class="hljs-operator">=</span> rearrange(k_pix_sel, <span class="hljs-string">'n p2 k w2 (m c) -&gt; (n p2) m c (k w2)'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                              m<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.num_heads)  # flatten <span class="hljs-keyword">to</span> BMLC, (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, topk<span class="hljs-operator">*</span>h_kv<span class="hljs-operator">*</span>w_kv, c_kq<span class="hljs-operator">/</span><span class="hljs-operator">/</span>m) transpose here?</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        v_pix_sel <span class="hljs-operator">=</span> rearrange(v_pix_sel, <span class="hljs-string">'n p2 k w2 (m c) -&gt; (n p2) m (k w2) c'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                              m<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.num_heads)  # flatten <span class="hljs-keyword">to</span> BMLC, (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, topk<span class="hljs-operator">*</span>h_kv<span class="hljs-operator">*</span>w_kv, c_v<span class="hljs-operator">/</span><span class="hljs-operator">/</span>m)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        q_pix <span class="hljs-operator">=</span> rearrange(q_pix, <span class="hljs-string">'n p2 w2 (m c) -&gt; (n p2) m w2 c'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                          m<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.num_heads)  # <span class="hljs-keyword">to</span> BMLC tensor (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, w^<span class="hljs-number">2</span>, c_qk<span class="hljs-operator">/</span><span class="hljs-operator">/</span>m)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_weight <span class="hljs-operator">=</span> (</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                              q_pix <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.scale) @ k_pix_sel  # (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, w^<span class="hljs-number">2</span>, c) @ (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, c, topk<span class="hljs-operator">*</span>h_kv<span class="hljs-operator">*</span>w_kv) -<span class="hljs-operator">&gt;</span> (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, w^<span class="hljs-number">2</span>, topk<span class="hljs-operator">*</span>h_kv<span class="hljs-operator">*</span>w_kv)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        attn_weight <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.attn_act(attn_weight)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> attn_weight @ v_pix_sel  # (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, w^<span class="hljs-number">2</span>, topk<span class="hljs-operator">*</span>h_kv<span class="hljs-operator">*</span>w_kv) @ (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, topk<span class="hljs-operator">*</span>h_kv<span class="hljs-operator">*</span>w_kv, c) -<span class="hljs-operator">&gt;</span> (n<span class="hljs-operator">*</span>p^<span class="hljs-number">2</span>, m, w^<span class="hljs-number">2</span>, c)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> rearrange(out, <span class="hljs-string">'(n j i) m (h w) c -&gt; n (j h) (i w) (m c)'</span>, j<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win, i<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.n_win,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                        h<span class="hljs-operator">=</span>H <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.n_win, w<span class="hljs-operator">=</span>W <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.n_win)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> out <span class="hljs-operator">+</span> lepe</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.wo(out)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.auto_pad <span class="hljs-keyword">and</span> (pad_r <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> pad_b <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            out <span class="hljs-operator">=</span> out[:, :H_<span class="hljs-keyword">in</span>, :W_<span class="hljs-keyword">in</span>, :].contiguous()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> ret_attn_mask:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> out, r_weight, r_idx, attn_weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> rearrange(out, <span class="hljs-string">"n h w c -&gt; n c h w"</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BSAM(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Convolutional <span class="hljs-keyword">Block</span> Attention Module</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, c<span class="hljs-number">1</span>, kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">7</span>):  # <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, kernels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.channel_attention <span class="hljs-operator">=</span> BiLevelRoutingAttention(c<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.spatial_attention <span class="hljs-operator">=</span> SpatialAttention(kernel_<span class="hljs-keyword">size</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.spatial_attention(<span class="hljs-keyword">self</span>.channel_attention(x))</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h4><a name="t6"></a>2.2 注册ultralytics/nn/tasks.py</h4> 
<p>BSAM进行注册</p> 
<pre data-index="1" class="set-code-show" name="code"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> ultralytics.<span class="hljs-property">nn</span>.<span class="hljs-property">attention</span>.<span class="hljs-property">BiFormer_CBAM</span> <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">BSAM</span></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改def parse_model(d, ch, verbose=True): # model_dict, input_channels(3)</p> 
<pre data-index="2" class="set-code-show" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif m <span class="hljs-keyword">is</span> BSAM:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>[f], args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> !<span class="hljs-operator">=</span> nc:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> make_divisible(min(c<span class="hljs-number">2</span>, max_channels) <span class="hljs-operator">*</span> width, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [c<span class="hljs-number">1</span>, <span class="hljs-operator">*</span>args[<span class="hljs-number">1</span>:]]</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t7"></a>2.3&nbsp;yolov8_BSAM.yaml</h3> 
<pre data-index="3" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1052px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Ultralytics YOLO 🚀, AGPL-<span class="hljs-number">3.0</span> license</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8</span> <span class="hljs-keyword">object</span> detection model <span class="hljs-keyword">with</span> P<span class="hljs-number">3</span>-P<span class="hljs-number">5</span> outputs. <span class="hljs-keyword">For</span> <span class="hljs-keyword">Usage</span> examples see https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>docs.ultralytics.com<span class="hljs-operator">/</span>tasks<span class="hljs-operator">/</span>detect</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Parameters</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">nc: <span class="hljs-number">80</span>  # <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">scales: # model compound scaling constants, i.e. <span class="hljs-string">'model=yolov8n.yaml'</span> will <span class="hljs-keyword">call</span> yolov<span class="hljs-number">8</span>.yaml <span class="hljs-keyword">with</span> scale <span class="hljs-string">'n'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [depth, width, max_channels]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  n: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>n summary: <span class="hljs-number">225</span> layers,  <span class="hljs-number">3157200</span> parameters,  <span class="hljs-number">3157184</span> gradients,   <span class="hljs-number">8.9</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  s: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.50</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>s summary: <span class="hljs-number">225</span> layers, <span class="hljs-number">11166560</span> parameters, <span class="hljs-number">11166544</span> gradients,  <span class="hljs-number">28.8</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  m: [<span class="hljs-number">0.67</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">768</span>]   # YOLOv<span class="hljs-number">8</span>m summary: <span class="hljs-number">295</span> layers, <span class="hljs-number">25902640</span> parameters, <span class="hljs-number">25902624</span> gradients,  <span class="hljs-number">79.3</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  l: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>l summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">43691520</span> parameters, <span class="hljs-number">43691504</span> gradients, <span class="hljs-number">165.7</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  x: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>x summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">68229648</span> parameters, <span class="hljs-number">68229632</span> gradients, <span class="hljs-number">258.5</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n backbone</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">backbone:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [<span class="hljs-keyword">from</span>, repeats, module, args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">0</span>-P<span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">1</span>-P<span class="hljs-number">2</span><span class="hljs-operator">/</span><span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">128</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">3</span>-P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">5</span>-P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">7</span>-P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, SPPF, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]]  # <span class="hljs-number">9</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BSAM, [<span class="hljs-number">1024</span>]]  # <span class="hljs-number">10</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n head</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">head:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">13</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>]]  # <span class="hljs-number">16</span> (P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span>-small)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">13</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">19</span> (P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span>-medium)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">10</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>]]  # <span class="hljs-number">22</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">16</span>, <span class="hljs-number">19</span>, <span class="hljs-number">22</span>], <span class="hljs-number">1</span>, Detect, [nc]]  # Detect(P<span class="hljs-number">3</span>, P<span class="hljs-number">4</span>, P<span class="hljs-number">5</span>)</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/134140988&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>