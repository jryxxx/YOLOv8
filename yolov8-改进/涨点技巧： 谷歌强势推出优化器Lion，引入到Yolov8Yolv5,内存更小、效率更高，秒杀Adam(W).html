<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <h2><a name="t0"></a>🏆🏆🏆🏆🏆🏆🏆🏆Yolov8魔术师🏆🏆🏆🏆🏆🏆🏆🏆</h2> 
<h2><a name="t1"></a><a name="t1"></a><strong>🌟🌟🌟</strong>魔改网络和复现<a href="https://so.csdn.net/so/search?q=cvpr&amp;spm=1001.2101.3001.7020" title="cvpr">cvpr</a>等前沿论文，组合优化</h2> 
<h2><a name="t2"></a><a name="t2"></a>🚀🚀🚀在多个数据集进行验证mAP涨点明显，尤其是小目标、遮挡物精度提升明显；</h2> 
<h2><a name="t3"></a>1.Lion优化器介绍</h2> 
<p><img alt="" height="494" src="https://img-blog.csdnimg.cn/ae278fd0003e462c831ca606d80b1b6e.png" width="1051"></p> 
<p>论文：<a href="https://arxiv.org/abs/2302.06675" title="https://arxiv.org/abs/2302.06675">https://arxiv.org/abs/2302.06675</a></p> 
<p>代码：<a href="https://github.com/google/automl/tree/master/lion" title="automl/lion at master · google/automl · GitHub">automl/lion at master · google/automl · GitHub</a></p> 
<h3><a name="t4"></a>&nbsp;<strong>1.1&nbsp;&nbsp;简单、内存高效、运行速度更快</strong></h3> 
<p>1）与 <a href="https://so.csdn.net/so/search?q=AdamW&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=AdamW&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;AdamW\&quot;}&quot;}" data-tit="AdamW" data-pretit="adamw">AdamW</a> 和各种自适应优化器需要同时保存一阶和二阶矩相比，Lion 只需要动量，将额外的内存占用减半；</p> 
<p>2）由于 Lion 的简单性，Lion 在我们的实验中具有更快的运行时间（step/s），通常比 AdamW 和 Adafactor 提速 2-15%；</p> 
<p>&nbsp;<img alt="" height="241" src="https://img-blog.csdnimg.cn/bc3acd097ce14e9f9462b36ae9fb64eb.png" width="276">​&nbsp; &nbsp; &nbsp;&nbsp;<img alt="" height="242" src="https://img-blog.csdnimg.cn/122d8c1391194ead914f41655db5abf5.png" width="351">​</p> 
<h3><a name="t5"></a>&nbsp;1.2 Lion优化器在各种模型、任务和领域上的优越性能</h3> 
<p><strong>1.2.1&nbsp; 图像分类</strong></p> 
<ul><li>Lion 在 ImageNet 上从头开始训练或在 ImageNet-21K 上预训练的各种网络模型上优于 AdamW。</li><li><img alt="" height="715" src="https://img-blog.csdnimg.cn/fdc5fdc1f6b94d6f8fba534edbfc6c5d.png" width="705">​</li></ul> 
<p>&nbsp; &nbsp; &nbsp;Lion 在 JFT-300M 上节省了高达 5 倍的预训练成本。</p> 
<p><img alt="" height="208" src="https://img-blog.csdnimg.cn/f11e6bae19734b468745fa85936de8ac.png" width="540">​</p> 
<h3><a name="t6"></a>1.3&nbsp; Lion 超参数和批量大小选择</h3> 
<p>1)通过对 Lion 的分析表明，它的性能增益随着训练批量的增加而增加。它<strong>还需要比Adam更小的学习率，因为符号函数产生的更新范数更大</strong>。</p> 
<p>2)优化器的另一个潜在限制——批量大小（batch size）。通过实验，<strong>论文指出 Lion 在小batch_size（小于64）的时候效果不如AdamW。</strong></p> 
<p><img alt="" height="238" src="https://img-blog.csdnimg.cn/7d65612ec4174d939415100285c1696d.png" width="944">​</p> 
<h2><a name="t7"></a>2.&nbsp;Lion优化器导入Yolov8</h2> 
<h2><a name="t8"></a>2.1 修改ultralytics/yolo/engine/trainer.py</h2> 
<p>加入以下代码</p> 
<p>修改def build_optimizer(model, name='Adam', lr=0.001, momentum=0.9, decay=1e-5):函数</p> 
<div> 
 <pre data-index="0"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:968px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'Adam'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            optimizer <span class="hljs-operator">=</span> torch.optim.Adam(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>(momentum, <span class="hljs-number">0.999</span>))  # adjust beta<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> momentum</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'AdamW'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            optimizer <span class="hljs-operator">=</span> torch.optim.AdamW(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>(momentum, <span class="hljs-number">0.999</span>), weight_decay<span class="hljs-operator">=</span><span class="hljs-number">0.0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'RMSProp'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            optimizer <span class="hljs-operator">=</span> torch.optim.RMSprop(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, momentum<span class="hljs-operator">=</span>momentum)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'SGD'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            optimizer <span class="hljs-operator">=</span> torch.optim.SGD(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, momentum<span class="hljs-operator">=</span>momentum, nesterov<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'Lion'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            optimizer <span class="hljs-operator">=</span> torch.optim.Lion(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>(momentum, <span class="hljs-number">0.999</span>), weight_decay<span class="hljs-operator">=</span><span class="hljs-number">0.0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> NotImplementedError(f<span class="hljs-string">'Optimizer {name} not implemented.'</span>)</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
</div> 
<h3><a name="t9"></a>2.2 将lion.py加入环境下</h3> 
<p>路径如下：yolov5\Lib\site-packages\torch\optim</p> 
<p><img alt="" height="312" src="https://img-blog.csdnimg.cn/2a407129379e40399978bf37dacff0eb.png" width="619">​</p> 
<p>&nbsp;修改__init__.py</p> 
<pre data-index="1"><code class="hljs language-typescript"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> .<span class="hljs-property">asgd</span> <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">ASGD</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> .<span class="hljs-property">sgd</span> <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">SGD</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> .<span class="hljs-property">lion</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Lion</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> .<span class="hljs-property">radam</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">RAdam</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> .<span class="hljs-property">rprop</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Rprop</span></div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>&nbsp;lion.py代码如下：</p> 
<pre data-index="2" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Copyright <span class="hljs-number">2023</span> Google Research. <span class="hljs-literal">All</span> Rights Reserved.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Licensed under the Apache License, Version <span class="hljs-number">2.0</span> (the <span class="hljs-string">"License"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># you may <span class="hljs-keyword">not</span> <span class="hljs-keyword">use</span> this <span class="hljs-keyword">file</span> except <span class="hljs-keyword">in</span> compliance <span class="hljs-keyword">with</span> the License.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># You may obtain a <span class="hljs-keyword">copy</span> <span class="hljs-keyword">of</span> the License <span class="hljs-keyword">at</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#     http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.apache.org<span class="hljs-operator">/</span>licenses<span class="hljs-operator">/</span>LICENSE-<span class="hljs-number">2.0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">#</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Unless required <span class="hljs-keyword">by</span> applicable law <span class="hljs-keyword">or</span> agreed <span class="hljs-keyword">to</span> <span class="hljs-keyword">in</span> writing, software</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># distributed under the License <span class="hljs-keyword">is</span> distributed <span class="hljs-keyword">on</span> an <span class="hljs-string">"AS IS"</span> BASIS,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># WITHOUT WARRANTIES <span class="hljs-keyword">OR</span> CONDITIONS <span class="hljs-keyword">OF</span> <span class="hljs-keyword">ANY</span> KIND, either express <span class="hljs-keyword">or</span> implied.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># See the License <span class="hljs-keyword">for</span> the specific language governing permissions <span class="hljs-keyword">and</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># limitations under the License.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">""</span><span class="hljs-string">"PyTorch implementation of the Lion optimizer."</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">from</span> torch.optim.optimizer import Optimizer</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Lion(Optimizer):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  r<span class="hljs-string">""</span><span class="hljs-string">"Implements Lion algorithm."</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  def __init__(<span class="hljs-keyword">self</span>, params, lr<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">4</span>, betas<span class="hljs-operator">=</span>(<span class="hljs-number">0.9</span>, <span class="hljs-number">0.99</span>), weight_decay<span class="hljs-operator">=</span><span class="hljs-number">0.0</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Initialize the hyperparameters.</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      params (iterable): iterable of parameters to optimize or dicts defining</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        parameter groups</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      lr (float, optional): learning rate (default: 1e-4)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      betas (Tuple[float, float], optional): coefficients used for computing</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        running averages of gradient and its square (default: (0.9, 0.99))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      weight_decay (float, optional): weight decay coefficient (default: 0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-number">0.0</span> <span class="hljs-operator">&lt;=</span> lr:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Invalid learning rate: {}'</span>.<span class="hljs-keyword">format</span>(lr))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-number">0.0</span> <span class="hljs-operator">&lt;=</span> betas[<span class="hljs-number">0</span>] <span class="hljs-operator">&lt;</span> <span class="hljs-number">1.0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Invalid beta parameter at index 0: {}'</span>.<span class="hljs-keyword">format</span>(betas[<span class="hljs-number">0</span>]))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-number">0.0</span> <span class="hljs-operator">&lt;=</span> betas[<span class="hljs-number">1</span>] <span class="hljs-operator">&lt;</span> <span class="hljs-number">1.0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Invalid beta parameter at index 1: {}'</span>.<span class="hljs-keyword">format</span>(betas[<span class="hljs-number">1</span>]))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    defaults <span class="hljs-operator">=</span> dict(lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>betas, weight_decay<span class="hljs-operator">=</span>weight_decay)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">super</span>().__init__(params, defaults)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  @torch.<span class="hljs-keyword">no</span>_grad()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  def step(<span class="hljs-keyword">self</span>, closure<span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Performs a single optimization step.</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      closure (callable, optional): A closure that reevaluates the model</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        and returns the loss.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Returns:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      the loss.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    loss <span class="hljs-operator">=</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> closure <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">with</span> torch.enable_grad():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        loss <span class="hljs-operator">=</span> closure()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">for</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.param_groups:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-keyword">group</span>[<span class="hljs-string">'params'</span>]:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> p.grad <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-keyword">continue</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # <span class="hljs-keyword">Perform</span> stepweight decay</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p.<span class="hljs-keyword">data</span>.mul_(<span class="hljs-number">1</span><span class="hljs-operator"> - </span><span class="hljs-keyword">group</span>[<span class="hljs-string">'lr'</span>] <span class="hljs-operator">*</span> <span class="hljs-keyword">group</span>[<span class="hljs-string">'weight_decay'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        grad <span class="hljs-operator">=</span> p.grad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        state <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.state[p]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # State initialization</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> len(state) <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">          # Exponential moving average <span class="hljs-keyword">of</span> gradient <span class="hljs-keyword">values</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">          state[<span class="hljs-string">'exp_avg'</span>] <span class="hljs-operator">=</span> torch.<span class="hljs-literal">zeros</span>_like(p)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        exp_avg <span class="hljs-operator">=</span> state[<span class="hljs-string">'exp_avg'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        beta<span class="hljs-number">1</span>, beta<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">group</span>[<span class="hljs-string">'betas'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Weight update</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        update <span class="hljs-operator">=</span> exp_avg <span class="hljs-operator">*</span> beta<span class="hljs-number">1</span> <span class="hljs-operator">+</span> grad <span class="hljs-operator">*</span> (<span class="hljs-number">1</span><span class="hljs-operator"> - </span>beta<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p.<span class="hljs-keyword">add</span>_(torch.<span class="hljs-keyword">sign</span>(update), alpha<span class="hljs-operator">=</span>-<span class="hljs-keyword">group</span>[<span class="hljs-string">'lr'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Decay the momentum running average coefficient</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        exp_avg.mul_(beta<span class="hljs-number">2</span>).<span class="hljs-keyword">add</span>_(grad, alpha<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator"> - </span>beta<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> loss</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p> 
<h3><a name="t10"></a>2.3修改ultralytics/yolo/cfg/default.yaml</h3> 
<pre data-index="3"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">batch: <span class="hljs-number">32</span>  # <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> images per batch (-<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> AutoBatch)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">optimizer: Lion  # optimizer <span class="hljs-keyword">to</span> <span class="hljs-keyword">use</span>, choices<span class="hljs-operator">=</span>[<span class="hljs-string">'SGD'</span>, <span class="hljs-string">'Adam'</span>, <span class="hljs-string">'AdamW'</span>, <span class="hljs-string">'RMSProp'</span>, <span class="hljs-string">'Lion'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">lr<span class="hljs-number">0</span>: <span class="hljs-number">0.0001</span>  # <span class="hljs-keyword">initial</span> learning rate (i.e. SGD<span class="hljs-operator">=</span><span class="hljs-number">1</span>E-<span class="hljs-number">2</span>, Adam<span class="hljs-operator">=</span><span class="hljs-number">1</span>E-<span class="hljs-number">3</span> ,Lion<span class="hljs-operator">=</span><span class="hljs-number">1</span>E-<span class="hljs-number">4</span>)</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<div></div> 
<div>
  🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀 
</div> 
<div>
  🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀 
</div> 
<div>
  🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀🚀 
</div> 
<div></div> 
<div> 
 <h2><a name="t11"></a>3.&nbsp;Lion优化器导入Yolov8</h2> 
 <h2><a name="t12"></a>3.1 修改utils/torch_utils.py</h2> 
 <p>加入以下代码</p> 
 <pre data-index="4" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Lion(Optimizer):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  r<span class="hljs-string">""</span><span class="hljs-string">"Implements Lion algorithm."</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  def __init__(<span class="hljs-keyword">self</span>, params, lr<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">4</span>, betas<span class="hljs-operator">=</span>(<span class="hljs-number">0.9</span>, <span class="hljs-number">0.99</span>), weight_decay<span class="hljs-operator">=</span><span class="hljs-number">0.0</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Initialize the hyperparameters.</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      params (iterable): iterable of parameters to optimize or dicts defining</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        parameter groups</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      lr (float, optional): learning rate (default: 1e-4)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      betas (Tuple[float, float], optional): coefficients used for computing</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        running averages of gradient and its square (default: (0.9, 0.99))</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      weight_decay (float, optional): weight decay coefficient (default: 0)</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-number">0.0</span> <span class="hljs-operator">&lt;=</span> lr:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Invalid learning rate: {}'</span>.<span class="hljs-keyword">format</span>(lr))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-number">0.0</span> <span class="hljs-operator">&lt;=</span> betas[<span class="hljs-number">0</span>] <span class="hljs-operator">&lt;</span> <span class="hljs-number">1.0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Invalid beta parameter at index 0: {}'</span>.<span class="hljs-keyword">format</span>(betas[<span class="hljs-number">0</span>]))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-number">0.0</span> <span class="hljs-operator">&lt;=</span> betas[<span class="hljs-number">1</span>] <span class="hljs-operator">&lt;</span> <span class="hljs-number">1.0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'Invalid beta parameter at index 1: {}'</span>.<span class="hljs-keyword">format</span>(betas[<span class="hljs-number">1</span>]))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    defaults <span class="hljs-operator">=</span> dict(lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>betas, weight_decay<span class="hljs-operator">=</span>weight_decay)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">super</span>().__init__(params, defaults)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  @torch.<span class="hljs-keyword">no</span>_grad()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  def step(<span class="hljs-keyword">self</span>, closure<span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"Performs a single optimization step.</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      closure (callable, optional): A closure that reevaluates the model</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        and returns the loss.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Returns:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">      the loss.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    loss <span class="hljs-operator">=</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> closure <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">with</span> torch.enable_grad():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        loss <span class="hljs-operator">=</span> closure()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">for</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.param_groups:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">      <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-keyword">group</span>[<span class="hljs-string">'params'</span>]:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> p.grad <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">          <span class="hljs-keyword">continue</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # <span class="hljs-keyword">Perform</span> stepweight decay</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p.<span class="hljs-keyword">data</span>.mul_(<span class="hljs-number">1</span><span class="hljs-operator"> - </span><span class="hljs-keyword">group</span>[<span class="hljs-string">'lr'</span>] <span class="hljs-operator">*</span> <span class="hljs-keyword">group</span>[<span class="hljs-string">'weight_decay'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        grad <span class="hljs-operator">=</span> p.grad</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        state <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.state[p]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # State initialization</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> len(state) <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">          # Exponential moving average <span class="hljs-keyword">of</span> gradient <span class="hljs-keyword">values</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">          state[<span class="hljs-string">'exp_avg'</span>] <span class="hljs-operator">=</span> torch.<span class="hljs-literal">zeros</span>_like(p)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        exp_avg <span class="hljs-operator">=</span> state[<span class="hljs-string">'exp_avg'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        beta<span class="hljs-number">1</span>, beta<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">group</span>[<span class="hljs-string">'betas'</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Weight update</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        update <span class="hljs-operator">=</span> exp_avg <span class="hljs-operator">*</span> beta<span class="hljs-number">1</span> <span class="hljs-operator">+</span> grad <span class="hljs-operator">*</span> (<span class="hljs-number">1</span><span class="hljs-operator"> - </span>beta<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        p.<span class="hljs-keyword">add</span>_(torch.<span class="hljs-keyword">sign</span>(update), alpha<span class="hljs-operator">=</span>-<span class="hljs-keyword">group</span>[<span class="hljs-string">'lr'</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # Decay the momentum running average coefficient</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        exp_avg.mul_(beta<span class="hljs-number">2</span>).<span class="hljs-keyword">add</span>_(grad, alpha<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator"> - </span>beta<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> loss</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
 <p>修改def smart_optimizer(model, name='Adam', lr=0.001, momentum=0.9, decay=1e-5):函数</p> 
 <pre data-index="5"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'Adam'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        optimizer <span class="hljs-operator">=</span> torch.optim.Adam(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>(momentum, <span class="hljs-number">0.999</span>))  # adjust beta<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> momentum</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'AdamW'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        optimizer <span class="hljs-operator">=</span> torch.optim.AdamW(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>(momentum, <span class="hljs-number">0.999</span>), weight_decay<span class="hljs-operator">=</span><span class="hljs-number">0.0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'RMSProp'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        optimizer <span class="hljs-operator">=</span> torch.optim.RMSprop(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, momentum<span class="hljs-operator">=</span>momentum)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'SGD'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        optimizer <span class="hljs-operator">=</span> torch.optim.SGD(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, momentum<span class="hljs-operator">=</span>momentum, nesterov<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'Lion'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        optimizer <span class="hljs-operator">=</span> Lion(g[<span class="hljs-number">2</span>], lr<span class="hljs-operator">=</span>lr, betas<span class="hljs-operator">=</span>(momentum, <span class="hljs-number">0.999</span>), weight_decay<span class="hljs-operator">=</span><span class="hljs-number">0.0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">raise</span> NotImplementedError(f<span class="hljs-string">'Optimizer {name} not implemented.'</span>)</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
 <h3><a name="t13"></a>3.2 修改train.py</h3> 
 <p>修改def parse_opt(known=False):</p> 
 <pre data-index="6" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1111px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> parser <span class="hljs-operator">=</span> argparse.ArgumentParser()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--weights'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span>ROOT <span class="hljs-operator">/</span> <span class="hljs-string">'weights/yolov5s.pt'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'initial weights path'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--cfg'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-string">'models/yolov5s.yaml'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'model.yaml path'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--data'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span>ROOT <span class="hljs-operator">/</span> <span class="hljs-string">'data/crack.yaml'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'dataset.yaml path'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--hyp'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span>ROOT <span class="hljs-operator">/</span> <span class="hljs-string">'data/hyps/hyp.scratch-low.yaml'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'hyperparameters path'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--epochs'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>int, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-number">100</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'total training epochs'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--batch-size'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>int, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-number">64</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'total batch size for all GPUs, -1 for autobatch'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--imgsz'</span>, <span class="hljs-string">'--img'</span>, <span class="hljs-string">'--img-size'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>int, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-number">640</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'train, val image size (pixels)'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--rect'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'rectangular training'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--resume'</span>, nargs<span class="hljs-operator">=</span><span class="hljs-string">'?'</span>, const<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'resume most recent training'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--nosave'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'only save final checkpoint'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--noval'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'only validate final epoch'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--noautoanchor'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'disable AutoAnchor'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--noplots'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'save no plot files'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--evolve'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>int, nargs<span class="hljs-operator">=</span><span class="hljs-string">'?'</span>, const<span class="hljs-operator">=</span><span class="hljs-number">300</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'evolve hyperparameters for x generations'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--bucket'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-string">''</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'gsutil bucket'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--cache'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, nargs<span class="hljs-operator">=</span><span class="hljs-string">'?'</span>, const<span class="hljs-operator">=</span><span class="hljs-string">'ram'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'image --cache ram/disk'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--image-weights'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'use weighted image selection for training'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--device'</span>, <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-string">'1'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'cuda device, i.e. 0 or 0,1,2,3 or cpu'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--multi-scale'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'vary img-size +/- 50%%'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--single-cls'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'train multi-class data as single-class'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--optimizer'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, choices<span class="hljs-operator">=</span>[<span class="hljs-string">'SGD'</span>, <span class="hljs-string">'Adam'</span>, <span class="hljs-string">'AdamW'</span>,<span class="hljs-string">'Lion'</span>], <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-string">'Lion'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'optimizer'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--sync-bn'</span>, action<span class="hljs-operator">=</span><span class="hljs-string">'store_true'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'use SyncBatchNorm, only available in DDP mode'</span>)</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
 <h3><a name="t14"></a>3.3修改data/hyps/hyp.scratch-low.yaml</h3> 
 <pre data-index="7"><code class="hljs language-cobol">lr<span class="hljs-number">0</span>: <span class="hljs-number">0.0001</span>  # <span class="hljs-keyword">initial</span> learning rate (SGD<span class="hljs-operator">=</span><span class="hljs-number">1</span>E-<span class="hljs-number">2</span>, Adam<span class="hljs-operator">=</span><span class="hljs-number">1</span>E-<span class="hljs-number">3</span>,LION<span class="hljs-operator">=</span><span class="hljs-number">1</span>E-<span class="hljs-number">4</span>)</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
 <h3><a name="t15"></a>3.4修改utils/loggers/clearml/hpo.py</h3> 
 <pre data-index="8"><code class="hljs language-cobol">parser.<span class="hljs-keyword">add</span>_argument(<span class="hljs-string">'--optimizer'</span>, <span class="hljs-keyword">type</span><span class="hljs-operator">=</span>str, choices<span class="hljs-operator">=</span>[<span class="hljs-string">'SGD'</span>, <span class="hljs-string">'Adam'</span>, <span class="hljs-string">'AdamW'</span>,<span class="hljs-string">'Lion'</span>], <span class="hljs-keyword">default</span><span class="hljs-operator">=</span><span class="hljs-string">'Lion'</span>, help<span class="hljs-operator">=</span><span class="hljs-string">'optimizer'</span>)</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
</div> 
<div></div> 
<h2><a name="t16"></a>4.总结</h2> 
<p>&nbsp; &nbsp; 本文介绍了 Google 新提出的优化器 Lion，它通过大量算力搜索并结合人工干预得出，相比主流的 AdamW，有着速度更快且更省内存的特点，并且大量实验结果显示，它在多数任务上都有着不逊色于甚至优于 AdamW 的表现。</p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/130222697&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>