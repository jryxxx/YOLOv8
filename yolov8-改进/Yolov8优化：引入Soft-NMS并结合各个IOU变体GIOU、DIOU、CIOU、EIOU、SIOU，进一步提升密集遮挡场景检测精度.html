<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <h2 id="articleContentId"><a name="t0"></a>&nbsp;</h2> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t1" target="_self">&nbsp;</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t2" target="_self">&nbsp;1.Soft-NMS介绍</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t3" target="_self">&nbsp;2.IOU介绍</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t4" target="_self">2.1 GIOU</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t5" target="_self">&nbsp;2.2 DIoU（Distance-IoU）</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t6" target="_self">2.3&nbsp;&nbsp;CIoU</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t7" target="_self">2.4&nbsp; EIoU(Efficient-IoU)</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t8" target="_self">2.5 SIOU</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t9" target="_self">&nbsp;3.Yolov8引入soft-NMS和各个IOU</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t10" target="_self">3.1修改ultralytics/yolo/utils/ops.py</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t11" target="_self">4.总结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%C2%A01.Soft-NMS%E4%BB%8B%E7%BB%8D"><a name="t1"></a>&nbsp;1.<a href="https://so.csdn.net/so/search?q=Soft-NMS&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=Soft-NMS&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;Soft-NMS\&quot;}&quot;}" data-tit="Soft-NMS" data-pretit="soft-nms">Soft-NMS</a>介绍</h2> 
<p><img alt="" height="158" src="https://img-blog.csdnimg.cn/ae61c201a9e545feac07128cc29b2609.png" width="703">&nbsp;论文地址：<a href="https://arxiv.org/pdf/1704.04503.pdf" title="https://arxiv.org/pdf/1704.04503.pdf">https://arxiv.org/pdf/1704.04503.pdf</a></p> 
<p>&nbsp;<strong>NMS需要优化的参数：</strong></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IoU 的阈值是一个可优化的参数，一般范围为0~0.5，可以使用交叉验证来选择最优的参数。</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R-CNN会从一张图片中找出n个可能是物体的矩形框，然后为每个矩形框为做类别分类概率：</p> 
<p><img alt="" height="629" src="https://img-blog.csdnimg.cn/60bf5f9ee7df40e8a16b587a0b781574.png" width="639">​</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;就像上面的图片一样，定位某个物体后，最后算法就找出了一堆的方框，我们需要判别哪些矩形框是没用的。非极大值抑制的方法是：先假设有6个矩形框，根据分类器的类别分类概率做排序，假设从小到大属于人物的概率 分别为A、B、C、D、E、F。</p> 
<p>&nbsp; &nbsp; &nbsp; (1)从最大概率矩形框F开始，分别判断A~E与F的重叠度IOU是否大于某个设定的阈值;<br> &nbsp; &nbsp; &nbsp; (2)假设B、D与F的重叠度超过阈值，那么就扔掉B、D；并标记第一个矩形框F，是我们保留下来的。<br> &nbsp; &nbsp; &nbsp; (3)从剩下的矩形框A、C、E中，选择概率最大的E，然后判断E与A、C的重叠度，重叠度大于一定的阈值，那么就扔掉；并标记E是我们保留下来的第二个矩形框。<br> &nbsp; &nbsp; &nbsp; 就这样一直重复，找到所有被保留下来的矩形框。<br> NMS<strong>需要优化的参数：</strong></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NMS在密集遮挡场景会出现很大的问题，漏检很多，例如下图，红色框和绿色框是当前的检测结果，二者的得分分别是0.95和0.80。如果按照传统的NMS进行处理，首先选中得分最高的红色框，然后绿色框就会因为与之重叠面积过大而被删掉。另外，NMS的阈值也不太容易确定，设小了会出现下图的情况（绿色框因为和红色框重叠面积较大而被删掉），设置过高又容易增大误检。</p> 
<p><img alt="" height="730" src="https://img-blog.csdnimg.cn/f8c607f7c76d44eb80da9666ab12de5c.png" width="838">​</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对NMS存在的这个问题，我们提出了一种新的Soft-NMS算法，它只需改动一行代码即可有效改进传统贪心NMS算法。在该算法中，我们基于重叠部分的大小为相邻检测框设置一个衰减函数而非彻底将其分数置为零。简单来讲，如果一个检测框与M有大部分重叠，它会有很低的分数；而如果检测框与M只有小部分重叠，那么它的原有检测分数不会受太大影响。在标准数据集PASCAL VOC 和 MS-COCO等标准数据集上，Soft-NMS<strong>对现有物体检测算法在多个重叠物体检测的平均准确率有显著的提升</strong>。同时，Soft-NMS不需要额外的训练且易于实现，因此，它很容易被集成到当前的物体检测流程中。</p> 
<p>Soft-NMS的思路：不要粗鲁地删除所有IOU大于阈值的框，而是降低其置信度。<br> Soft-NMS的做法：M为当前得分最高框，bi 为待处理框，bi 和M的IOU越大，bi 的得分si 就下降的越厉害</p> 
<div> 
 <p><img alt="" height="620" src="https://img-blog.csdnimg.cn/4bbccfee47cd44f9a9a2cf8a1ace8d69.png" width="512">​</p> 
</div> 
<h2 id="%C2%A02.IOU%E4%BB%8B%E7%BB%8D"><a name="t2"></a>&nbsp;2.IOU介绍</h2> 
<p>IOU损失函数目前主要应用于目标检测的领域，其演变的过程如下：IOU --&gt; GIOU --&gt; <a href="https://so.csdn.net/so/search?q=DIOU&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=DIOU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;DIOU\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=DIOU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;DIOU\&quot;}&quot;}" data-tit="DIOU" data-pretit="diou">DIOU</a> --&gt;CIOU损失函数，每一种损失函数都较上一种损失函数有所提升。下面来具体介绍这几种损失函数。</p> 
<h3 id="2.1%20GIOU"><a name="t3"></a>2.1 GIOU</h3> 
<p>GIOU也是一个度量，L G I O U = 1 − G I O U L_{GIOU}=1 - GIOUL&nbsp;<br> GIOU<br> ​<br> &nbsp;=1−GIOU，满足非负性、同一性、对称性和三角不等式；<br> GIOU具有尺度不变性；<br> GIOU是IOU的下限，A和B越一致，GIOU越接近IOU；<br> 0 ≤ I O U ≤ 1 0 \leq IOU \leq 10≤IOU≤1，但− 1 ≤ G I O U ≤ 1 -1 \leq GIOU \leq 1−1≤GIOU≤1。在A和B完全重叠时，GIOU等于1；当A和B相距非常远时，GIOU接近于-1。</p> 
<p><img alt="" height="678" src="https://img-blog.csdnimg.cn/e79fb14ad5c942db9cd11069b7abaae3.png" width="616">​</p> 
<h3 id="%C2%A02.2%20DIoU%EF%BC%88Distance-IoU%EF%BC%89"><a name="t4"></a>&nbsp;2.2 DIoU（Distance-IoU）</h3> 
<p>论文：<a href="https://arxiv.org/pdf/1911.08287.pdf" title="https://arxiv.org/pdf/1911.08287.pdf">https://arxiv.org/pdf/1911.08287.pdf</a></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对上述GIoU的两个问题，有大神将GIoU中最小外接框来最大化重叠面积的惩罚项修改成最小化两个BBox中心点的标准化距离从而加速损失的收敛过程，这就诞生了DIoU。</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIoU要比GIou更加符合目标框回归的机制，将目标与预测之间的距离，重叠率以及尺度都考虑进去，使得目标框回归变得更加稳定，不会像IoU和GIoU一样出现训练过程中发散等问题。</p> 
<p><img alt="" height="442" src="https://img-blog.csdnimg.cn/f7e9900eff7041d280a94e2e537e0816.png" width="547">​</p> 
<h3 id="2.3%C2%A0%C2%A0CIoU"><a name="t5"></a>2.3&nbsp;&nbsp;CIoU</h3> 
<p>CIoU与DIoU出自同一篇论文，CIoU大多数用于训练。DIoU的作者考虑到，在两个框中心点重合时，c与d的值都不变。所以此时需要引入框的宽高比</p> 
<p><img alt="" height="258" src="https://img-blog.csdnimg.cn/618504050f024f6c81c48bb8f78fed3d.png" width="536">​</p> 
<p></p> 
<h3 id="2.4%C2%A0%20EIoU(Efficient-IoU)"><a name="t6"></a>2.4&nbsp; <a href="https://so.csdn.net/so/search?q=EIoU&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=EIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;EIoU\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=EIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;EIoU\&quot;}&quot;}" data-tit="EIoU" data-pretit="eiou">EIoU</a>(Efficient-IoU)</h3> 
<p>论文：<a href="https://arxiv.org/pdf/2101.08158.pdf" title="https://arxiv.org/pdf/2101.08158.pdf">https://arxiv.org/pdf/2101.08158.pdf</a></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了解决CIoU的问题，有学者在CIOU的基础上将纵横比拆开，提出了EIOU Loss，并且加入Focal聚焦优质的预测框，与CIoU相似的，EIoU是损失函数的解决方案，只用于训练。</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EIOU的惩罚项是在CIOU的惩罚项基础上将纵横比的影响因子拆开分别计算目标框和预测框的长和宽，该损失函数包含三个部分：重叠损失，中心距离损失，宽高损失，前两部分延续CIoU中的方法，但是宽高损失直接使目标框与预测框的宽度和高度之差最小，使得收敛速度更快。</p> 
<p><img alt="" height="685" src="https://img-blog.csdnimg.cn/af20c631832d440a93b785c4e10b1225.png" width="856">​</p> 
<p></p> 
<p><img alt="" height="507" src="https://img-blog.csdnimg.cn/5af2e26f681f4f56a80924fe98999457.png" width="799">​&nbsp;</p> 
<h3 id="2.5%20SIOU"><a name="t7"></a>2.5 SIOU</h3> 
<p>论文：&nbsp;<a href="https://arxiv.org/ftp/arxiv/papers/2205/2205.12740.pdf" title="https://arxiv.org/ftp/arxiv/papers/2205/2205.12740.pdf">https://arxiv.org/ftp/arxiv/papers/2205/2205.12740.pdf</a></p> 
<p>&nbsp;<img alt="" height="247" src="https://img-blog.csdnimg.cn/47f5e00c4b0945ababce577b21a3d1df.png" width="281">​</p> 
<p>&nbsp;<img alt="" height="157" src="https://img-blog.csdnimg.cn/8449afd2db814b3a9c2f5654b1eb5f39.png" width="340">​</p> 
<p></p> 
<h2 id="%C2%A03.Yolov8%E5%BC%95%E5%85%A5soft-NMS%E5%92%8C%E5%90%84%E4%B8%AAIOU"><a name="t8"></a>&nbsp;3.Yolov8引入soft-NMS和各个IOU</h2> 
<h3 id="3.1%E4%BF%AE%E6%94%B9ultralytics%2Fyolo%2Futils%2Fops.py"><a name="t9"></a>3.1修改ultralytics/yolo/utils/ops.py</h3> 
<p>加入以下代码：</p> 
<div> 
 <pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1086px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def box_iou_<span class="hljs-keyword">for</span>_nms(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, GIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, DIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, SIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, EIou<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Returns Intersection over Union (IoU) <span class="hljs-keyword">of</span> box<span class="hljs-number">1</span>(<span class="hljs-number">1,4</span>) <span class="hljs-keyword">to</span> box<span class="hljs-number">2</span>(n,<span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>).clamp(eps)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, (b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>).clamp(eps)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span><span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou <span class="hljs-operator">=</span> inter <span class="hljs-operator">/</span> union</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> GIoU <span class="hljs-keyword">or</span> EIou:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cw <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)  # convex (smallest enclosing box) width</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)  # convex height</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> EIou:  # Distance <span class="hljs-keyword">or</span> Complete IoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>abs<span class="hljs-operator">/</span><span class="hljs-number">1911.08287</span>v<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps  # convex diagonal squared</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            rho<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span> <span class="hljs-number">4</span>  # center dist <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> CIoU:  # https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>github.com<span class="hljs-operator">/</span>Zzh-tju<span class="hljs-operator">/</span>DIoU-SSD-pytorch<span class="hljs-operator">/</span>blob<span class="hljs-operator">/</span>master<span class="hljs-operator">/</span>utils<span class="hljs-operator">/</span>box<span class="hljs-operator">/</span>box_utils.py#L<span class="hljs-number">47</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                v <span class="hljs-operator">=</span> (<span class="hljs-number">4</span> <span class="hljs-operator">/</span> math.pi <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">*</span> (torch.atan(w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> h<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>torch.atan(w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> h<span class="hljs-number">1</span>)).pow(<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">with</span> torch.<span class="hljs-keyword">no</span>_grad():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    alpha <span class="hljs-operator">=</span> v <span class="hljs-operator">/</span> (v<span class="hljs-operator"> - </span>iou <span class="hljs-operator">+</span> (<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> v <span class="hljs-operator">*</span> alpha)  # CIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif EIou:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_w<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                cw<span class="hljs-number">2</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">ch</span><span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>  # DIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        c_<span class="hljs-keyword">area</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">*</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">+</span> eps  # convex <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(c_<span class="hljs-keyword">area</span><span class="hljs-operator"> - </span>union) <span class="hljs-operator">/</span> c_<span class="hljs-keyword">area</span>  # GIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">1902.09630</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    elif SIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # SIoU Loss https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">2205.12740</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        s_cw <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        sigma <span class="hljs-operator">=</span> torch.pow(s_cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">=</span> torch.abs(s_cw) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        sin_alpha_<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.abs(s_<span class="hljs-keyword">ch</span>) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        threshold <span class="hljs-operator">=</span> pow(<span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        sin_alpha <span class="hljs-operator">=</span> torch.where(sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">&gt;</span> threshold, sin_alpha_<span class="hljs-number">2</span>, sin_alpha_<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        angle_cost <span class="hljs-operator">=</span> torch.cos(torch.arcsin(sin_alpha) <span class="hljs-operator">*</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>math.pi <span class="hljs-operator">/</span> <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        rho_x <span class="hljs-operator">=</span> (s_cw <span class="hljs-operator">/</span> cw) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        rho_y <span class="hljs-operator">=</span> (s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        gamma <span class="hljs-operator">=</span> angle_cost<span class="hljs-operator"> - </span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        distance_cost <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_x)<span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        omiga_w <span class="hljs-operator">=</span> torch.abs(w<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(w<span class="hljs-number">1</span>, w<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        omiga_h <span class="hljs-operator">=</span> torch.abs(h<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(h<span class="hljs-number">1</span>, h<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        shape_cost <span class="hljs-operator">=</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_w), <span class="hljs-number">4</span>) <span class="hljs-operator">+</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_h), <span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span><span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> (distance_cost <span class="hljs-operator">+</span> shape_cost)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> iou  # IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def soft_nms(bboxes, scores, iou_thresh<span class="hljs-operator">=</span><span class="hljs-number">0.5</span>, sigma<span class="hljs-operator">=</span><span class="hljs-number">0.5</span>, score_threshold<span class="hljs-operator">=</span><span class="hljs-number">0.25</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">order</span> <span class="hljs-operator">=</span> torch.arange(<span class="hljs-number">0</span>, scores.<span class="hljs-keyword">size</span>(<span class="hljs-number">0</span>)).<span class="hljs-keyword">to</span>(bboxes.device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    keep <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    while <span class="hljs-keyword">order</span>.numel() <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">order</span>.numel() <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            keep.append(<span class="hljs-keyword">order</span>[<span class="hljs-number">0</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            break</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            i <span class="hljs-operator">=</span> <span class="hljs-keyword">order</span>[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            keep.append(i)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        iou <span class="hljs-operator">=</span> box_iou_<span class="hljs-keyword">for</span>_nms(bboxes[i], bboxes[<span class="hljs-keyword">order</span>[<span class="hljs-number">1</span>:]]).squeeze()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        idx <span class="hljs-operator">=</span> (iou <span class="hljs-operator">&gt;</span> iou_thresh).nonzero().squeeze()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> idx.numel() <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            iou <span class="hljs-operator">=</span> iou[idx]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            newScores <span class="hljs-operator">=</span> torch.exp(-torch.pow(iou, <span class="hljs-number">2</span>) <span class="hljs-operator">/</span> sigma)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            scores[<span class="hljs-keyword">order</span>[idx <span class="hljs-operator">+</span> <span class="hljs-number">1</span>]] <span class="hljs-operator">*</span><span class="hljs-operator">=</span> newScores</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        newOrder <span class="hljs-operator">=</span> (scores[<span class="hljs-keyword">order</span>[<span class="hljs-number">1</span>:]] <span class="hljs-operator">&gt;</span> score_threshold).nonzero().squeeze()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> newOrder.numel() <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            break</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            maxScoreIndex <span class="hljs-operator">=</span> torch.argmax(scores[<span class="hljs-keyword">order</span>[newOrder <span class="hljs-operator">+</span> <span class="hljs-number">1</span>]])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> maxScoreIndex !<span class="hljs-operator">=</span> <span class="hljs-number">0</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                newOrder[[<span class="hljs-number">0</span>, maxScoreIndex],] <span class="hljs-operator">=</span> newOrder[[maxScoreIndex, <span class="hljs-number">0</span>],]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">order</span>[newOrder <span class="hljs-operator">+</span> <span class="hljs-number">1</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> torch.LongTensor(keep)</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
</div> 
<p>&nbsp;修改def non_max_suppression函数：</p> 
<p>第一处修改点：&nbsp;</p> 
<div> 
 <pre data-index="1"><code class="hljs language-csharp">i = torchvision.ops.nms(boxes, scores, iou_thres)  <span class="hljs-meta"># NMS</span></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
</div> 
<div> 
 <p><img alt="" height="55" src="https://img-blog.csdnimg.cn/0d994046e9cb49bb8f9d2b8da6164ae0.png" width="50">​</p> 
</div> 
<div> 
 <pre data-index="2"><code class="hljs language-csharp">i = soft_nms(boxes, scores, iou_thres)  <span class="hljs-meta"># NMS</span></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
</div> 
<p>第二处修改点：&nbsp;</p> 
<div> 
 <pre data-index="3"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span> box_iou(boxes[i], boxes) <span class="hljs-operator">&gt;</span> iou_thres  # iou matrix</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
</div> 
<div> 
 <p><img alt="" height="55" src="https://img-blog.csdnimg.cn/0d994046e9cb49bb8f9d2b8da6164ae0.png" width="50">​</p> 
</div> 
<div> 
 <pre data-index="4"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span>box_iou_<span class="hljs-keyword">for</span>_nms(boxes[i], boxes, GIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, DIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, SIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, EIou<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>) <span class="hljs-operator">&gt;</span> iou_thres  # iou matrix</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
</div> 
<h2 id="4.%E6%80%BB%E7%BB%93"><a name="t10"></a>4.总结</h2> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Soft-NMS解决yolov8自带的nms在密集遮挡场景会出现很大的问题，如出现批量漏检；在这个基础上加入各种IOU变体，进一步提升检测精度。</p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/131376873&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>