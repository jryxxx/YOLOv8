<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>ç›®å½•</strong></p> 
<p id="-toc" style="margin: 0px;"></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t0" target="_self">&nbsp;1.GiraffeDetä»‹ç»</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t1" target="_self">2.&nbsp;GFPNå¼•å…¥åˆ°Yolov8</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t2" target="_self">2.1ä¿®æ”¹modules.py</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t3" target="_self">2.2&nbsp; CSPStageæ³¨å†Œtasks.py</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t4" target="_self">2.3 ä¿®æ”¹yolov8_GFPN.yaml</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t5" target="_self">3.æ•°æ®é›†éªŒè¯æ€§èƒ½</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%C2%A01.GiraffeDet%E4%BB%8B%E7%BB%8D"><a name="t0"></a>&nbsp;1.GiraffeDetä»‹ç»</h2> 
<p><img alt="" height="575" src="https://img-blog.csdnimg.cn/f917c4ed216848d7942b529a6cbcca99.png" width="631"></p> 
<p></p> 
<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/abs/2202.04256" title="https://arxiv.org/abs/2202.04256">https://arxiv.org/abs/2202.04256</a></p> 
<p><img alt="" src="https://img-blog.csdnimg.cn/f619b8be448343a39f514cb345742adf.jpeg"></p> 
<h2 id="%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86Yolov8%E9%AD%94%E6%9C%AF%E5%B8%88%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86%F0%9F%8F%86" style="text-align:center;"><a name="t1"></a>ğŸ†ğŸ†ğŸ†ğŸ†ğŸ†ğŸ†Yolov8é­”æœ¯å¸ˆğŸ†ğŸ†ğŸ†ğŸ†ğŸ†ğŸ†</h2> 
<h2><a name="t2"></a><a name="t2"></a></h2> 
<h3 id="%E2%9C%A8%E2%9C%A8%E2%9C%A8%E9%AD%94%E6%94%B9%E7%BD%91%E7%BB%9C%E3%80%81%E5%A4%8D%E7%8E%B0%E5%89%8D%E6%B2%BF%E8%AE%BA%E6%96%87%EF%BC%8C%E7%BB%84%E5%90%88%E4%BC%98%E5%8C%96%E5%88%9B%E6%96%B0"><a name="t3"></a>âœ¨âœ¨âœ¨é­”æ”¹ç½‘ç»œã€å¤ç°å‰æ²¿è®ºæ–‡ï¼Œç»„åˆä¼˜åŒ–åˆ›æ–°</h3> 
<h3 id="%F0%9F%9A%80%F0%9F%9A%80%F0%9F%9A%80%E5%B0%8F%E7%9B%AE%E6%A0%87%E3%80%81%E9%81%AE%E6%8C%A1%E7%89%A9%E3%80%81%E9%9A%BE%E6%A0%B7%E6%9C%AC%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87"><a name="t4"></a>ğŸš€ğŸš€ğŸš€å°ç›®æ ‡ã€é®æŒ¡ç‰©ã€éš¾æ ·æœ¬æ€§èƒ½æå‡</h3> 
<h3 id="%F0%9F%8D%89%F0%9F%8D%89%F0%9F%8D%89%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%96%B0%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E9%9B%86%E6%B6%A8%E7%82%B9%E6%83%85%E5%86%B5"><a name="t5"></a>ğŸ‰ğŸ‰ğŸ‰å®šæœŸæ›´æ–°ä¸åŒæ•°æ®é›†æ¶¨ç‚¹æƒ…å†µ</h3> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‘˜è¦ï¼šåœ¨ä¼ ç»Ÿçš„<a href="https://so.csdn.net/so/search?q=%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;ç›®æ ‡æ£€æµ‹\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;ç›®æ ‡æ£€æµ‹\&quot;}&quot;}" data-tit="ç›®æ ‡æ£€æµ‹" data-pretit="ç›®æ ‡æ£€æµ‹">ç›®æ ‡æ£€æµ‹</a>æ¡†æ¶ä¸­ï¼Œç»§æ‰¿è‡ªå›¾åƒè¯†åˆ«æ¨¡å‹çš„éª¨å¹²ä¸»ä½“æå–æ·±åº¦æ½œåœ¨ç‰¹å¾ï¼Œç„¶åç”±é¢ˆéƒ¨æ¨¡å—èåˆè¿™äº›æ½œåœ¨ç‰¹å¾æ¥è·å–ä¸åŒå°ºåº¦çš„ä¿¡æ¯ã€‚ç”±äºç›®æ ‡æ£€æµ‹çš„åˆ†è¾¨ç‡è¿œå¤§äºå›¾åƒè¯†åˆ«ï¼Œå› æ­¤ä¸»å¹²çš„è®¡ç®—ä»£ä»·å¾€å¾€å ä¸»å¯¼åœ°ä½ã€‚è¿™ç§é‡ä¸»å¹²è®¾è®¡èŒƒå¼ä¸»è¦æ˜¯ç”±äºå°†å›¾åƒè¯†åˆ«æ¨¡å‹è½¬ç§»åˆ°ç›®æ ‡æ£€æµ‹æ—¶çš„å†å²é—ç•™é—®é¢˜ï¼Œè€Œä¸æ˜¯ç›®æ ‡æ£€æµ‹çš„ç«¯åˆ°ç«¯ä¼˜åŒ–è®¾è®¡ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬è¡¨æ˜ï¼Œè¿™ç§èŒƒå¼ç¡®å®å¯¼è‡´æ¬¡ä¼˜çš„ç›®æ ‡æ£€æµ‹æ¨¡å‹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªæ–°çš„é‡é¢ˆèŒƒå¼ï¼ŒGiraffeDetï¼Œä¸€ä¸ªç±»ä¼¼é•¿é¢ˆé¹¿çš„ç½‘ç»œï¼Œç”¨äºæœ‰æ•ˆçš„ç›®æ ‡æ£€æµ‹ã€‚GiraffeDetä½¿ç”¨äº†ä¸€ä¸ªéå¸¸è½»é‡çš„ä¸»å¹²å’Œä¸€ä¸ªéå¸¸æ·±è€Œå¤§çš„é¢ˆéƒ¨æ¨¡å—ï¼Œè¿™é¼“åŠ±äº†ä¸åŒç©ºé—´å°ºåº¦ä¹‹é—´å¯†é›†çš„ä¿¡æ¯äº¤æ¢ï¼ŒåŒæ—¶ä¹Ÿé¼“åŠ±äº†ä¸åŒå±‚æ¬¡çš„æ½œåœ¨è¯­ä¹‰ã€‚è¿™ç§è®¾è®¡èŒƒå¼ä½¿æ£€æµ‹å™¨å³ä½¿åœ¨ç½‘ç»œçš„æ—©æœŸé˜¶æ®µï¼Œä¹Ÿèƒ½ä»¥åŒæ ·çš„ä¼˜å…ˆçº§å¤„ç†é«˜çº§è¯­ä¹‰ä¿¡æ¯å’Œä½çº§ç©ºé—´ä¿¡æ¯ï¼Œæé«˜äº†æ£€æµ‹ä»»åŠ¡çš„æ•ˆç‡ã€‚å¯¹å¤šä¸ªæµè¡Œç›®æ ‡æ£€æµ‹åŸºå‡†çš„æ•°å€¼è¯„ä¼°è¡¨æ˜ï¼Œåœ¨å¹¿æ³›çš„èµ„æºçº¦æŸèŒƒå›´å†…ï¼ŒGiraffeDetå§‹ç»ˆä¼˜äºä»¥å‰çš„SOTAæ¨¡å‹ã€‚</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡æ˜¯é˜¿é‡Œå·´å·´åœ¨ç›®æ ‡æ£€æµ‹é¢†åŸŸçš„å·¥ä½œ(å·²è¢«ICLR2022æ¥æ”¶)ï¼Œæå‡ºäº†ä¸€ç§æ–°é¢–çš„ç±»â€œé•¿é¢ˆé¹¿â€çš„GiraffeDetæ¶æ„ï¼Œå®ƒé‡‡ç”¨äº†è½»éª¨å¹²ã€é‡Neckçš„æ¶æ„è®¾è®¡èŒƒå¼ã€‚æ‰€æGiraffeDetåœ¨COCOæ•°æ®é›†ä¸Šå–å¾—äº†æ¯”å¸¸è§„CNNéª¨å¹²æ›´ä¼˜å¼‚çš„æ€§èƒ½ï¼Œå–å¾—äº†54.1%mAPæŒ‡æ ‡ï¼Œå…·æœ‰æ›´ä¼˜å¼‚çš„å¤„ç†ç›®æ ‡å¤§å°ºåº¦å˜åŒ–é—®é¢˜çš„èƒ½åŠ›ã€‚</p> 
<p><img alt="" height="397" src="https://img-blog.csdnimg.cn/b0ba0f4ab78a4a3cb691e0bee5b4a91b.png" width="866"></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡æå‡ºäº†GiraffeDetç”¨äºé«˜æ•ˆç›®æ ‡æ£€æµ‹ï¼ŒgiraffeåŒ…å«è½»é‡space-to-depth chainã€Generalized-FPNä»¥åŠé¢„æµ‹ç½‘ç»œ</p> 
<p><img alt="" height="429" src="https://img-blog.csdnimg.cn/a7dbd3bd764a47869cef238e0d375443.png" width="1012"></p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FPNæ—¨åœ¨å¯¹CNNéª¨å¹²ç½‘ç»œæå–çš„ä¸åŒåˆ†è¾¨ç‡çš„å¤šå°ºåº¦ç‰¹å¾è¿›è¡Œèåˆã€‚ä¸Šå›¾ç»™å‡ºäº†FPNçš„è¿›åŒ–ï¼Œä»æœ€åˆçš„FPNåˆ°PANetå†åˆ°BiFPNã€‚æˆ‘ä»¬æ³¨æ„åˆ°ï¼šè¿™äº›FPNæ¶æ„ä»…èšç„¦äºç‰¹å¾èåˆï¼Œç¼ºå°‘äº†å—å†…è¿æ¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ç§æ–°çš„è·¯å¾„èåˆGFPNï¼šåŒ…å«è·³å±‚ä¸è·¨å°ºåº¦è¿æ¥ï¼Œè§ä¸Šå›¾dã€‚</p> 
<h2 id="2.%C2%A0GFPN%E5%BC%95%E5%85%A5%E5%88%B0Yolov8"><a name="t6"></a>2.&nbsp;GFPNå¼•å…¥åˆ°Yolov8</h2> 
<h3 id="2.1%E4%BF%AE%E6%94%B9modules.py"><a name="t7"></a>2.1ä¿®æ”¹modules.py</h3> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln hundred" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">###################### GFPN  ####     strat   <span class="hljs-keyword">by</span>  AI<span class="hljs-operator">&amp;</span>CV  ###############################</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn <span class="hljs-keyword">as</span> nn</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">import torch.nn.functional <span class="hljs-keyword">as</span> F</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def conv_bn(<span class="hljs-keyword">in</span>_channels, out_channels, kernel_<span class="hljs-keyword">size</span>, stride, padding, groups<span class="hljs-operator">=</span><span class="hljs-number">1</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">''</span><span class="hljs-string">'Basic cell for rep-style block, including conv and bn'</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    result <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    result.<span class="hljs-keyword">add</span>_module(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-string">'conv'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                  out_channels<span class="hljs-operator">=</span>out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                  kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                  stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                  padding<span class="hljs-operator">=</span>padding,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                  groups<span class="hljs-operator">=</span>groups,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                  bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    result.<span class="hljs-keyword">add</span>_module(<span class="hljs-string">'bn'</span>, nn.BatchNorm<span class="hljs-number">2</span>d(num_features<span class="hljs-operator">=</span>out_channels))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> result</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> RepConv(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">''</span><span class="hljs-string"><span class="hljs-string">'RepConv is a basic rep-style block, including training and deploy status</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Code is based on https://github.com/DingXiaoH/RepVGG/blob/main/repvgg.py</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    '</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">3</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 padding<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 dilation<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 groups<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 padding_<span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-string">'zeros'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 deploy<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 act<span class="hljs-operator">=</span><span class="hljs-string">'relu'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 norm<span class="hljs-operator">=</span>None):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(RepConv, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.deploy <span class="hljs-operator">=</span> deploy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.groups <span class="hljs-operator">=</span> groups</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels <span class="hljs-operator">=</span> <span class="hljs-keyword">in</span>_channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.out_channels <span class="hljs-operator">=</span> out_channels</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert padding <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        padding_<span class="hljs-number">11</span> <span class="hljs-operator">=</span> padding<span class="hljs-operator"> - </span>kernel_<span class="hljs-keyword">size</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> isinstance(act, str):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.nonlinearity <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_activation(act)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.nonlinearity <span class="hljs-operator">=</span> act</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> deploy:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_reparam <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         out_channels<span class="hljs-operator">=</span>out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         padding<span class="hljs-operator">=</span>padding,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         dilation<span class="hljs-operator">=</span>dilation,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         groups<span class="hljs-operator">=</span>groups,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         padding_<span class="hljs-keyword">mode</span><span class="hljs-operator">=</span>padding_<span class="hljs-keyword">mode</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_identity <span class="hljs-operator">=</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_dense <span class="hljs-operator">=</span> conv_bn(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     out_channels<span class="hljs-operator">=</span>out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     padding<span class="hljs-operator">=</span>padding,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                     groups<span class="hljs-operator">=</span>groups)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> conv_bn(<span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                   out_channels<span class="hljs-operator">=</span>out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                   kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                   stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                   padding<span class="hljs-operator">=</span>padding_<span class="hljs-number">11</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                   groups<span class="hljs-operator">=</span>groups)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, inputs):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-string">''</span><span class="hljs-string">'Forward process'</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'rbr_reparam'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.nonlinearity(<span class="hljs-keyword">self</span>.rbr_reparam(inputs))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.rbr_identity <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            id_out <span class="hljs-operator">=</span> <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            id_out <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.rbr_identity(inputs)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.nonlinearity(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.rbr_dense(inputs) <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>.rbr_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>(inputs) <span class="hljs-operator">+</span> id_out)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def <span class="hljs-keyword">get</span>_equivalent_kernel_bias(<span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span>, bias<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(<span class="hljs-keyword">self</span>.rbr_dense)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>, bias<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(<span class="hljs-keyword">self</span>.rbr_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernelid, biasid <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>._fuse_bn_tensor(<span class="hljs-keyword">self</span>.rbr_identity)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> kernel<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>._pad_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>_<span class="hljs-keyword">to</span>_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_tensor(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>) <span class="hljs-operator">+</span> kernelid, bias<span class="hljs-number">3</span>x<span class="hljs-number">3</span> <span class="hljs-operator">+</span> bias<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> biasid</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _pad_<span class="hljs-number">1</span>x<span class="hljs-number">1</span>_<span class="hljs-keyword">to</span>_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_tensor(<span class="hljs-keyword">self</span>, kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span> <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> torch.nn.functional.pad(kernel<span class="hljs-number">1</span>x<span class="hljs-number">1</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _fuse_bn_tensor(<span class="hljs-keyword">self</span>, branch):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> branch <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-number">0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> isinstance(branch, nn.<span class="hljs-keyword">Sequential</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel <span class="hljs-operator">=</span> branch.conv.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_mean <span class="hljs-operator">=</span> branch.bn.running_mean</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_var <span class="hljs-operator">=</span> branch.bn.running_var</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            gamma <span class="hljs-operator">=</span> branch.bn.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            beta <span class="hljs-operator">=</span> branch.bn.bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            eps <span class="hljs-operator">=</span> branch.bn.eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            assert isinstance(branch, nn.BatchNorm<span class="hljs-number">2</span>d)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'id_tensor'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">input</span>_dim <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.groups</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                kernel_<span class="hljs-keyword">value</span> <span class="hljs-operator">=</span> np.<span class="hljs-literal">zeros</span>((<span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels, <span class="hljs-keyword">input</span>_dim, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                        dtype<span class="hljs-operator">=</span>np.float<span class="hljs-number">32</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">in</span>_channels):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    kernel_<span class="hljs-keyword">value</span>[i, i % <span class="hljs-keyword">input</span>_dim, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>] <span class="hljs-operator">=</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">self</span>.id_tensor <span class="hljs-operator">=</span> torch.<span class="hljs-keyword">from</span>_numpy(kernel_<span class="hljs-keyword">value</span>).<span class="hljs-keyword">to</span>(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    branch.weight.device)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.id_tensor</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_mean <span class="hljs-operator">=</span> branch.running_mean</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            running_var <span class="hljs-operator">=</span> branch.running_var</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            gamma <span class="hljs-operator">=</span> branch.weight</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            beta <span class="hljs-operator">=</span> branch.bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            eps <span class="hljs-operator">=</span> branch.eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        std <span class="hljs-operator">=</span> (running_var <span class="hljs-operator">+</span> eps).sqrt()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        t <span class="hljs-operator">=</span> (gamma <span class="hljs-operator">/</span> std).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> kernel <span class="hljs-operator">*</span> t, beta<span class="hljs-operator"> - </span>running_mean <span class="hljs-operator">*</span> gamma <span class="hljs-operator">/</span> std</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def switch_<span class="hljs-keyword">to</span>_deploy(<span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'rbr_reparam'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        kernel, bias <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">get</span>_equivalent_kernel_bias()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.rbr_reparam <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">in</span>_channels<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.<span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            out_channels<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.kernel_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            stride<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            padding<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.padding,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            dilation<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.dilation,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            groups<span class="hljs-operator">=</span><span class="hljs-keyword">self</span>.rbr_dense.conv.groups,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            bias<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.rbr_reparam.weight.<span class="hljs-keyword">data</span> <span class="hljs-operator">=</span> kernel</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.rbr_reparam.bias.<span class="hljs-keyword">data</span> <span class="hljs-operator">=</span> bias</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.parameters():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            para.detach_()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'rbr_dense'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'rbr_1x1'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'rbr_identity'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'rbr_identity'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> hasattr(<span class="hljs-keyword">self</span>, <span class="hljs-string">'id_tensor'</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.__delattr__(<span class="hljs-string">'id_tensor'</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.deploy <span class="hljs-operator">=</span> <span class="hljs-keyword">True</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> Swish(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(Swish, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.inplace <span class="hljs-operator">=</span> inplace</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.inplace:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x.mul_(F.sigmoid(x))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> x <span class="hljs-operator">*</span> F.sigmoid(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_activation(name<span class="hljs-operator">=</span><span class="hljs-string">'silu'</span>, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> name <span class="hljs-keyword">is</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> isinstance(name, str):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'silu'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            module <span class="hljs-operator">=</span> nn.SiLU(inplace<span class="hljs-operator">=</span>inplace)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'relu'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            module <span class="hljs-operator">=</span> nn.ReLU(inplace<span class="hljs-operator">=</span>inplace)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'lrelu'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            module <span class="hljs-operator">=</span> nn.LeakyReLU(<span class="hljs-number">0.1</span>, inplace<span class="hljs-operator">=</span>inplace)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'swish'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            module <span class="hljs-operator">=</span> Swish(inplace<span class="hljs-operator">=</span>inplace)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'hardsigmoid'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            module <span class="hljs-operator">=</span> nn.Hardsigmoid(inplace<span class="hljs-operator">=</span>inplace)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        elif name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'identity'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            module <span class="hljs-operator">=</span> nn.Identity()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">'Unsupported act type: {}'</span>.<span class="hljs-keyword">format</span>(name))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> module</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    elif isinstance(name, nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> name</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">'Unsupported act type: {}'</span>.<span class="hljs-keyword">format</span>(name))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_norm(name, out_channels, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> name <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'bn'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        module <span class="hljs-operator">=</span> nn.BatchNorm<span class="hljs-number">2</span>d(out_channels)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">raise</span> NotImplementedError</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> module</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> ConvBNAct(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string">"A Conv2d -&gt; Batchnorm -&gt; silu/leaky relu block"</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        ksize,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        groups<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        bias<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        act<span class="hljs-operator">=</span><span class="hljs-string">'silu'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        norm<span class="hljs-operator">=</span><span class="hljs-string">'bn'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        reparam<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    ):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>().__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        # <span class="hljs-keyword">same</span> padding</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        pad <span class="hljs-operator">=</span> (ksize<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> nn.Conv<span class="hljs-number">2</span>d(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">in</span>_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            out_channels,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span>ksize,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            stride<span class="hljs-operator">=</span>stride,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            padding<span class="hljs-operator">=</span>pad,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            groups<span class="hljs-operator">=</span>groups,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            bias<span class="hljs-operator">=</span>bias,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> norm <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.bn <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_norm(norm, out_channels, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> act <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.act <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_activation(act, inplace<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">with</span>_norm <span class="hljs-operator">=</span> norm <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">with</span>_act <span class="hljs-operator">=</span> act <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> None</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">with</span>_norm:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.bn(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-keyword">with</span>_act:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            x <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.act(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> x</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def fuseforward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.act(<span class="hljs-keyword">self</span>.conv(x))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> BasicBlock_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_Reverse(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">ch</span>_hidden_ratio,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">ch</span>_out,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 act<span class="hljs-operator">=</span><span class="hljs-string">'relu'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 shortcut<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(BasicBlock_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_Reverse, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        assert <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span> <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>_out</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span>_hidden <span class="hljs-operator">=</span> int(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">ch</span>_hidden_ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv<span class="hljs-number">1</span> <span class="hljs-operator">=</span> ConvBNAct(<span class="hljs-keyword">ch</span>_hidden, <span class="hljs-keyword">ch</span>_out, <span class="hljs-number">3</span>, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, act<span class="hljs-operator">=</span>act)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv<span class="hljs-number">2</span> <span class="hljs-operator">=</span> RepConv(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_hidden, <span class="hljs-number">3</span>, stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>, act<span class="hljs-operator">=</span>act)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.shortcut <span class="hljs-operator">=</span> shortcut</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv<span class="hljs-number">2</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv<span class="hljs-number">1</span>(y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.shortcut:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> x <span class="hljs-operator">+</span> y</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> y</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> SPP(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span>_out,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        k,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        pool_<span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        act<span class="hljs-operator">=</span><span class="hljs-string">'swish'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    ):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(SPP, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.pool <span class="hljs-operator">=</span> []</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i, <span class="hljs-keyword">size</span> <span class="hljs-keyword">in</span> enumerate(pool_<span class="hljs-keyword">size</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            pool <span class="hljs-operator">=</span> nn.MaxPool<span class="hljs-number">2</span>d(kernel_<span class="hljs-keyword">size</span><span class="hljs-operator">=</span><span class="hljs-keyword">size</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                stride<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                padding<span class="hljs-operator">=</span><span class="hljs-keyword">size</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                ceil_<span class="hljs-keyword">mode</span><span class="hljs-operator">=</span><span class="hljs-keyword">False</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.<span class="hljs-keyword">add</span>_module(<span class="hljs-string">'pool{}'</span>.<span class="hljs-keyword">format</span>(i), pool)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">self</span>.pool.append(pool)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv <span class="hljs-operator">=</span> ConvBNAct(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_out, k, act<span class="hljs-operator">=</span>act)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        outs <span class="hljs-operator">=</span> [x]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> pool <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.pool:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            outs.append(pool(x))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> torch.cat(outs, axis<span class="hljs-operator">=</span><span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="299"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="300"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv(y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="301"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> y</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="302"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="303"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> CSPStage(nn.Module):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="304"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="305"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="306"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">ch</span>_out,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="307"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 n<span class="hljs-operator">=</span><span class="hljs-number">1</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="308"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">block</span>_fn<span class="hljs-operator">=</span><span class="hljs-string">'BasicBlock_3x3_Reverse'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="309"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 <span class="hljs-keyword">ch</span>_hidden_ratio<span class="hljs-operator">=</span><span class="hljs-number">1.0</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="310"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 act<span class="hljs-operator">=</span><span class="hljs-string">'silu'</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="311"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 spp<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="312"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">super</span>(CSPStage, <span class="hljs-keyword">self</span>).__init__()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="313"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="314"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        split_ratio <span class="hljs-operator">=</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="315"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">first</span> <span class="hljs-operator">=</span> int(<span class="hljs-keyword">ch</span>_out <span class="hljs-operator">/</span><span class="hljs-operator">/</span> split_ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="316"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span>_mid <span class="hljs-operator">=</span> int(<span class="hljs-keyword">ch</span>_out<span class="hljs-operator"> - </span><span class="hljs-keyword">ch</span>_<span class="hljs-keyword">first</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="317"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv<span class="hljs-number">1</span> <span class="hljs-operator">=</span> ConvBNAct(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">first</span>, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span>act)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="318"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ConvBNAct(<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>, <span class="hljs-keyword">ch</span>_mid, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span>act)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="319"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.convs <span class="hljs-operator">=</span> nn.<span class="hljs-keyword">Sequential</span>()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="320"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="321"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">next</span>_<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>_mid</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="322"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="323"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">block</span>_fn <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">'BasicBlock_3x3_Reverse'</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="324"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">self</span>.convs.<span class="hljs-keyword">add</span>_module(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="325"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    str(i),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="326"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    BasicBlock_<span class="hljs-number">3</span>x<span class="hljs-number">3</span>_Reverse(<span class="hljs-keyword">next</span>_<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="327"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                           <span class="hljs-keyword">ch</span>_hidden_ratio,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="328"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                           <span class="hljs-keyword">ch</span>_mid,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="329"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                           act<span class="hljs-operator">=</span>act,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="330"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                           shortcut<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="331"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="332"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">raise</span> NotImplementedError</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="333"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> i <span class="hljs-operator">=</span><span class="hljs-operator">=</span> (n<span class="hljs-operator"> - </span><span class="hljs-number">1</span>) <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> spp:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="334"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">self</span>.convs.<span class="hljs-keyword">add</span>_module(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="335"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-string">'spp'</span>, SPP(<span class="hljs-keyword">ch</span>_mid <span class="hljs-operator">*</span> <span class="hljs-number">4</span>, <span class="hljs-keyword">ch</span>_mid, <span class="hljs-number">1</span>, [<span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">13</span>], act<span class="hljs-operator">=</span>act))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="336"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">next</span>_<span class="hljs-keyword">ch</span>_<span class="hljs-keyword">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>_mid</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="337"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.conv<span class="hljs-number">3</span> <span class="hljs-operator">=</span> ConvBNAct(<span class="hljs-keyword">ch</span>_mid <span class="hljs-operator">*</span> n <span class="hljs-operator">+</span> <span class="hljs-keyword">ch</span>_<span class="hljs-keyword">first</span>, <span class="hljs-keyword">ch</span>_out, <span class="hljs-number">1</span>, act<span class="hljs-operator">=</span>act)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="338"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="339"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def forward(<span class="hljs-keyword">self</span>, x):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="340"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y<span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv<span class="hljs-number">1</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="341"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv<span class="hljs-number">2</span>(x)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="342"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="343"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        mid_out <span class="hljs-operator">=</span> [y<span class="hljs-number">1</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="344"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">for</span> conv <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.convs:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="345"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> conv(y<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="346"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            mid_out.append(y<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="347"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> torch.cat(mid_out, axis<span class="hljs-operator">=</span><span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="348"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        y <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.conv<span class="hljs-number">3</span>(y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="349"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> y</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="350"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="351"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="352"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="353"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">###################### GPFN  ####     <span class="hljs-keyword">END</span>   <span class="hljs-keyword">by</span>  AI<span class="hljs-operator">&amp;</span>CV  ###############################</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<h3 id="2.2%C2%A0%20CSPStage%E6%B3%A8%E5%86%8Ctasks.py"><a name="t8"></a>2.2&nbsp; CSPStageæ³¨å†Œtasks.py</h3> 
<pre data-index="1"><code class="hljs language-haskell"><ol class="hljs-ln" style="width:1086px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-title">from</span> ultralytics.nn.modules <span class="hljs-keyword">import</span> (<span class="hljs-type">C1</span>, <span class="hljs-type">C2</span>, <span class="hljs-type">C3</span>, <span class="hljs-type">C3TR</span>, <span class="hljs-type">SPP</span>, <span class="hljs-type">SPPF</span>, <span class="hljs-type">Bottleneck</span>, <span class="hljs-type">BottleneckCSP</span>, <span class="hljs-type">C2f</span>, <span class="hljs-type">C3Ghost</span>, <span class="hljs-type">C3x</span>, <span class="hljs-type">Classify</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                    <span class="hljs-type">Concat</span>, <span class="hljs-type">Conv</span>, <span class="hljs-type">ConvTranspose</span>, <span class="hljs-type">Detect</span>, <span class="hljs-type">DWConv</span>, <span class="hljs-type">DWConvTranspose2d</span>, <span class="hljs-type">Ensemble</span>, <span class="hljs-type">Focus</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                    <span class="hljs-type">GhostBottleneck</span>, <span class="hljs-type">GhostConv</span>, <span class="hljs-type">Segment</span>, <span class="hljs-type">CSPStage</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                    )</div></div></li></ol></code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<p></p> 
<pre data-index="2"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1069px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">n <span class="hljs-operator">=</span> n_ <span class="hljs-operator">=</span> max(round(n <span class="hljs-operator">*</span> depth), <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> n <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> n  # depth gain</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (Classify, Conv, ConvTranspose, GhostConv, Bottleneck, GhostBottleneck, SPP, SPPF, DWConv, Focus,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                 BottleneckCSP, C<span class="hljs-number">1</span>, C<span class="hljs-number">2</span>, C<span class="hljs-number">2</span>f, C<span class="hljs-number">3</span>, C<span class="hljs-number">3</span>TR, C<span class="hljs-number">3</span>Ghost, nn.ConvTranspose<span class="hljs-number">2</span>d, DWConvTranspose<span class="hljs-number">2</span>d, C<span class="hljs-number">3</span>x, CSPStage):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span>[f], args[<span class="hljs-number">0</span>]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> !<span class="hljs-operator">=</span> nc:  # <span class="hljs-keyword">if</span> c<span class="hljs-number">2</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">equal</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes (i.e. <span class="hljs-keyword">for</span> Classify() <span class="hljs-keyword">output</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> make_divisible(min(c<span class="hljs-number">2</span>, max_channels) <span class="hljs-operator">*</span> width, <span class="hljs-number">8</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            args <span class="hljs-operator">=</span> [c<span class="hljs-number">1</span>, c<span class="hljs-number">2</span>, <span class="hljs-operator">*</span>args[<span class="hljs-number">1</span>:]]</div></div></li></ol></code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<h3 id="2.3%20%E4%BF%AE%E6%94%B9yolov8_GFPN.yaml"><a name="t9"></a>2.3 ä¿®æ”¹yolov8_GFPN.yaml</h3> 
<pre data-index="3" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1052px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Ultralytics YOLO ğŸš€, GPL-<span class="hljs-number">3.0</span> license</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8</span> <span class="hljs-keyword">object</span> detection model <span class="hljs-keyword">with</span> P<span class="hljs-number">3</span>-P<span class="hljs-number">5</span> outputs. <span class="hljs-keyword">For</span> <span class="hljs-keyword">Usage</span> examples see https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>docs.ultralytics.com<span class="hljs-operator">/</span>tasks<span class="hljs-operator">/</span>detect</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># Parameters</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">nc: <span class="hljs-number">4</span>  # <span class="hljs-keyword">number</span> <span class="hljs-keyword">of</span> classes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">scales: # model compound scaling constants, i.e. <span class="hljs-string">'model=yolov8n.yaml'</span> will <span class="hljs-keyword">call</span> yolov<span class="hljs-number">8</span>.yaml <span class="hljs-keyword">with</span> scale <span class="hljs-string">'n'</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [depth, width, max_channels]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  n: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>n summary: <span class="hljs-number">225</span> layers,  <span class="hljs-number">3157200</span> parameters,  <span class="hljs-number">3157184</span> gradients,   <span class="hljs-number">8.9</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  s: [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.50</span>, <span class="hljs-number">1024</span>]  # YOLOv<span class="hljs-number">8</span>s summary: <span class="hljs-number">225</span> layers, <span class="hljs-number">11166560</span> parameters, <span class="hljs-number">11166544</span> gradients,  <span class="hljs-number">28.8</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  m: [<span class="hljs-number">0.67</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">768</span>]   # YOLOv<span class="hljs-number">8</span>m summary: <span class="hljs-number">295</span> layers, <span class="hljs-number">25902640</span> parameters, <span class="hljs-number">25902624</span> gradients,  <span class="hljs-number">79.3</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  l: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>l summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">43691520</span> parameters, <span class="hljs-number">43691504</span> gradients, <span class="hljs-number">165.7</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  x: [<span class="hljs-number">1.00</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">512</span>]   # YOLOv<span class="hljs-number">8</span>x summary: <span class="hljs-number">365</span> layers, <span class="hljs-number">68229648</span> parameters, <span class="hljs-number">68229632</span> gradients, <span class="hljs-number">258.5</span> GFLOPs</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n backbone</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">backbone:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">  # [<span class="hljs-keyword">from</span>, repeats, module, args]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">0</span>-P<span class="hljs-number">1</span><span class="hljs-operator">/</span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">1</span>-P<span class="hljs-number">2</span><span class="hljs-operator">/</span><span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">128</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">3</span>-P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">256</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">5</span>-P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">512</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]  # <span class="hljs-number">7</span>-P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, C<span class="hljs-number">2</span>f, [<span class="hljs-number">1024</span>, <span class="hljs-keyword">True</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, SPPF, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]]  # <span class="hljs-number">9</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"># YOLOv<span class="hljs-number">8.0</span>n head</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">head:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">6</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, CSPStage, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">12</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, nn.Upsample, [None, <span class="hljs-number">2</span>, <span class="hljs-string">'nearest'</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat backbone P<span class="hljs-number">3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, CSPStage, [<span class="hljs-number">256</span>]]  # <span class="hljs-number">15</span> (P<span class="hljs-number">3</span><span class="hljs-operator">/</span><span class="hljs-number">8</span>-small)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">12</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">4</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, CSPStage, [<span class="hljs-number">512</span>]]  # <span class="hljs-number">18</span> (P<span class="hljs-number">4</span><span class="hljs-operator">/</span><span class="hljs-number">16</span>-medium)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, Conv, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]]</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[-<span class="hljs-number">1</span>, <span class="hljs-number">9</span>], <span class="hljs-number">1</span>, Concat, [<span class="hljs-number">1</span>]]  # cat head P<span class="hljs-number">5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, CSPStage, [<span class="hljs-number">1024</span>]]  # <span class="hljs-number">21</span> (P<span class="hljs-number">5</span><span class="hljs-operator">/</span><span class="hljs-number">32</span>-large)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> <span class="hljs-operator"> - </span>[[<span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>], <span class="hljs-number">1</span>, Detect, [nc]]  # Detect(P<span class="hljs-number">3</span>, P<span class="hljs-number">4</span>, P<span class="hljs-number">5</span>)</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<h2 id="3.%E6%95%B0%E6%8D%AE%E9%9B%86%E9%AA%8C%E8%AF%81%E6%80%A7%E8%83%BD"><a name="t10"></a>3.æ•°æ®é›†éªŒè¯æ€§èƒ½</h2> 
<p>mapä»åŸå§‹çš„0.841æå‡åˆ°0.844</p> 
<p><img alt="" height="494" src="https://img-blog.csdnimg.cn/81eab304819d4934a6475998db7e15e5.png" width="746"></p> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/130625240&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>