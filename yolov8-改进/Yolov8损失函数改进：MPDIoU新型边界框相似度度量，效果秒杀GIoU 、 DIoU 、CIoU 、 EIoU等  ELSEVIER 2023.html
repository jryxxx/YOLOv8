<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <p></p> 
<p>💡💡💡<span style="color:#fe2c24;"><strong>本文改进：</strong></span><span style="color:#956fe7;"><strong>MPDIoU新型边界框相似度度量</strong></span>，优化<span style="color:#fe2c24;">当预测框与真实框具有相同的长宽比，但宽度和高度值完全不同时的问题，大多数（GIoU 、 DIoU 、CIoU 、 EIoU）现有的边界框回归损失函数无法优化</span></p> 
<p><span style="color:#956fe7;">MPDIoU | &nbsp; 亲测在多个数据集能够实现涨点，对小目标、遮挡物性能提升也能够助力涨点。</span></p> 
<p>💡💡💡<span style="color:#4da8ee;">Yolov8魔术师，独家首发创新（原创），适用于Yolov5、Yolov7、Yolov8等各个Yolo系列，专栏文章提供每一步步骤和源码，轻松带你上手魔改网络</span></p> 
<p>💡💡💡<span style="color:#38d8f0;">重点：通过本专栏的阅读，后续你也可以自己魔改网络，在网络不同位置（Backbone、head、detect、loss等）进行魔改，实现创新！！！</span></p> 
<p><span style="color:#fe2c24;"><strong>专栏介绍：</strong></span></p> 
<p>✨✨✨<span style="color:#a2e043;"><strong>原创魔改网络、复现前沿论文，组合优化创新</strong></span></p> 
<p>🚀🚀🚀<span style="color:#38d8f0;">小目标、遮挡物、难样本性能提升</span></p> 
<p>🍉🍉🍉<span style="color:#4da8ee;">持续更新中，定期更新不同数据集涨点情况</span></p> 
<p></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t0" target="_self">1.MPDIoU介绍</a></p> 
<p id="" style="margin: 0px 0px 2px; padding-left: 24px;"><a href="#t1" target="_self">&nbsp;2.MPDIou加入Yolov8</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t2" target="_self">2.1 修改ultralytics/yolo/utils/metrics.py</a></p> 
<p id="" style="margin: 0px 0px 2px 48px; padding-left: 24px;"><a href="#t3" target="_self">2.2 修改ultralytics/yolo/utils/loss.py</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="1.MPDIoU%E4%BB%8B%E7%BB%8D"><a name="t0"></a><span style="color:#0d0016;">1.<strong>MPDIoU介绍</strong></span></h2> 
<p><img alt="" height="397" src="https://img-blog.csdnimg.cn/64e9a1a8bccf46eebdee599e94672d72.png" width="852"></p> 
<p>论文：<a href="https://arxiv.org/pdf/2307.07662.pdf" title="https://arxiv.org/pdf/2307.07662.pdf">https://arxiv.org/pdf/2307.07662.pdf</a>&nbsp;</p> 
<p>&nbsp;摘要：<a href="https://so.csdn.net/so/search?q=%E8%BE%B9%E7%95%8C%E6%A1%86&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E8%BE%B9%E7%95%8C%E6%A1%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;边界框\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E8%BE%B9%E7%95%8C%E6%A1%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;边界框\&quot;}&quot;}" data-tit="边界框" data-pretit="边界框">边界框</a>回归（BBR）已广泛应用于对象检测和实例分割，是对象定位的重要步骤。 然而，<span style="color:#fe2c24;">当预测框与真实框具有相同的长宽比，但宽度和高度值完全不同时，大多数现有的边界框回归损失函数无法优化。</span> 为了解决上述问题，我们充分挖掘水平矩形的几何特征，<span style="color:#fe2c24;">提出了一种基于最小点距离的新型边界框相似度比较度量MPDIoU</span>，它包含了现有损失函数中考虑的所有相关因素，<span style="color:#fe2c24;">即重叠 或非重叠区域、中心点距离、宽高偏差</span>，同时简化计算过程。 在此基础上，我们提出了一种基于 MPDIoU 的边界框回归损失函数，称为 LMPDIoU 。 实验结果表明，MPDIoU 损失函数适用于在 PASCAL VOC、MS COCO 和 IIIT5k 上训练的最先进的实例分割（例如 YOLACT）和对象检测（例如 YOLOv7）模型优于现有的损失函数。</p> 
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;具有不同边界框回归结果的两种情况。绿色框表示真实边界框，红色框表示预测边界框。 这两种情况之间的 LGIoU 、 LDIoU 、LCIoU 、 LEIoU 的值完全相同，但LMPDIoU不同<img alt="" height="534" src="https://img-blog.csdnimg.cn/8870fbe183394e0eb45a1e7b43b4c4f0.png" width="1200"></p> 
<p>&nbsp;在分析了上面提到的基于 IoU 的损失函数的优缺点后，我们开始思考如何提高边界框回归的准确性和效率。 一般来说，我们使用左上角和右下角的坐标来定义一个唯一的矩形。 受边界框几何特性的启发，我们设计了一种名为 MPDIoU 的新颖的基于 IoU 的度量，以直接最小化预测边界框与真实边界框之间的左上角和右下点距离。 MPDIoU 算法流程如下：</p> 
<p><img alt="" height="328" src="https://img-blog.csdnimg.cn/78baeac834ae4bad95a72b8ea66fb8b3.png" width="1200"></p> 
<p><img alt="" height="698" src="https://img-blog.csdnimg.cn/79e8a38345914aadabf8476a50479341.png" width="1200"></p> 
<p></p> 
<p>&nbsp;图 4：具有相同长宽比但不同宽度和高度的预测边界框和真实边界框的示例，其中 k &gt; 1 且 k ∈ R，绿色框表示真实框，红色框表示预测框。&nbsp;<img alt="" height="463" src="https://img-blog.csdnimg.cn/537d0fe6d0694b4b8221302d0e78d0be.png" width="1200"></p> 
<p>&nbsp;实验</p> 
<p><img alt="" height="528" src="https://img-blog.csdnimg.cn/88e7594bc4a34b8a860085fe50741954.png" width="1200"></p> 
<p>&nbsp;<img alt="" height="539" src="https://img-blog.csdnimg.cn/a9ca4abb07e0494190fb8775c96121d2.png" width="580"></p> 
<p>&nbsp;<img alt="" height="600" src="https://img-blog.csdnimg.cn/bcaae1a04e574de8838e8d3757575320.png" width="1120"></p> 
<h2 id="%C2%A02.MPDIou%E5%8A%A0%E5%85%A5Yolov8"><a name="t1"></a>&nbsp;2.MPDIou加入Yolov8</h2> 
<h3 id="2.1%20%E4%BF%AE%E6%94%B9ultralytics%2Fyolo%2Futils%2Fmetrics.py"><a name="t2"></a>2.1 修改ultralytics/yolo/utils/metrics.py</h3> 
<p>在原有<a href="https://so.csdn.net/so/search?q=GIoU&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=GIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;GIoU\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=GIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;GIoU\&quot;}&quot;}" data-tit="GIoU" data-pretit="giou">GIoU</a>、DIoU、CIoU、SIoU、 EIoU=、 WIoU、Focal基础上，加入MPDIou</p> 
<pre data-index="0" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln hundred" style="width:1285px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WIoU_Scale:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">''</span><span class="hljs-string"><span class="hljs-string">' monotonous: {</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            None: origin v1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            True: monotonic FM v2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            False: non-monotonic FM v3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        }</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        需要设置scale，scale为True时，WIoU会乘以一个系数，结合monotonous即会对应WIoU的3个版本。</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        momentum: The momentum of running mean'</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou_mean <span class="hljs-operator">=</span> <span class="hljs-number">1</span>.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    monotonous <span class="hljs-operator">=</span> <span class="hljs-keyword">False</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    _momentum <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator"> - </span><span class="hljs-number">0.5</span> <span class="hljs-operator">**</span> (<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">7000</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    _<span class="hljs-keyword">is</span>_train <span class="hljs-operator">=</span> <span class="hljs-keyword">True</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, iou):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.iou <span class="hljs-operator">=</span> iou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>._update(<span class="hljs-keyword">self</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    @classmethod</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _update(cls, <span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> cls._<span class="hljs-keyword">is</span>_train: cls.iou_mean <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator"> - </span>cls._momentum) <span class="hljs-operator">*</span> cls.iou_mean <span class="hljs-operator">+</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         cls._momentum <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.iou.detach().mean().item()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    @classmethod</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _scaled_loss(cls, <span class="hljs-keyword">self</span>, gamma<span class="hljs-operator">=</span><span class="hljs-number">1.9</span>, delta<span class="hljs-operator">=</span><span class="hljs-number">3</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> isinstance(<span class="hljs-keyword">self</span>.monotonous, bool):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.monotonous:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.iou.detach() <span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.iou_mean).sqrt()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                beta <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.iou.detach() <span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.iou_mean</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                alpha <span class="hljs-operator">=</span> delta <span class="hljs-operator">*</span> torch.pow(gamma, beta<span class="hljs-operator"> - </span>delta)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> beta <span class="hljs-operator">/</span> alpha</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def bbox_iou_improve(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, GIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, DIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, SIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, EIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, WIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, Focal<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, MPDIou<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                     alpha<span class="hljs-operator">=</span><span class="hljs-number">1</span>, gamma<span class="hljs-operator">=</span><span class="hljs-number">0.5</span>, scale<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    计算bboxes iou</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    GIoU: 为True时计算GIoU v5自带</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    DIoU: 为True时计算DIoU v5自带</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    CIoU: 为True时计算CIoU v5自带，默认使用</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    SIoU: 为True时计算SIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    EIoU: 为True时计算EIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    WIoU: 为True时计算WIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    MPDIou: 为True时计算WIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Focal: 为True时，可结合其他的XIoU生成对应的IoU变体，如CIoU = True，Focal = True时为Focal - CIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    alpha: AlphaIoU中的alpha参数，默认为1，为1时则为普通的IoU，如果想采用AlphaIoU，论文alpha默认值为3，此时设置CIoU = True则为AlphaCIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    gamma: Focal_XIoU中的gamma参数，默认为0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    .5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    scale: scale为True时，WIoU会乘以一个系数</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    monotonous: 3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    个输入分别代表WIoU的3个版本，N</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Returns Intersection over Union (IoU) <span class="hljs-keyword">of</span> box<span class="hljs-number">1</span>(<span class="hljs-number">1,4</span>) <span class="hljs-keyword">to</span> box<span class="hljs-number">2</span>(n,<span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Get</span> the coordinates <span class="hljs-keyword">of</span> bounding boxes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> xywh:  # transform <span class="hljs-keyword">from</span> xywh <span class="hljs-keyword">to</span> xyxy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>_, h<span class="hljs-number">1</span>_, w<span class="hljs-number">2</span>_, h<span class="hljs-number">2</span>_ <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">1</span>_, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> h<span class="hljs-number">1</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>_, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> h<span class="hljs-number">2</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:  # x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>).clamp(eps)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, (b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>).clamp(eps)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span><span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> scale:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> WIoU_Scale(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(inter <span class="hljs-operator">/</span> union))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # iou <span class="hljs-operator">=</span> inter <span class="hljs-operator">/</span> union # ori iou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou <span class="hljs-operator">=</span> torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), alpha)  # alpha iou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> GIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU <span class="hljs-keyword">or</span> WIoU <span class="hljs-keyword">or</span> MPDIou:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cw <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)  # convex (smallest enclosing box) width</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)  # convex height</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU <span class="hljs-keyword">or</span> WIoU <span class="hljs-keyword">or</span> MPDIou:  # Distance <span class="hljs-keyword">or</span> Complete IoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>abs<span class="hljs-operator">/</span><span class="hljs-number">1911.08287</span>v<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> (cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">**</span> alpha <span class="hljs-operator">+</span> eps  # convex diagonal squared</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            rho<span class="hljs-number">2</span> <span class="hljs-operator">=</span> (((b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> (</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                        b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span> <span class="hljs-number">4</span>) <span class="hljs-operator">**</span> alpha  # center dist <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> CIoU:  # https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>github.com<span class="hljs-operator">/</span>Zzh-tju<span class="hljs-operator">/</span>DIoU-SSD-pytorch<span class="hljs-operator">/</span>blob<span class="hljs-operator">/</span>master<span class="hljs-operator">/</span>utils<span class="hljs-operator">/</span>box<span class="hljs-operator">/</span>box_utils.py#L<span class="hljs-number">47</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                v <span class="hljs-operator">=</span> (<span class="hljs-number">4</span> <span class="hljs-operator">/</span> math.pi <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">*</span> (torch.atan(w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> h<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>torch.atan(w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> h<span class="hljs-number">1</span>)).pow(<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">with</span> torch.<span class="hljs-keyword">no</span>_grad():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    alpha_ciou <span class="hljs-operator">=</span> v <span class="hljs-operator">/</span> (v<span class="hljs-operator"> - </span>iou <span class="hljs-operator">+</span> (<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> torch.pow(v <span class="hljs-operator">*</span> alpha_ciou <span class="hljs-operator">+</span> eps, alpha)), torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                                 gamma)  # Focal_CIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> torch.pow(v <span class="hljs-operator">*</span> alpha_ciou <span class="hljs-operator">+</span> eps, alpha))  # CIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif EIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_w<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                cw<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.pow(cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps, alpha)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">ch</span><span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.pow(<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps, alpha)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>), torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                      gamma)  # Focal_EIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>)  # EIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif SIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                # SIoU Loss https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">2205.12740</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_cw <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sigma <span class="hljs-operator">=</span> torch.pow(s_cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">=</span> torch.abs(s_cw) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.abs(s_<span class="hljs-keyword">ch</span>) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                threshold <span class="hljs-operator">=</span> pow(<span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha <span class="hljs-operator">=</span> torch.where(sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">&gt;</span> threshold, sin_alpha_<span class="hljs-number">2</span>, sin_alpha_<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                angle_cost <span class="hljs-operator">=</span> torch.cos(torch.arcsin(sin_alpha) <span class="hljs-operator">*</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>math.pi <span class="hljs-operator">/</span> <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_x <span class="hljs-operator">=</span> (s_cw <span class="hljs-operator">/</span> cw) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_y <span class="hljs-operator">=</span> (s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                gamma <span class="hljs-operator">=</span> angle_cost<span class="hljs-operator"> - </span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                distance_cost <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_x)<span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_w <span class="hljs-operator">=</span> torch.abs(w<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(w<span class="hljs-number">1</span>, w<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_h <span class="hljs-operator">=</span> torch.abs(h<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(h<span class="hljs-number">1</span>, h<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                shape_cost <span class="hljs-operator">=</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_w), <span class="hljs-number">4</span>) <span class="hljs-operator">+</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_h), <span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow(<span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> (distance_cost <span class="hljs-operator">+</span> shape_cost) <span class="hljs-operator">+</span> eps, alpha), torch.pow(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                        inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), gamma)  # Focal_SIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow(<span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> (distance_cost <span class="hljs-operator">+</span> shape_cost) <span class="hljs-operator">+</span> eps, alpha)  # SIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif WIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"WIoU do not support Focal."</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                elif scale:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> getattr(WIoU_Scale, <span class="hljs-string">'_scaled_loss'</span>)(<span class="hljs-keyword">self</span>), (<span class="hljs-number">1</span><span class="hljs-operator"> - </span>iou) <span class="hljs-operator">*</span> torch.exp(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                        (rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>)), iou  # WIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>abs<span class="hljs-operator">/</span><span class="hljs-number">2301.10051</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou, torch.exp((rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>))  # WIoU v<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif MPDIou:      #  https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">2307.07662</span>.pdf  <span class="hljs-keyword">by</span> AI<span class="hljs-operator">&amp;</span>CV</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                cw<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.pow(cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps, alpha)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">ch</span><span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.pow(<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps, alpha)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                d<span class="hljs-number">12</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                d<span class="hljs-number">22</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>((d<span class="hljs-number">12</span> <span class="hljs-operator">+</span> d<span class="hljs-number">22</span>) <span class="hljs-operator">/</span> (cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>, torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), gamma)  # Focal_DIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>  # DIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        c_<span class="hljs-keyword">area</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">*</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">+</span> eps  # convex <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow((c_<span class="hljs-keyword">area</span><span class="hljs-operator"> - </span>union) <span class="hljs-operator">/</span> c_<span class="hljs-keyword">area</span> <span class="hljs-operator">+</span> eps, alpha), torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                      gamma)  # Focal_GIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">1902.09630</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow((c_<span class="hljs-keyword">area</span><span class="hljs-operator"> - </span>union) <span class="hljs-operator">/</span> c_<span class="hljs-keyword">area</span> <span class="hljs-operator">+</span> eps, alpha)  # GIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">1902.09630</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> iou, torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), gamma)  # Focal_IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> iou  # IoU</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3 id="2.2%20%E4%BF%AE%E6%94%B9ultralytics%2Fyolo%2Futils%2Floss.py"><a name="t3"></a>2.2 修改ultralytics/yolo/utils/loss.py</h3> 
<pre data-index="1"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> .<span class="hljs-property">metrics</span> <span class="hljs-keyword">import</span> bbox_iou,bbox_iou_improve</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>修改class BboxLoss(nn.Module):&nbsp;</p> 
<p><img alt="" height="225" src="https://img-blog.csdnimg.cn/a282be4fa8af4faabe2bb89744e94e75.png" width="1019"></p> 
<p>&nbsp;iou = bbox_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh=False, CIoU=True)</p> 
<p>替换为</p> 
<pre data-index="2"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span> bbox_iou_improve(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, MPDIou<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t4"></a>2.3 修改ultralytics/yolo/utils/tal.py</h3> 
<pre data-index="3">from .metrics import bbox_iou,bbox_iou_improve</pre> 
<p>修改def get_box_metrics(self, pd_scores, pd_bboxes, gt_labels, gt_bboxes, mask_gt):</p> 
<p><img alt="" height="124" src="https://img-blog.csdnimg.cn/fb95ef7d26a3449d8cb5f75b44950d52.png" width="941"></p> 
<p>&nbsp;</p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/131991064&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>