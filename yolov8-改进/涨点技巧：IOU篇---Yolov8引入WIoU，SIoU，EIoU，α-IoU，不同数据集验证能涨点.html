<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-dc4a025e85.css">
                <div id="content_views" class="htmledit_views">
                    <h2><a name="t0"></a>&nbsp;&nbsp;1.IOU介绍</h2> 
<p>IoU其实是Intersection over Union的简称，也叫‘<a href="https://so.csdn.net/so/search?q=%E4%BA%A4%E5%B9%B6%E6%AF%94&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E4%BA%A4%E5%B9%B6%E6%AF%94&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;交并比\&quot;}&quot;}" data-tit="交并比" data-pretit="交并比">交并比</a>’。IoU在目标检测以及语义分割中，都有着至关重要的作用。</p> 
<p>首先，我们先来了解一下IoU的定义：</p> 
<p class="img-center"><img alt="" height="109" src="https://img-blog.csdnimg.cn/a98f15deec9c410bbb0355ecc4ccc716.png" width="274"></p> 
<p>&nbsp;我们可以把IoU的值定为为两个图形面积的交集和并集的比值，如下图所示：</p> 
<p class="img-center"><img alt="" src="https://img-blog.csdnimg.cn/img_convert/984755e1730fa74409a5d4dae0ecc8fc.png"></p> 
<p></p> 
<h3><a name="t1"></a>1.1 Yolov8自带IOU方法&nbsp;GIoU, DIoU, CIoU，默认选择CIoU</h3> 
<pre data-index="0"><code class="hljs language-cobol">def bbox_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, GIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, DIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>):</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h2><a name="t2"></a>2.IOU系列介绍</h2> 
<h3><a name="t3"></a>2.1 WIoU介绍</h3> 
<h2><a name="t4"></a>Wise-IoU: Bounding Box Regression Loss with Dynamic Focusing Mechanism</h2> 
<p>论文：<a href="https://arxiv.org/abs/2301.10051" title="https://arxiv.org/abs/2301.10051">https://arxiv.org/abs/2301.10051</a></p> 
<p>代码：<a href="https://github.com/Instinct323/wiou" title="GitHub - Instinct323/wiou: Wise-IoU: Bounding Box Regression Loss with Dynamic Focusing Mechanism">GitHub - Instinct323/wiou: Wise-IoU: Bounding Box Regression Loss with Dynamic Focusing Mechanism</a>&nbsp;</p> 
<p>&nbsp; &nbsp; &nbsp; &nbsp;由于其聚焦机制是静态的，并未充分挖掘非单调聚焦机制的潜能。基于这个观点，我们提出了动态非单调的聚焦机制，设计了 <strong>Wise-IoU (WIoU)</strong>。动态非单调聚焦机制使用“离群度”替代 IoU 对锚框进行质量评估，并提供了明智的梯度增益分配策略。该策略在降低高质量锚框的竞争力的同时，也减小了低质量示例产生的有害梯度。这使得 WIoU 可以聚焦于普通质量的锚框，并提高检测器的整体性能。将WIoU应用于最先进的单级检测器 YOLOv7 时，在 MS-COCO 数据集上的 AP-75 从 <strong>53.03% 提升到 54.50%</strong></p> 
<p>&nbsp;<img alt="" height="443" src="https://img-blog.csdnimg.cn/9ca4e6e621cf4a53a1075e1654e42ebc.png" width="683"></p> 
<h3><a name="t5"></a>2.2 <a href="https://so.csdn.net/so/search?q=SIOU&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=SIOU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;SIOU\&quot;}&quot;}" data-tit="SIOU" data-pretit="siou">SIOU</a></h3> 
<h4><a name="t6"></a>SIoU Loss: More Powerful Learning for Bounding Box Regression</h4> 
<p>论文：SIoU Loss: More Powerful Learning for Bounding Box Regression</p> 
<p>SIoU损失函数由4个Cost函数组成：</p> 
<ul><li> <p>Angle cost</p> </li><li> <p>Distance cost</p> </li><li> <p>Shape cost</p> </li><li> <p>IoU cost</p> </li></ul> 
<p>&nbsp;性能比较：</p> 
<p><img alt="" height="289" src="https://img-blog.csdnimg.cn/16684e6a0218414c9ad68e3c6bd4c245.png" width="776"></p> 
<p></p> 
<h3><a name="t7"></a>&nbsp;2.3&nbsp; EIOU</h3> 
<p>Focal and Efficient IOU Loss for Accurate Bounding Box Regression</p> 
<p><a href="https://arxiv.org/pdf/2101.08158.pdf" title="论文：https://arxiv.org/pdf/2101.08158.pdf">论文：https://arxiv.org/pdf/2101.08158.pdf</a></p> 
<p>EIOU loss 改进点</p> 
<ol><li>将原始的宽高比例，改为宽高值回归，将红色框的宽度与真实（蓝色）宽度进行损失，红色长度与真实长度进行回归。</li></ol> 
<p>在CIOU的基础上将纵横比拆开，提出了EIOU Loss，并且加入Focal聚焦优质的锚框。</p> 
<p>EIOU的惩罚项是在CIOU的惩罚项基础上将纵横比的影响因子拆开分别计算目标框和锚框的长和宽，该损失函数包含三个部分：重叠损失，中心距离损失，宽高损失，前两部分延续CIOU中的方法，但是宽高损失直接使目标盒与锚盒的宽度和高度之差最小，使得收敛速度更快。</p> 
<p>因此将原来<strong>CIOU loss= IOUloss+中心点损失+长宽比例损失</strong></p> 
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;改为<strong>EIOU loss =IOUloss+中心点损失+宽损失+长损失</strong></p> 
<p><img alt="" height="584" src="https://img-blog.csdnimg.cn/359f9e1587544fcfb739580525757e7a.png" width="699"></p> 
<p><img alt="" height="418" src="https://img-blog.csdnimg.cn/e85f42d02e164b7f9ec02fae007b36c9.png" width="720"></p> 
<h3><a name="t8"></a>2.4&nbsp;Alpha-IoU</h3> 
<p>论文：&nbsp;Alpha-IoU: A Family of Power Intersection over Union Losses for Bounding Box Regression&nbsp;</p> 
<p>论文：<a href="https://arxiv.org/pdf/2110.13675.pdf" title="https://arxiv.org/pdf/2110.13675.pdf">https://arxiv.org/pdf/2110.13675.pdf</a></p> 
<p>代码：<a href="https://github.com/Jacobi93/Alpha-IoU" title="GitHub - Jacobi93/Alpha-IoU: [NeurIPS 2021] Alpha-IoU: A Family of Power Intersection over Union Losses for Bounding Box Regression">GitHub - Jacobi93/Alpha-IoU: [NeurIPS 2021] Alpha-IoU: A Family of Power Intersection over Union Losses for Bounding Box Regression</a>&nbsp;</p> 
<p>文章贡献：</p> 
<p>提出了α-IoU ，用于精确的bbox回归和目标检测，是基于IoU的现有损失的统一幂化；<br> 分析了α-IoU 的一系列性质，包括次序保留、损失/梯度重加权，表明正确选择α(α &gt;1)可以通过自适应地提高high IoU对象的损失和梯度的加权来提高bbox回归精度；<br> 在多个基准<a href="https://so.csdn.net/so/search?q=%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E6%95%B0%E6%8D%AE%E9%9B%86&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;目标检测数据集\&quot;}&quot;}" data-tit="目标检测数据集" data-pretit="目标检测数据集">目标检测数据集</a>和模型上，α- iou损失优于现有的基于iou的损失，并为小数据集和噪声提供更强的鲁棒性。</p> 
<p><img alt="" height="516" src="https://img-blog.csdnimg.cn/c4e683ba718e4854818b30525648c93a.png" width="1048"></p> 
<p></p> 
<h2><a name="t9"></a>3.将WIoU，SIoU，EIoU，α-IoU 引入YoloV8</h2> 
<h3><a name="t10"></a>3.1修改ultralytics/yolo/utils/metrics.py</h3> 
<pre data-index="1" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln hundred" style="width:1285px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-keyword">class</span> WIoU_Scale:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">''</span><span class="hljs-string"><span class="hljs-string">' monotonous: {</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            None: origin v1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            True: monotonic FM v2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">            False: non-monotonic FM v3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        }</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        需要设置scale，scale为True时，WIoU会乘以一个系数，结合monotonous即会对应WIoU的3个版本。</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        momentum: The momentum of running mean'</span><span class="hljs-string">''</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou_mean <span class="hljs-operator">=</span> <span class="hljs-number">1</span>.</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    monotonous <span class="hljs-operator">=</span> <span class="hljs-keyword">False</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    _momentum <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-operator"> - </span><span class="hljs-number">0.5</span> <span class="hljs-operator">**</span> (<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">7000</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    _<span class="hljs-keyword">is</span>_train <span class="hljs-operator">=</span> <span class="hljs-keyword">True</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def __init__(<span class="hljs-keyword">self</span>, iou):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>.iou <span class="hljs-operator">=</span> iou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span>._update(<span class="hljs-keyword">self</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    @classmethod</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _update(cls, <span class="hljs-keyword">self</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> cls._<span class="hljs-keyword">is</span>_train: cls.iou_mean <span class="hljs-operator">=</span> (<span class="hljs-number">1</span><span class="hljs-operator"> - </span>cls._momentum) <span class="hljs-operator">*</span> cls.iou_mean <span class="hljs-operator">+</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                         cls._momentum <span class="hljs-operator">*</span> <span class="hljs-keyword">self</span>.iou.detach().mean().item()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    @classmethod</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    def _scaled_loss(cls, <span class="hljs-keyword">self</span>, gamma<span class="hljs-operator">=</span><span class="hljs-number">1.9</span>, delta<span class="hljs-operator">=</span><span class="hljs-number">3</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> isinstance(<span class="hljs-keyword">self</span>.monotonous, bool):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.monotonous:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.iou.detach() <span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.iou_mean).sqrt()</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                beta <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.iou.detach() <span class="hljs-operator">/</span> <span class="hljs-keyword">self</span>.iou_mean</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                alpha <span class="hljs-operator">=</span> delta <span class="hljs-operator">*</span> torch.pow(gamma, beta<span class="hljs-operator"> - </span>delta)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> beta <span class="hljs-operator">/</span> alpha</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def bbox_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, GIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, DIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, SIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, EIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, WIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, Focal<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">             alpha<span class="hljs-operator">=</span><span class="hljs-number">1</span>, gamma<span class="hljs-operator">=</span><span class="hljs-number">0.5</span>, scale<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    计算bboxes iou</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    GIoU: 为True时计算GIoU v5自带</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    DIoU: 为True时计算DIoU v5自带</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    CIoU: 为True时计算CIoU v5自带，默认使用</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    SIoU: 为True时计算SIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    EIoU: 为True时计算EIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    WIoU: 为True时计算WIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Focal: 为True时，可结合其他的XIoU生成对应的IoU变体，如CIoU = True，Focal = True时为Focal - CIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    alpha: AlphaIoU中的alpha参数，默认为1，为1时则为普通的IoU，如果想采用AlphaIoU，论文alpha默认值为3，此时设置CIoU = True则为AlphaCIoU</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    gamma: Focal_XIoU中的gamma参数，默认为0</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    .5</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    scale: scale为True时，WIoU会乘以一个系数</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    monotonous: 3</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    个输入分别代表WIoU的3个版本，N</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Returns Intersection over Union (IoU) <span class="hljs-keyword">of</span> box<span class="hljs-number">1</span>(<span class="hljs-number">1,4</span>) <span class="hljs-keyword">to</span> box<span class="hljs-number">2</span>(n,<span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Get</span> the coordinates <span class="hljs-keyword">of</span> bounding boxes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> xywh:  # transform <span class="hljs-keyword">from</span> xywh <span class="hljs-keyword">to</span> xyxy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>_, h<span class="hljs-number">1</span>_, w<span class="hljs-number">2</span>_, h<span class="hljs-number">2</span>_ <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">1</span>_, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> h<span class="hljs-number">1</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>_, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> h<span class="hljs-number">2</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:  # x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>).clamp(eps)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, (b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>).clamp(eps)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span><span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> scale:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> WIoU_Scale(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(inter <span class="hljs-operator">/</span> union))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # iou <span class="hljs-operator">=</span> inter <span class="hljs-operator">/</span> union # ori iou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou <span class="hljs-operator">=</span> torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), alpha)  # alpha iou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> GIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU <span class="hljs-keyword">or</span> WIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cw <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)  # convex (smallest enclosing box) width</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)  # convex height</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU <span class="hljs-keyword">or</span> WIoU:  # Distance <span class="hljs-keyword">or</span> Complete IoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>abs<span class="hljs-operator">/</span><span class="hljs-number">1911.08287</span>v<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> (cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">**</span> alpha <span class="hljs-operator">+</span> eps  # convex diagonal squared</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            rho<span class="hljs-number">2</span> <span class="hljs-operator">=</span> (((b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> (</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                        b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span> <span class="hljs-number">4</span>) <span class="hljs-operator">**</span> alpha  # center dist <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> CIoU:  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                v <span class="hljs-operator">=</span> (<span class="hljs-number">4</span> <span class="hljs-operator">/</span> math.pi <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">*</span> (torch.atan(w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> h<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>torch.atan(w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> h<span class="hljs-number">1</span>)).pow(<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">with</span> torch.<span class="hljs-keyword">no</span>_grad():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    alpha_ciou <span class="hljs-operator">=</span> v <span class="hljs-operator">/</span> (v<span class="hljs-operator"> - </span>iou <span class="hljs-operator">+</span> (<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> torch.pow(v <span class="hljs-operator">*</span> alpha_ciou <span class="hljs-operator">+</span> eps, alpha)), torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                                 gamma)  # Focal_CIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> torch.pow(v <span class="hljs-operator">*</span> alpha_ciou <span class="hljs-operator">+</span> eps, alpha))  # CIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif EIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_w<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                cw<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.pow(cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps, alpha)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">ch</span><span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.pow(<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps, alpha)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>), torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                      gamma)  # Focal_EIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>)  # EIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif SIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                # SIoU Loss https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">2205.12740</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_cw <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sigma <span class="hljs-operator">=</span> torch.pow(s_cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">=</span> torch.abs(s_cw) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.abs(s_<span class="hljs-keyword">ch</span>) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                threshold <span class="hljs-operator">=</span> pow(<span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha <span class="hljs-operator">=</span> torch.where(sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">&gt;</span> threshold, sin_alpha_<span class="hljs-number">2</span>, sin_alpha_<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                angle_cost <span class="hljs-operator">=</span> torch.cos(torch.arcsin(sin_alpha) <span class="hljs-operator">*</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>math.pi <span class="hljs-operator">/</span> <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_x <span class="hljs-operator">=</span> (s_cw <span class="hljs-operator">/</span> cw) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_y <span class="hljs-operator">=</span> (s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                gamma <span class="hljs-operator">=</span> angle_cost<span class="hljs-operator"> - </span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                distance_cost <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_x)<span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_w <span class="hljs-operator">=</span> torch.abs(w<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(w<span class="hljs-number">1</span>, w<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_h <span class="hljs-operator">=</span> torch.abs(h<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(h<span class="hljs-number">1</span>, h<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                shape_cost <span class="hljs-operator">=</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_w), <span class="hljs-number">4</span>) <span class="hljs-operator">+</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_h), <span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow(<span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> (distance_cost <span class="hljs-operator">+</span> shape_cost) <span class="hljs-operator">+</span> eps, alpha), torch.pow(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                        inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), gamma)  # Focal_SIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow(<span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> (distance_cost <span class="hljs-operator">+</span> shape_cost) <span class="hljs-operator">+</span> eps, alpha)  # SIou</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif WIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"WIoU do not support Focal."</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                elif scale:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> getattr(WIoU_Scale, <span class="hljs-string">'_scaled_loss'</span>)(<span class="hljs-keyword">self</span>), (<span class="hljs-number">1</span><span class="hljs-operator"> - </span>iou) <span class="hljs-operator">*</span> torch.exp(</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                        (rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>)), iou  # WIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>abs<span class="hljs-operator">/</span><span class="hljs-number">2301.10051</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    <span class="hljs-keyword">return</span> iou, torch.exp((rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>))  # WIoU v<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>, torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), gamma)  # Focal_DIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>  # DIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        c_<span class="hljs-keyword">area</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">*</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">+</span> eps  # convex <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow((c_<span class="hljs-keyword">area</span><span class="hljs-operator"> - </span>union) <span class="hljs-operator">/</span> c_<span class="hljs-keyword">area</span> <span class="hljs-operator">+</span> eps, alpha), torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps),</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                                                                                      gamma)  # Focal_GIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">1902.09630</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> iou<span class="hljs-operator"> - </span>torch.pow((c_<span class="hljs-keyword">area</span><span class="hljs-operator"> - </span>union) <span class="hljs-operator">/</span> c_<span class="hljs-keyword">area</span> <span class="hljs-operator">+</span> eps, alpha)  # GIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">1902.09630</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> Focal:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> iou, torch.pow(inter <span class="hljs-operator">/</span> (union <span class="hljs-operator">+</span> eps), gamma)  # Focal_IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> iou  # IoU</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<h3><a name="t11"></a>3.2 修改ultralytics/yolo/utils/loss.py</h3> 
<p>修改class BboxLoss(nn.Module):中的</p> 
<p><img alt="" height="268" src="https://img-blog.csdnimg.cn/cc09e6de476248ab80bf1ec6d7903514.png" width="971"></p> 
<p></p> 
<p>&nbsp;替换为如下代码：</p> 
<pre data-index="2"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:100%"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        iou <span class="hljs-operator">=</span> bbox_iou_improve(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, WIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">type</span>(iou) <span class="hljs-keyword">is</span> tuple:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> len(iou) <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-number">2</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                loss_iou <span class="hljs-operator">=</span> ((<span class="hljs-number">1.0</span><span class="hljs-operator"> - </span>iou[<span class="hljs-number">0</span>]) <span class="hljs-operator">*</span> iou[<span class="hljs-number">1</span>].detach() <span class="hljs-operator">*</span> weight).<span class="hljs-keyword">sum</span>() <span class="hljs-operator">/</span> target_scores_<span class="hljs-keyword">sum</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                loss_iou <span class="hljs-operator">=</span> (iou[<span class="hljs-number">0</span>] <span class="hljs-operator">*</span> iou[<span class="hljs-number">1</span>] <span class="hljs-operator">*</span> weight).<span class="hljs-keyword">sum</span>() <span class="hljs-operator">/</span> target_scores_<span class="hljs-keyword">sum</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">else</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            loss_iou <span class="hljs-operator">=</span> ((<span class="hljs-number">1.0</span><span class="hljs-operator"> - </span>iou) <span class="hljs-operator">*</span> weight).<span class="hljs-keyword">sum</span>() <span class="hljs-operator">/</span> target_scores_<span class="hljs-keyword">sum</span></div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p>3.3 修改ultralytics/yolo/utils/tal.py</p> 
<p>修改def get_box_metrics(self, pd_scores, pd_bboxes, gt_labels, gt_bboxes, mask_gt):函数</p> 
<p><img alt="" height="350" src="https://img-blog.csdnimg.cn/fe6b3ace5aed4f86a6a1dbf0c3821755.png" width="924"></p> 
<pre data-index="3"><code class="hljs language-cobol">overlaps[mask_gt] <span class="hljs-operator">=</span> bbox_iou(gt_boxes, pd_boxes, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, WIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>).squeeze(-<span class="hljs-number">1</span>).clamp(<span class="hljs-number">0</span>)</code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div><div></div></div>
        </div>