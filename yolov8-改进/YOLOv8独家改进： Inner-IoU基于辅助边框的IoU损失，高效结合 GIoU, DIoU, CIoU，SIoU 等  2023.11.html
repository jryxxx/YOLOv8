<div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-044f2cf1dc.css">
                <div id="content_views" class="htmledit_views">
                    <p>&nbsp;ğŸ’¡ğŸ’¡ğŸ’¡<strong>æœ¬æ–‡ç‹¬å®¶æ”¹è¿›ï¼š<span style="color:#fe2c24;">Inner-IoUå¼•å…¥å°ºåº¦å› å­&nbsp;ratio&nbsp;æ§åˆ¶è¾…åŠ©è¾¹æ¡†çš„å°ºåº¦å¤§å°ç”¨äºè®¡ç®—æŸå¤±ï¼Œå¹¶ä¸ç°æœ‰çš„åŸºäº&nbsp;IoU ï¼ˆ&nbsp;GIoU, DIoU,&nbsp; CIoUï¼ŒSIoU&nbsp;ï¼‰æŸå¤±è¿›è¡Œæœ‰æ•ˆç»“åˆ</span></strong></p> 
<p>æ¨èæŒ‡æ•°ï¼š5é¢—æ˜Ÿ&nbsp; &nbsp; &nbsp; &nbsp; æ–°é¢–æŒ‡æ•°ï¼š5é¢—æ˜Ÿ</p> 
<p>ğŸ’¡ğŸ’¡ğŸ’¡Yolov8é­”æœ¯å¸ˆï¼Œç‹¬å®¶é¦–å‘åˆ›æ–°ï¼ˆåŸåˆ›ï¼‰ï¼Œé€‚ç”¨äºYolov5ã€Yolov7ã€Yolov8ç­‰å„ä¸ªYoloç³»åˆ—ï¼Œä¸“æ æ–‡ç« æä¾›æ¯ä¸€æ­¥æ­¥éª¤å’Œæºç ï¼Œè½»æ¾å¸¦ä½ ä¸Šæ‰‹é­”æ”¹ç½‘ç»œ</p> 
<p>ğŸ’¡ğŸ’¡ğŸ’¡é‡ç‚¹ï¼šé€šè¿‡æœ¬ä¸“æ çš„é˜…è¯»ï¼Œåç»­ä½ ä¹Ÿå¯ä»¥è‡ªå·±é­”æ”¹ç½‘ç»œï¼Œåœ¨ç½‘ç»œä¸åŒä½ç½®ï¼ˆBackboneã€headã€detectã€lossç­‰ï¼‰è¿›è¡Œé­”æ”¹ï¼Œå®ç°åˆ›æ–°ï¼ï¼ï¼</p> 
<p>ä¸“æ ä»‹ç»ï¼š</p> 
<p>https://blog.csdn.net/m0_63774211/category_12289773.html</p> 
<p>âœ¨âœ¨âœ¨åŸåˆ›é­”æ”¹ç½‘ç»œã€å¤ç°å‰æ²¿è®ºæ–‡ï¼Œç»„åˆä¼˜åŒ–åˆ›æ–°</p> 
<p>ğŸš€ğŸš€ğŸš€å°ç›®æ ‡ã€é®æŒ¡ç‰©ã€éš¾æ ·æœ¬æ€§èƒ½æå‡</p> 
<p>ğŸ‰ğŸ‰ğŸ‰æŒç»­æ›´æ–°ä¸­ï¼Œå®šæœŸæ›´æ–°ä¸åŒæ•°æ®é›†æ¶¨ç‚¹æƒ…å†µ<br> &nbsp;</p> 
<h2><a name="t0"></a>1.&nbsp;<strong>Inner-IoUä»‹ç»</strong></h2> 
<p><img alt="" height="191" src="https://img-blog.csdnimg.cn/231da9c76a4d4ee4a72a8c6517e70723.png" width="1032"></p> 
<p>è®ºæ–‡ï¼š<a href="https://arxiv.org/pdf/2311.02877.pdf" title="https://arxiv.org/pdf/2311.02877.pdf">https://arxiv.org/pdf/2311.02877.pdf</a>&nbsp;</p> 
<p></p> 
<p>æ‘˜è¦ï¼šéšç€æ£€æµ‹å™¨çš„è¿…é€Ÿå‘å±•<strong>,&nbsp;</strong>è¾¹æ¡†å›å½’å–å¾—äº†å·¨å¤§çš„è¿›æ­¥ã€‚ç„¶è€Œï¼Œç°æœ‰çš„åŸºäº&nbsp;<strong>IoU&nbsp;</strong>çš„è¾¹æ¡†å›å½’ä»èšç„¦åœ¨é€šè¿‡åŠ å…¥æ–°çš„æŸå¤±é¡¹æ¥åŠ é€Ÿæ”¶æ•›ï¼Œå¿½è§†&nbsp;<strong>IoU&nbsp;</strong>æŸå¤±é¡¹å…¶è‡ªèº«çš„é™åˆ¶ã€‚å°½ç®¡ç†è®ºä¸Š&nbsp;<strong>IoU&nbsp;</strong>æŸå¤±èƒ½å¤Ÿæœ‰æ•ˆæè¿°è¾¹æ¡†å›å½’çŠ¶æ€ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå®ƒæ— æ³•æ ¹æ®ä¸åŒæ£€æµ‹å™¨ä¸æ£€æµ‹ä»»åŠ¡è¿›è¡Œè‡ªæˆ‘è°ƒæ•´ï¼Œä¸å…·æœ‰å¾ˆå¼ºçš„æ³›åŒ–æ€§ã€‚åŸºäºä»¥ä¸Šï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æäº†&nbsp;<strong>BBR&nbsp;</strong>æ¨¡å¼ï¼Œå¾—å‡ºç»“è®ºåœ¨å›å½’è¿‡ç¨‹åŒºåˆ†ä¸åŒå›å½’æ ·æœ¬å¹¶ä¸”ä½¿ç”¨ä¸åŒå°ºåº¦çš„è¾…åŠ©è¾¹æ¡†è®¡ç®—æŸå¤±èƒ½å¤Ÿæœ‰æ•ˆåŠ é€Ÿè¾¹æ¡†å›å½’è¿‡ç¨‹ã€‚å¯¹äºé«˜&nbsp;<strong>IoU&nbsp;</strong>æ ·æœ¬ï¼Œä½¿ç”¨è¾ƒå°çš„è¾…åŠ©è¾¹æ¡†è®¡ç®—æŸå¤±èƒ½å¤ŸåŠ é€Ÿæ”¶æ•›ï¼Œè€Œè¾ƒå¤§è¾…åŠ©è¾¹æ¡†é€‚ç”¨äºä½&nbsp;<strong>IoU&nbsp;</strong>æ ·æœ¬ã€‚æ¥ç€ï¼Œæˆ‘ä»¬æå‡ºäº†&nbsp;<strong>Inner-IoU Loss,&nbsp;</strong>å…¶é€šè¿‡è¾…åŠ©è¾¹æ¡†è®¡ç®—&nbsp;<strong>IoU&nbsp;</strong>æŸå¤±ã€‚é’ˆå¯¹ä¸åŒçš„æ•°æ®é›†ä¸æ£€æµ‹å™¨ï¼Œæˆ‘ä»¬å¼•å…¥å°ºåº¦å› å­&nbsp;<strong>ratio&nbsp;</strong>æ§åˆ¶è¾…åŠ©è¾¹æ¡†çš„å°ºåº¦å¤§å°ç”¨äºè®¡ç®—æŸå¤±ã€‚æœ€åï¼Œå°†&nbsp;<strong>Inner-IoU&nbsp;</strong>é›†æˆè‡³ç°æœ‰çš„åŸºäº&nbsp;<strong>IoU&nbsp;</strong>æŸå¤±å‡½æ•°ä¸­è¿›è¡Œä»¿çœŸå®éªŒä¸å¯¹æ¯”å®éªŒã€‚å®éªŒç»“æœè¡¨æ˜åœ¨ä½¿ç”¨æœ¬æ–‡æ‰€æå‡ºæ–¹æ³•åæ£€æµ‹æ•ˆæœå¾—åˆ°è¿›ä¸€æ­¥æå‡ï¼ŒéªŒè¯äº†æœ¬æ–‡æ–¹æ³•çš„æœ‰æ•ˆæ€§ä»¥åŠæ³›åŒ–èƒ½åŠ›ã€‚</p> 
<p>IoUæŸå¤±å‡½æ•°åœ¨è®¡ç®—æœºè§†è§‰ä»»åŠ¡ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ã€‚åœ¨è¾¹ç•Œæ¡†å›å½’è¿‡ç¨‹ä¸­ï¼Œä¸ä»…å¯ä»¥è¯„ä¼°å›å½’çŠ¶æ€ï¼Œè¿˜å¯ä»¥é€šè¿‡è®¡ç®—å›å½’æŸå¤±æ¥åŠ é€Ÿæ”¶æ•›ã€‚åœ¨è¿™é‡Œï¼Œä½œè€…è®¨è®ºIoUå˜åŒ–ä¸è¾¹ç•Œæ¡†å¤§å°ä¹‹é—´çš„å…³ç³»ï¼Œåˆ†æè¾¹ç•Œæ¡†å›å½’é—®é¢˜çš„æœ¬è´¨ç‰¹å¾ï¼Œå¹¶è§£é‡Šæœ¬æ–‡æå‡ºæ–¹æ³•çš„å¯è¡Œæ€§ã€‚</p> 
<p><img alt="" height="439" src="https://img-blog.csdnimg.cn/2eb72e2ada0f40c0afae3dcaa2250633.png" width="697"></p> 
<p>ä¸ºå¼¥è¡¥ç°æœ‰IoUæŸå¤±å‡½æ•°åœ¨ä¸åŒçš„æ£€æµ‹ä»»åŠ¡ä¸­çš„æ³›åŒ–èƒ½åŠ›è¾ƒå¼±ä¸”æ”¶æ•›é€Ÿåº¦è¾ƒæ…¢çš„ä¸è¶³ï¼Œä½œè€…æå‡ºä½¿ç”¨è¾…åŠ©è¾¹ç•Œæ¡†è®¡ç®—æŸå¤±ä»¥åŠ é€Ÿè¾¹ç•Œæ¡†å›å½’è¿‡ç¨‹ã€‚åœ¨Inner-IoUä¸­ï¼Œä½œè€…å¼•å…¥äº†å°ºåº¦å› å­æ¯”ï¼Œå¯ä»¥æ§åˆ¶è¾…åŠ©è¾¹ç•Œæ¡†çš„å°ºåº¦å¤§å°ã€‚é€šè¿‡ä¸ºä¸åŒæ•°æ®é›†å’Œæ£€æµ‹å™¨ä½¿ç”¨ä¸åŒå°ºåº¦çš„è¾…åŠ©è¾¹ç•Œæ¡†ï¼Œå¯ä»¥å…‹æœç°æœ‰æ–¹æ³•åœ¨æ³›åŒ–èƒ½åŠ›æ–¹é¢çš„å±€é™ã€‚</p> 
<p><img alt="" height="551" src="https://img-blog.csdnimg.cn/0ffdad3a3e05456aa70d7fe5c3f5ea5e.png" width="810"></p> 
<p>&nbsp;<img alt="" height="478" src="https://img-blog.csdnimg.cn/640be176afb54d64aaec196dc9bdaf65.png" width="672"></p> 
<p>&nbsp;å›¾8.a, 8.bå’Œ8.c ä¸º<a href="https://so.csdn.net/so/search?q=CIoU&amp;spm=1001.2101.3001.7020" target="_blank" class="hl hl-1" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=CIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;CIoU\&quot;}&quot;}" data-report-click="{&quot;spm&quot;:&quot;1001.2101.3001.7020&quot;,&quot;dest&quot;:&quot;https://so.csdn.net/so/search?q=CIoU&amp;spm=1001.2101.3001.7020&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;CIoU\&quot;}&quot;}" data-tit="CIoU" data-pretit="ciou">CIoU</a> and Inner-CIoUçš„è®­ç»ƒè¿‡ç¨‹æ›²çº¿å›¾ï¼Œä¸‰å¼ å›¾åˆ†åˆ«å¯¹åº”ratio ä¸º0.7, 0.75, and 0.8ã€‚å›¾8.d, å›¾8.eå’Œ å›¾8.f ä¸ºratio åˆ†åˆ«ä¸º0.7, 0.75, and 0.8æ—¶,SIoU and Inner-SIoUçš„è®­ç»ƒè¿‡ç¨‹æ›²çº¿å›¾ã€‚åœ¨ä»¥ä¸Šå›¾ä¸­ï¼Œæ©™è‰²æ›²çº¿ä»£è¡¨æœ¬æ–‡æ–¹æ³•ï¼Œç°æœ‰æ–¹æ³•ç”¨ç»¿è‰²æ›²çº¿è¡¨ç¤ºã€‚ä¸éš¾çœ‹å‡ºåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­50è‡³150 epochs æœ¬æ–‡æ–¹æ³•ä¼˜äºç°æœ‰çš„æ–¹æ³•ã€‚<br> &nbsp;</p> 
<p>&nbsp;<img alt="" height="685" src="https://img-blog.csdnimg.cn/deed551516d8418eb244e6a017e7e02e.png" width="1150"></p> 
<p>&nbsp;&nbsp;&nbsp;æµ‹è¯•é›†å¯¹æ¯”å®éªŒç»“æœå¦‚è¡¨1æ‰€ç¤ºã€‚å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨æœ¬æ–‡æ–¹æ³•åï¼Œæ£€æµ‹æ•ˆæœæœ‰æ‰€æé«˜ï¼ŒAP50å’ŒmAP50:95æé«˜äº†0.5%ä»¥ä¸Šã€‚å›¾6å’Œå›¾7æ˜¯æ£€æµ‹æ ·æœ¬çš„å¯¹æ¯”å›¾ã€‚<strong>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸ç°æœ‰æ–¹æ³•ç›¸æ¯”ï¼Œæ‰€æå‡ºçš„æ–¹æ³•å®šä½æ›´å‡†ç¡®ï¼Œè¯¯æ£€å’Œæ¼æ£€æ›´å°‘ã€‚</strong>&nbsp;</p> 
<p><img alt="" height="721" src="https://img-blog.csdnimg.cn/cb2a530459f74b6f906eef447045937a.png" width="1200">&nbsp;åŸç†å¯å‚è€ƒä½œè€…åšå®¢ï¼š</p> 
<p><a href="https://blog.csdn.net/qq_45911380/article/details/134320866" title="ä½œè€…å¯¼è¯»ï¼šInner-IoUï¼šåŸºäºè¾…åŠ©è¾¹æ¡†çš„IoUæŸå¤±-CSDNåšå®¢">ä½œè€…å¯¼è¯»ï¼šInner-IoUï¼šåŸºäºè¾…åŠ©è¾¹æ¡†çš„IoUæŸå¤±-CSDNåšå®¢</a></p> 
<h2><a name="t1"></a>2.&nbsp;&nbsp;<strong>Inner-IoUåŠ å…¥YOLOv8</strong></h2> 
<h3><a name="t2"></a>2.1&nbsp;&nbsp;&nbsp;Inner-IoUåŠ å…¥ultralytics/utils/metrics.py</h3> 
<p>&nbsp;bbox_inner_iouç»“åˆå„ä¸ªIOUå®ç°</p> 
<pre data-index="0" class="set-code-show" name="code"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> ultralytics.<span class="hljs-property">utils</span> <span class="hljs-keyword">import</span> <span class="hljs-variable constant_">LOGGER</span>, <span class="hljs-title class_">SimpleClass</span>, <span class="hljs-title class_">TryExcept</span>, plt_settings,ops</code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<pre data-index="1" class="set-code-hide" name="code"><code class="hljs language-cobol"><ol class="hljs-ln" style="width:1111px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def <span class="hljs-keyword">get</span>_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> xywh:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ops.xyxy<span class="hljs-number">2</span>xywh(box<span class="hljs-number">1</span>), ops.xyxy<span class="hljs-number">2</span>xywh(box<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>(h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> (h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>(w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> (w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>(h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> (h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">*</span> ratio <span class="hljs-operator">*</span> ratio <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span> <span class="hljs-operator">*</span> ratio <span class="hljs-operator">*</span> ratio<span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> inter <span class="hljs-operator">/</span> union</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">def bbox_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, GIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, DIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, EIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, SIoU<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, eps<span class="hljs-operator">=</span><span class="hljs-number">1</span>e-<span class="hljs-number">7</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>):</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-string">""</span><span class="hljs-string"><span class="hljs-string">"</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Calculate Intersection over Union (IoU) of box1(1, 4) to box2(n, 4).</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Args:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        box1 (torch.Tensor): A tensor representing a single bounding box with shape (1, 4).</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        box2 (torch.Tensor): A tensor representing n bounding boxes with shape (n, 4).</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        xywh (bool, optional): If True, input boxes are in (x, y, w, h) format. If False, input boxes are in</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">                               (x1, y1, x2, y2) format. Defaults to True.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        GIoU (bool, optional): If True, calculate Generalized IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        DIoU (bool, optional): If True, calculate Distance IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        CIoU (bool, optional): If True, calculate Complete IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        EIoU (bool, optional): If True, calculate Efficient IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        SIoU (bool, optional): If True, calculate Scylla IoU. Defaults to False.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        eps (float, optional): A small value to avoid division by zero. Defaults to 1e-7.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string"></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    Returns:</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">        (torch.Tensor): IoU, GIoU, DIoU, or CIoU values depending on the specified flags.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"><span class="hljs-string">    "</span><span class="hljs-string">""</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # <span class="hljs-keyword">Get</span> the coordinates <span class="hljs-keyword">of</span> bounding boxes</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> xywh:  # transform <span class="hljs-keyword">from</span> xywh <span class="hljs-keyword">to</span> xyxy</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        (x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span>), (x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span>, w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span>) <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>), box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>_, h<span class="hljs-number">1</span>_, w<span class="hljs-number">2</span>_, h<span class="hljs-number">2</span>_ <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">1</span>_, x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">1</span>_, y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> h<span class="hljs-number">1</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>_, x<span class="hljs-number">2</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>_, y<span class="hljs-number">2</span> <span class="hljs-operator">+</span> h<span class="hljs-number">2</span>_</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">else</span>:  # x<span class="hljs-number">1</span>, y<span class="hljs-number">1</span>, x<span class="hljs-number">2</span>, y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">1</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span> <span class="hljs-operator">=</span> box<span class="hljs-number">2</span>.chunk(<span class="hljs-number">4</span>, -<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">1</span>, h<span class="hljs-number">1</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        w<span class="hljs-number">2</span>, h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>, b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    innner_iou <span class="hljs-operator">=</span> <span class="hljs-keyword">get</span>_inner_iou(box<span class="hljs-number">1</span>, box<span class="hljs-number">2</span>, xywh<span class="hljs-operator">=</span>xywh, ratio<span class="hljs-operator">=</span>ratio)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Intersection <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    inter <span class="hljs-operator">=</span> (b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>) <span class="hljs-operator">*</span> \</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            (b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)).clamp_(<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # Union <span class="hljs-keyword">Area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    union <span class="hljs-operator">=</span> w<span class="hljs-number">1</span> <span class="hljs-operator">*</span> h<span class="hljs-number">1</span> <span class="hljs-operator">+</span> w<span class="hljs-number">2</span> <span class="hljs-operator">*</span> h<span class="hljs-number">2</span><span class="hljs-operator"> - </span>inter <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line"> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    # IoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    iou <span class="hljs-operator">=</span> inter <span class="hljs-operator">/</span> union</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> GIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        cw <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)  # convex (smallest enclosing box) width</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>.maximum(b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>.minimum(b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)  # convex height</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">if</span> CIoU <span class="hljs-keyword">or</span> DIoU <span class="hljs-keyword">or</span> EIoU <span class="hljs-keyword">or</span> SIoU:  # Distance <span class="hljs-keyword">or</span> Complete IoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>abs<span class="hljs-operator">/</span><span class="hljs-number">1911.08287</span>v<span class="hljs-number">1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            c<span class="hljs-number">2</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps  # convex diagonal squared</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            rho<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">/</span> <span class="hljs-number">4</span>  # center dist <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">if</span> CIoU:  # https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>github.com<span class="hljs-operator">/</span>Zzh-tju<span class="hljs-operator">/</span>DIoU-SSD-pytorch<span class="hljs-operator">/</span>blob<span class="hljs-operator">/</span>master<span class="hljs-operator">/</span>utils<span class="hljs-operator">/</span>box<span class="hljs-operator">/</span>box_utils.py#L<span class="hljs-number">47</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                v <span class="hljs-operator">=</span> (<span class="hljs-number">4</span> <span class="hljs-operator">/</span> math.pi <span class="hljs-operator">**</span> <span class="hljs-number">2</span>) <span class="hljs-operator">*</span> (torch.atan(w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> h<span class="hljs-number">2</span>)<span class="hljs-operator"> - </span>torch.atan(w<span class="hljs-number">1</span> <span class="hljs-operator">/</span> h<span class="hljs-number">1</span>)).pow(<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">with</span> torch.<span class="hljs-keyword">no</span>_grad():</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                    alpha <span class="hljs-operator">=</span> v <span class="hljs-operator">/</span> (v<span class="hljs-operator"> - </span>iou <span class="hljs-operator">+</span> (<span class="hljs-number">1</span> <span class="hljs-operator">+</span> eps))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> v <span class="hljs-operator">*</span> alpha)  # CIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif EIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_w<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_h<span class="hljs-number">2</span> <span class="hljs-operator">=</span> ((b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span>)<span class="hljs-operator"> - </span>(b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span>)) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                cw<span class="hljs-number">2</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">ch</span><span class="hljs-number">2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>(rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_w<span class="hljs-number">2</span> <span class="hljs-operator">/</span> cw<span class="hljs-number">2</span> <span class="hljs-operator">+</span> rho_h<span class="hljs-number">2</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span><span class="hljs-number">2</span>) # EIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            elif SIoU:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                # SIoU Loss https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">2205.12740</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_cw <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_x<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_x<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_x<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">=</span> (b<span class="hljs-number">2</span>_y<span class="hljs-number">1</span> <span class="hljs-operator">+</span> b<span class="hljs-number">2</span>_y<span class="hljs-number">2</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">1</span><span class="hljs-operator"> - </span>b<span class="hljs-number">1</span>_y<span class="hljs-number">2</span>) <span class="hljs-operator">*</span> <span class="hljs-number">0.5</span> <span class="hljs-operator">+</span> eps</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sigma <span class="hljs-operator">=</span> torch.pow(s_cw <span class="hljs-operator">**</span> <span class="hljs-number">2</span> <span class="hljs-operator">+</span> s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">**</span> <span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">=</span> torch.abs(s_cw) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha_<span class="hljs-number">2</span> <span class="hljs-operator">=</span> torch.abs(s_<span class="hljs-keyword">ch</span>) <span class="hljs-operator">/</span> sigma</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                threshold <span class="hljs-operator">=</span> pow(<span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>) <span class="hljs-operator">/</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                sin_alpha <span class="hljs-operator">=</span> torch.where(sin_alpha_<span class="hljs-number">1</span> <span class="hljs-operator">&gt;</span> threshold, sin_alpha_<span class="hljs-number">2</span>, sin_alpha_<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                angle_cost <span class="hljs-operator">=</span> torch.cos(torch.arcsin(sin_alpha) <span class="hljs-operator">*</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>math.pi <span class="hljs-operator">/</span> <span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_x <span class="hljs-operator">=</span> (s_cw <span class="hljs-operator">/</span> cw) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                rho_y <span class="hljs-operator">=</span> (s_<span class="hljs-keyword">ch</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">ch</span>) <span class="hljs-operator">**</span> <span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                gamma <span class="hljs-operator">=</span> angle_cost<span class="hljs-operator"> - </span><span class="hljs-number">2</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                distance_cost <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_x)<span class="hljs-operator"> - </span>torch.exp(gamma <span class="hljs-operator">*</span> rho_y)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_w <span class="hljs-operator">=</span> torch.abs(w<span class="hljs-number">1</span><span class="hljs-operator"> - </span>w<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(w<span class="hljs-number">1</span>, w<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                omiga_h <span class="hljs-operator">=</span> torch.abs(h<span class="hljs-number">1</span><span class="hljs-operator"> - </span>h<span class="hljs-number">2</span>) <span class="hljs-operator">/</span> torch.max(h<span class="hljs-number">1</span>, h<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                shape_cost <span class="hljs-operator">=</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_w), <span class="hljs-number">4</span>) <span class="hljs-operator">+</span> torch.pow(<span class="hljs-number">1</span><span class="hljs-operator"> - </span>torch.exp(-<span class="hljs-number">1</span> <span class="hljs-operator">*</span> omiga_h), <span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">                <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span><span class="hljs-number">0.5</span> <span class="hljs-operator">*</span> (distance_cost <span class="hljs-operator">+</span> shape_cost) <span class="hljs-operator">+</span> eps # SIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">            <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>rho<span class="hljs-number">2</span> <span class="hljs-operator">/</span> c<span class="hljs-number">2</span>  # DIoU</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        c_<span class="hljs-keyword">area</span> <span class="hljs-operator">=</span> cw <span class="hljs-operator">*</span> <span class="hljs-keyword">ch</span> <span class="hljs-operator">+</span> eps  # convex <span class="hljs-keyword">area</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">        <span class="hljs-keyword">return</span> innner_iou<span class="hljs-operator"> - </span>(c_<span class="hljs-keyword">area</span><span class="hljs-operator"> - </span>union) <span class="hljs-operator">/</span> c_<span class="hljs-keyword">area</span>  # GIoU https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>arxiv.org<span class="hljs-operator">/</span>pdf<span class="hljs-operator">/</span><span class="hljs-number">1902.09630</span>.pdf</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">    <span class="hljs-keyword">return</span> innner_iou  # IoU</div></div></li></ol></code><div class="hide-preCode-box"><span class="hide-preCode-bt" data-report-view="{&quot;spm&quot;:&quot;1001.2101.3001.7365&quot;}"><img class="look-more-preCode contentImg-no-view" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCodeMoreWhite.png" alt="" title=""></span></div><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<h3 style="background-color:transparent;"><a name="t3"></a>2.2&nbsp;ä¿®æ”¹ultralytics/utils/loss.py</h3> 
<p>1ï¼‰bbox_inner_iouè¿›è¡Œå®šä¹‰</p> 
<pre data-index="2" class="set-code-show" name="code"><code class="hljs language-typescript"><span class="hljs-keyword">from</span> .<span class="hljs-property">metrics</span> <span class="hljs-keyword">import</span> bbox_iou, bbox_inner_iou</code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<p>2ï¼‰ä¿®æ”¹class BboxLoss(nn.Module):</p> 
<pre data-index="3" class="set-code-show" name="code"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span> bbox_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>)</code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<p>ä¿®æ”¹ä¸º</p> 
<pre data-index="4" class="set-code-show" name="code"><code class="hljs language-cobol">iou <span class="hljs-operator">=</span> bbox_inner_iou(pred_bboxes[fg_mask], target_bboxes[fg_mask], xywh<span class="hljs-operator">=</span><span class="hljs-keyword">False</span>, CIoU<span class="hljs-operator">=</span><span class="hljs-keyword">True</span>, ratio<span class="hljs-operator">=</span><span class="hljs-number">0.7</span>)</code><div class="hljs-button {2}" data-title="å¤åˆ¶" onclick="hljs.copyCode(event)"></div></pre> 
<p></p>
                </div><div data-report-view="{&quot;mod&quot;:&quot;1585297308_001&quot;,&quot;spm&quot;:&quot;1001.2101.3001.6548&quot;,&quot;dest&quot;:&quot;https://cv2023.blog.csdn.net/article/details/134417670&quot;,&quot;extend1&quot;:&quot;pc&quot;,&quot;ab&quot;:&quot;new&quot;}"><div></div></div>
        </div>